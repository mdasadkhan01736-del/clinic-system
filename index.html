<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseUrl = "https://dqegcpsinhvwtuzzbsoj.supabase.co";
const supabaseKey = "sb_publishable_jZqQyVLD2ZgVwaIPDkftkA_JyyEa7U3";

const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

console.log("Supabase Connected");
</script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asad Kit BD ‚Äì Clinic & Pathology Management System v17</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asad Kit BD ‚Äî Clinic & Pathology Management System v17</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
:root{
  /* Light palette */
  --bg:#f0f4f8;--bg2:#e4eaf2;--surface:#ffffff;--surface2:#f7f9fc;
  --navy:#1a2e45;--navy2:#243b55;
  --teal:#0096c7;--teal2:#0077a8;--tealdk:#005f85;--teal-light:#e0f3fb;
  --green:#059669;--green-light:#d1fae5;
  --amber:#b45309;--amber-light:#fef3c7;
  --red:#dc2626;--red-light:#fee2e2;
  --purple:#6d28d9;--purple-light:#ede9fe;
  --text:#1e293b;--text2:#475569;--text3:#94a3b8;
  --border:#d1dce8;--border2:#e2e8f0;
  --card:#ffffff;
  --font:'Inter',sans-serif;--mono:'JetBrains Mono',monospace;
  /* shadows */
  --shadow:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.05);
  --shadow-md:0 4px 12px rgba(0,0,0,.08),0 2px 6px rgba(0,0,0,.04);
  --shadow-lg:0 10px 30px rgba(0,0,0,.1),0 4px 12px rgba(0,0,0,.05);
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;font-family:var(--font);background:var(--bg);color:var(--text);overflow:hidden;}
#topbar{height:38px;background:var(--navy);display:flex;align-items:center;padding:0 16px;user-select:none;border-bottom:1px solid rgba(255,255,255,.1);position:relative;z-index:200;flex-shrink:0;}
.tb-dots{display:flex;gap:6px;}
.dot{width:12px;height:12px;border-radius:50%;cursor:pointer;transition:filter .15s;}
.dot:hover{filter:brightness(1.3);}
.dot-r{background:#ff5f56;}.dot-y{background:#febc2e;}.dot-g{background:#28c840;}
#tbTitle{position:absolute;left:50%;transform:translateX(-50%);font-size:11px;color:rgba(255,255,255,.6);letter-spacing:.12em;text-transform:uppercase;font-weight:600;}
.tb-right{margin-left:auto;display:flex;align-items:center;gap:14px;font-size:11px;color:rgba(255,255,255,.6);}
.tb-user{color:#7dd3fc;font-weight:600;}
#tbClock{font-family:var(--mono);font-size:10px;}
.gs-indicator{font-size:9px;padding:2px 7px;border-radius:20px;font-weight:700;letter-spacing:.05em;}
.gs-connected{background:rgba(5,150,105,.15);color:var(--green);border:1px solid rgba(5,150,105,.3);}
.gs-local{background:rgba(180,83,9,.1);color:var(--amber);border:1px solid rgba(180,83,9,.2);}
.screen{display:none;flex-direction:column;height:calc(100vh - 38px);}
.screen.active{display:flex;}
/* LOGIN */
#screen-login{background:linear-gradient(135deg,#e0f2fe 0%,#f0f4f8 50%,#e8edf5 100%);align-items:center;justify-content:center;}
.login-wrap{width:400px;}
.login-logo{text-align:center;margin-bottom:32px;}
.login-logo .logo-icon{font-size:44px;margin-bottom:8px;}
.login-logo .brand{font-size:26px;font-weight:700;color:var(--navy);letter-spacing:-.02em;}
.login-logo .tagline{font-size:10px;color:var(--text2);letter-spacing:.18em;text-transform:uppercase;margin-top:4px;}
.login-box{background:#fff;border:1px solid var(--border);border-radius:14px;padding:38px;box-shadow:var(--shadow-lg);}
.fg{margin-bottom:16px;}
.fg label{display:block;font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.12em;margin-bottom:6px;font-weight:600;}
.fg input{width:100%;padding:10px 13px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font);font-size:14px;outline:none;transition:.2s;}
.fg input:focus{border-color:var(--teal);background:#fff;box-shadow:0 0 0 3px rgba(0,150,199,.1);}
.btn-login{width:100%;padding:12px;background:var(--navy);border:none;border-radius:8px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:.2s;margin-top:4px;font-family:var(--font);}
.btn-login:hover{background:var(--navy2);}
#loginErr{min-height:18px;font-size:12px;color:var(--red);text-align:center;margin-top:10px;}
.login-hint{display:none;}
/* SUPER ADMIN */
#screen-superadmin{flex-direction:column;background:var(--bg);}
.sa-bar{background:var(--navy);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.sa-bar h1{font-size:15px;color:#fff;font-weight:700;}
.sa-bar p{font-size:10px;color:rgba(255,255,255,.5);margin-top:2px;text-transform:uppercase;letter-spacing:.1em;}
.sa-body{flex:1;overflow:auto;padding:24px;display:flex;flex-direction:column;gap:20px;}
.stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.stat-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;box-shadow:var(--shadow);}
.stat-card .snum{font-size:28px;font-weight:700;font-family:var(--mono);}
.stat-card .slbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-top:3px;}
.panel{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);}
.panel-hdr{padding:12px 18px;border-bottom:1px solid var(--border2);display:flex;align-items:center;justify-content:space-between;background:var(--surface2);}
.panel-hdr h2{font-size:13px;font-weight:600;color:var(--text);}
/* DASHBOARD ‚Äî TILE ACCESS SCREEN */
#screen-dashboard{background:linear-gradient(135deg,#dbeafe 0%,#f0f4f8 60%,#e0f2fe 100%);align-items:center;justify-content:center;flex-direction:column;position:relative;}
.dash-brand{text-align:center;margin-bottom:40px;}
.dash-brand .dname{font-size:20px;font-weight:700;color:var(--navy);}
.dash-brand .dclinic{font-size:11px;color:var(--teal);text-transform:uppercase;letter-spacing:.15em;margin-top:5px;}
.app-grid{display:grid;grid-template-columns:repeat(4,160px);gap:14px;}
.app-card{background:#fff;border:1.5px solid var(--border);border-radius:16px;padding:28px 14px;text-align:center;cursor:pointer;transition:all .18s;box-shadow:var(--shadow);}
.app-card:hover{transform:translateY(-5px);border-color:var(--teal);box-shadow:0 12px 32px rgba(0,150,199,.18);}
.app-icon{font-size:36px;margin-bottom:10px;}
.app-label{font-size:13px;font-weight:700;color:var(--navy);}
.app-card.locked{opacity:.35;cursor:not-allowed;}
.app-card.locked:hover{transform:none;border-color:var(--border);box-shadow:var(--shadow);}
.dash-logout{position:absolute;bottom:20px;right:24px;}
/* WORKSPACE */
#screen-workspace{flex-direction:column;background:var(--bg);}
.ws-nav{background:#fff;border-bottom:2px solid var(--border);display:flex;align-items:stretch;height:42px;flex-shrink:0;box-shadow:0 1px 4px rgba(0,0,0,.06);}
.ws-tab{padding:0 18px;font-size:12px;cursor:pointer;color:var(--text2);border-bottom:2px solid transparent;margin-bottom:-2px;white-space:nowrap;display:flex;align-items:center;transition:.15s;font-weight:500;}
.ws-tab:hover{color:var(--teal);background:var(--teal-light);}
.ws-tab.active{color:var(--teal);border-bottom-color:var(--teal);font-weight:600;}
.ws-spacer{flex:1;}
.ws-back{margin:6px 8px 6px 0;padding:5px 14px;background:transparent;border:1px solid var(--border);border-radius:6px;color:var(--text2);font-size:11px;cursor:pointer;font-family:var(--font);transition:.15s;}
.ws-back:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-light);}
.ws-body{flex:1;overflow:auto;padding:20px;}
/* FORMS */
.f2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.f3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
.f4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
.fi label{display:block;font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.1em;margin-bottom:5px;font-weight:600;}
.fi input,.fi select,.fi textarea{width:100%;padding:8px 12px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--font);font-size:13px;outline:none;transition:.15s;}
.fi input:focus,.fi select:focus,.fi textarea:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(0,150,199,.1);}
.fi input[readonly]{background:var(--bg2);opacity:.7;cursor:default;}
.fi select option{background:#fff;color:var(--text);}
/* PANELS */
.box{background:#fff;border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:var(--shadow);}
.box-title{font-size:10px;color:var(--teal2);text-transform:uppercase;letter-spacing:.14em;font-weight:700;margin-bottom:16px;}
/* TABLES */
.tbl-wrap{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);}
table{width:100%;border-collapse:collapse;font-size:12px;}
thead tr{background:var(--surface2);}
th{padding:10px 14px;text-align:left;font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.1em;font-weight:700;border-bottom:1px solid var(--border2);}
td{padding:10px 14px;border-top:1px solid var(--border2);color:var(--text);}
tbody tr:hover td{background:var(--teal-light);}
.badge{display:inline-block;padding:2px 9px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.04em;}
.b-active{background:var(--green-light);color:var(--green);}
.b-due{background:var(--red-light);color:var(--red);}
.b-paid{background:var(--teal-light);color:var(--teal2);}
.b-warn{background:var(--amber-light);color:var(--amber);}
.b-purple{background:var(--purple-light);color:var(--purple);}
.b-info{background:#cff4fc;color:#055160;}
/* BUTTONS */
.btn{padding:8px 18px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;border:none;transition:.18s;font-family:var(--font);display:inline-flex;align-items:center;gap:6px;}
.btn-t{background:var(--navy);color:#fff;}.btn-t:hover{background:var(--navy2);}
.btn-o{background:#fff;border:1.5px solid var(--border);color:var(--text2);}.btn-o:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-light);}
.btn-r{background:var(--red-light);color:var(--red);border:1px solid rgba(220,38,38,.2);}.btn-r:hover{background:#fecaca;}
.btn-g{background:var(--green-light);color:var(--green);border:1px solid rgba(5,150,105,.2);}.btn-g:hover{background:#a7f3d0;}
.btn-sm{padding:5px 12px;font-size:11px;}
.bar{display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap;}
.bar input,.bar select{padding:7px 12px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:12px;outline:none;font-family:var(--font);transition:.15s;}
.bar input:focus{border-color:var(--teal);}
.bar input[type=date]{color:var(--text);}
/* BILLING SPECIFIC */
.inv-layout{display:grid;grid-template-columns:1fr 320px;gap:16px;}
.test-scroll{max-height:200px;overflow-y:auto;}
.test-row{display:flex;justify-content:space-between;align-items:center;padding:7px 11px;border-radius:7px;cursor:pointer;font-size:12px;transition:.12s;border:1px solid transparent;}
.test-row:hover{background:var(--teal-light);border-color:rgba(0,150,199,.2);}
.test-row .tp{color:var(--teal2);font-family:var(--mono);font-size:11px;white-space:nowrap;font-weight:600;}
.sel-item{display:flex;justify-content:space-between;align-items:center;padding:6px 11px;background:var(--teal-light);border:1px solid rgba(0,150,199,.2);border-radius:7px;margin-bottom:4px;font-size:12px;}
.sel-item .trm{color:var(--red);cursor:pointer;font-size:16px;line-height:1;padding:0 4px;}
.tot-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;font-size:13px;border-bottom:1px solid var(--border2);}
.tot-row:last-child{border-bottom:none;}
.tot-grand{font-weight:700;color:var(--navy);font-size:14px;padding-top:8px;}
.tot-due{color:var(--red);font-weight:700;}
.tinput{width:90px;padding:5px 9px;background:#fff;border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;text-align:right;outline:none;transition:.15s;}
.tinput:focus{border-color:var(--teal);}
.action-row{display:flex;gap:10px;margin-top:14px;}
/* ACCOUNTS */
.acc-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:18px;}
.acc-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px;box-shadow:var(--shadow);}
.acc-card .an{font-size:24px;font-weight:700;font-family:var(--mono);}
.acc-card .al{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-top:3px;}
/* MODALS */
.overlay{display:none;position:fixed;inset:38px 0 0 0;background:rgba(15,23,42,.45);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(2px);}
.overlay.open{display:flex;}
.modal{background:#fff;border:1px solid var(--border);border-radius:14px;padding:28px;min-width:480px;box-shadow:var(--shadow-lg);max-height:90vh;overflow-y:auto;}
.modal h3{font-size:15px;color:var(--navy);margin-bottom:18px;font-weight:700;}
.modal-foot{display:flex;gap:10px;justify-content:flex-end;margin-top:18px;}
/* NOTIFICATION */
.notif{position:fixed;top:50px;right:20px;z-index:999;background:var(--navy);border:none;border-radius:10px;padding:12px 18px;font-size:12px;color:#fff;box-shadow:var(--shadow-lg);transform:translateX(130%);transition:.28s ease;max-width:340px;}
.notif.show{transform:translateX(0);}
.notif.err{background:var(--red);}
/* SCROLLBAR */
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg2);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--text3);}
/* REVIEW MODAL */
.review-modal{background:#fff;border:1px solid var(--border);border-radius:14px;padding:0;min-width:700px;max-width:760px;box-shadow:var(--shadow-lg);overflow:hidden;}
.review-header{background:var(--surface2);padding:14px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.review-body{padding:20px;max-height:80vh;overflow-y:auto;}
/* GS CONFIG */
.gs-form{display:grid;gap:10px;}
/* DOCTORS MODULE */
.doc-card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;box-shadow:var(--shadow);}
.doc-info{flex:1;}
.doc-name{font-size:13px;font-weight:600;color:var(--navy);}
.doc-dept{font-size:11px;color:var(--text2);margin-top:2px;}
/* OPD / INDOOR extra styles */
.mod-tile-grid{display:grid;grid-template-columns:repeat(3,180px);gap:14px;}
.mod-tile{background:#fff;border:1.5px solid var(--border);border-radius:14px;padding:28px 14px;text-align:center;cursor:pointer;transition:all .18s;box-shadow:var(--shadow);}
.mod-tile:hover{transform:translateY(-5px);border-color:var(--teal);box-shadow:0 16px 40px rgba(0,150,199,.15);}
.mod-tile .ti{font-size:36px;margin-bottom:10px;}
.mod-tile .tl{font-size:13px;font-weight:700;color:var(--navy);letter-spacing:.01em;}
.side-item{padding:8px 12px;border-radius:7px;cursor:pointer;font-size:12px;transition:.12s;border:1px solid transparent;margin-bottom:4px;color:var(--text2);}
.side-item:hover{background:var(--teal-light);border-color:rgba(0,150,199,.2);color:var(--teal);}
.side-item.active{background:var(--teal-light);border-color:rgba(0,150,199,.3);color:var(--teal2);}
.ref-barcode{font-family:var(--mono);font-size:18px;letter-spacing:.15em;color:var(--teal2);text-align:center;margin:8px 0;}
.pw-section{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-top:14px;}
.pw-section .box-title{margin-bottom:12px;}
.ipd-tabs{display:flex;gap:0;margin-bottom:14px;background:var(--bg2);border-radius:9px;overflow:hidden;border:1px solid var(--border);}
.ipd-tab{flex:1;padding:9px 14px;font-size:12px;font-weight:600;cursor:pointer;text-align:center;transition:.14s;color:var(--text2);}
.ipd-tab.active{background:var(--teal2);color:#fff;}
/* PRINT-SPECIFIC STYLES ‚Äî v13 fixed */
@media print {
  @page { size: 8.5in 11in; margin: 0.5in; }
  body { margin: 0; padding: 0; background: #fff !important; color: #000 !important; overflow: visible !important; }
  .print-page { width: 7.5in; margin: 0; padding: 0; box-sizing: border-box; font-family: 'Times New Roman', Times, serif; font-size: 11pt; color: #000; background: #fff; page-break-after: avoid; }
  .no-print { display: none !important; }
  .print-page * { page-break-inside: avoid; }
}
</style>
</head>
<body>

<div id="topbar">
  <div class="tb-dots">
    <div class="dot dot-r" onclick="handleClose()"></div>
    <div class="dot dot-y"></div>
    <div class="dot dot-g"></div>
  </div>
  <div id="tbTitle">Asad Kit BD v17</div>
  <div class="tb-right">
    <span id="gsStatus" class="gs-indicator gs-local">üíæ Local</span>
    <span class="tb-user" id="tbUser">‚Äî</span>
    <span id="tbClock"></span>
  </div>
</div>

<div class="notif" id="notif"></div>

<!-- ‚ïê‚ïê‚ïê SCREEN: LOGIN ‚ïê‚ïê‚ïê -->
<div class="screen active" id="screen-login">
  <div class="login-wrap">
    <div class="login-logo">
      <div class="logo-icon">‚öï</div>
      <div class="brand">Asad Kit BD</div>
      <div class="tagline">Multi-Clinic Management System v17</div>
    </div>
    <div class="login-box">
      <div class="fg"><label>Username</label><input id="lu" autocomplete="off" placeholder="Enter your username" onkeydown="if(event.key==='Enter'){document.getElementById('lp').focus();}"></div>
      <div class="fg"><label>Password</label><input id="lp" type="password" placeholder="Enter your password" onkeydown="if(event.key==='Enter')login()"></div>
      <button class="btn-login" onclick="login()">Sign In</button>
      <div id="loginErr"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SCREEN: SUPER ADMIN ‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-superadmin">
  <div class="sa-bar">
    <div><h1>‚öï Asad Kit BD ‚Äî System Owner Console</h1><p>All clinics ¬∑ Owner level ¬∑ Full control</p></div>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-sm" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;" onclick="openModal('m-gs-config')">‚öô Google Sheets</button>
      <button class="btn btn-sm" style="background:#fff;color:var(--navy);" onclick="openModal('m-clinic')">+ Register Clinic</button>
      <button class="btn btn-sm" style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;" onclick="doLogout()">Logout</button>
    </div>
  </div>
  <div class="sa-body">
    <div class="stat-row">
      <div class="stat-card"><div class="snum" id="sa_nc" style="color:var(--teal)">‚Äî</div><div class="slbl">Clinics</div></div>
      <div class="stat-card"><div class="snum" id="sa_nu" style="color:var(--purple)">‚Äî</div><div class="slbl">Total Users</div></div>
      <div class="stat-card"><div class="snum" id="sa_ni" style="color:var(--green)">‚Äî</div><div class="slbl">Total Receipts</div></div>
      <div class="stat-card"><div class="snum" id="sa_nc2" style="color:var(--amber)">‚Äî</div><div class="slbl">Total Collection (‡ß≥)</div></div>
    </div>
    <!-- Scrollable Clinic List -->
    <div class="panel">
      <div class="panel-hdr">
        <h2>Registered Clinics ‚Äî Activity Overview</h2>
        <span style="font-size:10px;color:var(--text2)">Multi-tenant ¬∑ Isolated data ¬∑ Scrollable</span>
      </div>
      <div style="max-height:calc(100vh - 260px);overflow-y:auto;">
      <table>
        <thead><tr><th>#</th><th>Clinic</th><th>Admin</th><th>Invoices</th><th>Collected (‡ß≥)</th><th>Due</th><th>Users</th><th>Registered</th><th>Expiry</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="sa_tbody"><tr><td colspan="10" style="color:var(--gray);text-align:center;padding:20px;">Loading‚Ä¶</td></tr></tbody>
      </table>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SCREEN: DASHBOARD ‚Äî TILE ACCESS SCREEN ‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-dashboard">
  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;">
    <div class="dash-brand">
      <div class="dname" id="dashName">Asad Kit BD</div>
      <div class="dclinic" id="dashClinic">Clinic & Pathology Management System</div>
    </div>
    <div id="appGrid" style="display:grid;grid-template-columns:repeat(4,160px);gap:14px;"></div>
  </div>
  <div style="padding:16px;text-align:center;font-size:10px;color:var(--text3);">Asad Kit BD v17 &nbsp;¬∑&nbsp; Clinic &amp; Pathology Management System</div>
</div>

<!-- ‚ïê‚ïê‚ïê SCREEN: WORKSPACE ‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-workspace">
  <div class="ws-nav" id="wsNav"></div>
  <div class="ws-body" id="wsBody"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- PRINT PREVIEW -->
<div class="overlay" id="m-print">
  <div class="modal" style="min-width:600px;max-width:720px;padding:0;overflow:hidden;">
    <div style="background:rgba(0,180,216,.08);padding:14px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:13px;font-weight:600;color:var(--teal)">üñ® Invoice Preview (8√ó12 inch)</span>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-o btn-sm" onclick="closeModal('m-print')">‚úï Close</button>
        <button class="btn btn-t btn-sm" onclick="doPrint()">üñ® Print Now</button>
      </div>
    </div>
    <div style="padding:20px;max-height:78vh;overflow-y:auto;">
      <div id="m-print-body" style="background:#fff;color:#000;padding:20px;border-radius:6px;font-family:'Times New Roman',Times,serif;"></div>
    </div>
  </div>
</div>

<!-- REVIEW INVOICE -->
<div class="overlay" id="m-review">
  <div class="review-modal">
    <div class="review-header">
      <span style="font-size:13px;font-weight:600;color:var(--teal)">üëÅ Invoice Review ‚Äî Read Only</span>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-t btn-sm" id="review-print-btn" onclick="printCurrentReview()">üñ® Print</button>
        <button class="btn btn-o btn-sm" onclick="closeModal('m-review')">‚úï Close</button>
      </div>
    </div>
    <div class="review-body" id="m-review-body"></div>
  </div>
</div>

<!-- DUE COLLECTION -->
<div class="overlay" id="m-due">
  <div class="modal" style="min-width:500px;">
    <h3>üí∞ Collect Due Payment</h3>
    <div id="m-due-info" style="margin-bottom:14px;font-size:13px;background:rgba(255,255,255,.04);border-radius:7px;padding:12px;"></div>
    <!-- FULL original bill shown in due collection -->
    <div id="m-due-bill" style="margin-bottom:14px;max-height:200px;overflow-y:auto;"></div>
    <div class="fi" style="margin-bottom:16px;"><label>Collect Amount (‡ß≥)</label><input type="number" id="m-due-amt" placeholder="Enter amount"></div>
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-due')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="submitDue()">Confirm &amp; Collect</button>
    </div>
  </div>
</div>

<!-- REGISTER CLINIC -->
<div class="overlay" id="m-clinic">
  <div class="modal" style="min-width:520px;">
    <h3>üè• Register New Clinic</h3>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Clinic Name *</label><input id="nc_name" placeholder="e.g. City Diagnostic Center"></div>
      <div class="fi"><label>Invoice Header</label><input id="nc_hdr" placeholder="Full name for invoice header"></div>
    </div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Address</label><input id="nc_addr" placeholder="Full address"></div>
      <div class="fi"><label>Phone</label><input id="nc_phone" placeholder="01X00-000000"></div>
    </div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Admin Username *</label><input id="nc_admin" autocomplete="off" placeholder="e.g. admin_dhaka"></div>
      <div class="fi"><label>Admin Password *</label><input type="password" id="nc_pass" autocomplete="new-password" placeholder="Min 8 characters"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-clinic')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="registerClinic()">Register &amp; Auto-Setup</button>
    </div>
  </div>
</div>

<!-- EDIT PATIENT (v17) -->
<div class="overlay" id="m-edit-patient">
  <div class="modal" style="min-width:520px;">
    <h3>‚úèÔ∏è Edit Patient Information</h3>
    <div style="background:rgba(0,150,199,.06);border:1px solid rgba(0,150,199,.15);border-radius:7px;padding:8px 12px;margin-bottom:14px;font-size:12px;color:var(--teal2);">
      ‚ÑπÔ∏è Editing updates the patient record and all linked invoices. Invoice numbers and IDs are preserved (audit-safe).
    </div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Patient Name *</label><input id="ep_name" placeholder="Full name"></div>
      <div class="fi"><label>Phone</label><input id="ep_phone" placeholder="01X00-000000"></div>
    </div>
    <div class="f4" style="margin-bottom:12px;">
      <div class="fi"><label>Age</label><input id="ep_age" placeholder="e.g. 30 Y"></div>
      <div class="fi"><label>Gender</label><select id="ep_gender"><option value="">‚Äî</option><option>Male</option><option>Female</option><option>Other</option></select></div>
      <div class="fi"><label>Doctor</label><input id="ep_doctor" placeholder="Dr. Name"></div>
      <div class="fi"><label>Reference</label><input id="ep_reference" placeholder="Reference"></div>
    </div>
    <input type="hidden" id="ep_inv_id">
    <input type="hidden" id="ep_inv_table">
    <input type="hidden" id="ep_pat_id">
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-edit-patient')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="savePatientEdit()">üíæ Save Changes</button>
    </div>
  </div>
</div>

<!-- RECHARGE CLINIC (v17 Super Admin) -->
<div class="overlay" id="m-recharge">
  <div class="modal" style="min-width:460px;">
    <h3>üí≥ Recharge Clinic Subscription</h3>
    <div id="recharge_info" style="background:rgba(109,40,217,.06);border:1px solid rgba(109,40,217,.2);border-radius:7px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:var(--text);"></div>
    <div class="fi" style="margin-bottom:12px;"><label>New Expiry Date *</label><input type="date" id="recharge_expiry"></div>
    <div class="fi" style="margin-bottom:14px;"><label>Note (optional)</label><input id="recharge_note" placeholder="e.g. Annual renewal"></div>
    <input type="hidden" id="recharge_cid">
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-recharge')">Cancel</button>
      <button class="btn btn-t btn-sm" style="background:var(--purple);" onclick="doRecharge()">üí≥ Confirm Recharge</button>
    </div>
  </div>
</div>

<!-- ADD/EDIT DOCTOR MODAL -->
<div class="overlay" id="m-edit-doctor">
  <div class="modal" style="min-width:500px;">
    <h3 id="doc-modal-title">üë®‚Äç‚öïÔ∏è Add Doctor</h3>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Full Name *</label><input id="doc_name" placeholder="Dr. Full Name"></div>
      <div class="fi"><label>Degree *</label><input id="doc_degree" placeholder="e.g. MBBS, FCPS"></div>
    </div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Department *</label><input id="doc_dept" placeholder="e.g. Medicine, Gynecology"></div>
      <div class="fi"><label>Phone</label><input id="doc_phone" placeholder="01X00-000000"></div>
    </div>
    <div class="fi" style="margin-bottom:12px;"><label>Registration No</label><input id="doc_reg" placeholder="Medical council registration"></div>
    <input type="hidden" id="doc_id">
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-edit-doctor')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="saveDoctor()">üíæ Save Doctor</button>
    </div>
  </div>
</div>

<!-- EDIT TEST -->
<div class="overlay" id="m-edit-test">
  <div class="modal" style="min-width:560px;">
    <h3>‚úèÔ∏è Edit Test</h3>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Test Name *</label><input id="et_name"></div>
      <div class="fi"><label>Category *</label><input id="et_cat" list="et-cat-list"><datalist id="et-cat-list"></datalist></div>
    </div>
    <div class="f4" style="margin-bottom:12px;">
      <div class="fi"><label>Method</label><input id="et_method"></div>
      <div class="fi"><label>Sample Type</label><input id="et_sample"></div>
      <div class="fi"><label>Unit</label><input id="et_unit"></div>
      <div class="fi"><label>Price (‡ß≥)</label><input id="et_price" type="number" min="0"></div>
    </div>
    <div class="fi" style="margin-bottom:12px;"><label>Reference Range *</label><input id="et_ref"></div>
    <div class="fi" style="margin-bottom:16px;"><label>Status</label>
      <select id="et_status"><option value="active">Active</option><option value="inactive">Inactive</option></select>
    </div>
    <input type="hidden" id="et_id">
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-edit-test')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="saveEditTest()">üíæ Save Changes</button>
    </div>
  </div>
</div>

<!-- EDIT CATEGORY -->
<div class="overlay" id="m-edit-cat">
  <div class="modal" style="min-width:400px;">
    <h3>‚úèÔ∏è Edit Category</h3>
    <div class="fi" style="margin-bottom:16px;"><label>Category Name *</label><input id="ec_name"></div>
    <input type="hidden" id="ec_id">
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-edit-cat')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="saveEditCat()">üíæ Save</button>
    </div>
  </div>
</div>

<!-- ADD CATEGORY -->
<div class="overlay" id="m-add-cat">
  <div class="modal" style="min-width:400px;">
    <h3>‚ûï Add New Category</h3>
    <div class="fi" style="margin-bottom:16px;"><label>Category Name *</label><input id="ac_name" placeholder="e.g. Biochemistry"></div>
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-add-cat')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="saveAddCat()">üíæ Save Category</button>
    </div>
  </div>
</div>

<!-- ID SEARCH -->
<div class="overlay" id="m-id-search">
  <div class="modal" style="min-width:560px;">
    <h3>üîç Search by Invoice / Receipt ID</h3>
    <div style="display:flex;gap:10px;margin-bottom:10px;">
      <div class="fi" style="flex:1;margin-bottom:0;">
        <label>Invoice ID or Receipt ID</label>
        <input id="ids_q" placeholder="e.g. 2026-1 or RC-2026-1" onkeydown="if(event.key==='Enter')doIdSearch()"
          style="font-family:var(--mono);letter-spacing:.05em;">
      </div>
      <div style="align-self:flex-end;"><button class="btn btn-t" onclick="doIdSearch()">Search</button></div>
    </div>
    <div id="ids_result" style="min-height:40px;"></div>
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-id-search')">Close</button>
    </div>
  </div>
</div>

<!-- GOOGLE SHEETS CONFIG -->
<div class="overlay" id="m-gs-config">
  <div class="modal" style="min-width:560px;">
    <h3>‚öô Google Sheets Integration</h3>
    <div style="background:rgba(255,209,102,.08);border:1px solid rgba(255,209,102,.2);border-radius:7px;padding:12px;margin-bottom:16px;font-size:12px;color:var(--amber);">
      ‚ö† Google Sheets requires a deployed Google Apps Script Web App. Enter the Web App URL below.
    </div>
    <div class="gs-form">
      <div class="fi"><label>Apps Script Web App URL *</label>
        <input id="gs_url" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
      </div>
      <div class="fi"><label>Google Sheets ID (for reference)</label>
        <input id="gs_sheet_id" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms">
      </div>
    </div>
    <div id="gs_status_msg" style="margin-top:10px;font-size:12px;"></div>
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-gs-config')">Cancel</button>
      <button class="btn btn-o btn-sm" onclick="testGSConnection()">Test Connection</button>
      <button class="btn btn-t btn-sm" onclick="saveGSConfig()">üíæ Save Config</button>
    </div>
  </div>
</div>

<!-- DAILY EXPORT -->
<div class="overlay" id="m-daily-export">
  <div class="modal" style="min-width:480px;">
    <h3>üì§ Daily Export / Closing</h3>
    <div class="fi" style="margin-bottom:16px;"><label>Export Date</label>
      <input type="date" id="exp_date">
    </div>
    <div style="font-size:12px;color:var(--text2);margin-bottom:14px;">
      This will export all invoices, receipts, and collections for the selected date.
    </div>
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-daily-export')">Cancel</button>
      <button class="btn btn-o btn-sm" onclick="exportToGSheet()">üìä Export to Google Sheet</button>
      <button class="btn btn-t btn-sm" onclick="exportToExcel()">‚¨á Download Excel</button>
    </div>
  </div>
</div>

<!-- DUE COLLECTION RECEIPT PREVIEW -->
<div class="overlay" id="m-due-receipt">
  <div class="modal" style="min-width:600px;max-width:720px;padding:0;overflow:hidden;">
    <div style="background:rgba(6,214,160,.08);padding:14px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:13px;font-weight:600;color:var(--green)">‚úì Due Collection Receipt</span>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-o btn-sm" onclick="closeModal('m-due-receipt')">‚úï Close</button>
        <button class="btn btn-t btn-sm" onclick="printDueReceipt()">üñ® Print</button>
      </div>
    </div>
    <div style="padding:20px;max-height:78vh;overflow-y:auto;">
      <div id="m-due-receipt-body" style="background:#fff;color:#000;padding:20px;border-radius:6px;font-family:'Times New Roman',Times,serif;"></div>
    </div>
  </div>
</div>

<!-- CLINIC VIEW (SA) -->
<div class="overlay" id="m-clinic-view">
  <div class="modal" style="min-width:820px;max-width:920px;padding:0;overflow:hidden;">
    <div style="background:rgba(0,180,216,.08);padding:14px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:13px;font-weight:600;color:var(--teal)" id="cv-title">Clinic Details</span>
      <button class="btn btn-o btn-sm" onclick="closeModal('m-clinic-view')">‚úï Close</button>
    </div>
    <div style="padding:20px;max-height:80vh;overflow-y:auto;" id="m-clinic-view-body"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SCREEN: OPD MODULE ‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-opd" style="flex-direction:column;background:var(--bg);">
  <div class="ws-nav" id="opdNav"></div>
  <div class="ws-body" id="opdBody"></div>
</div>

<!-- ‚ïê‚ïê‚ïê SCREEN: INDOOR MODULE ‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-indoor" style="flex-direction:column;background:var(--bg);">
  <div class="ws-nav" id="indoorNav"></div>
  <div class="ws-body" id="indoorBody"></div>
</div>

<!-- CHANGE PASSWORD MODAL -->
<div class="overlay" id="m-change-pw">
  <div class="modal" style="min-width:420px;">
    <h3>üîë Change Password</h3>
    <div class="fi" style="margin-bottom:12px;"><label>Current Password *</label><input type="password" id="cpw_old" placeholder="Enter current password"></div>
    <div class="fi" style="margin-bottom:12px;"><label>New Password *</label><input type="password" id="cpw_new" placeholder="Minimum 6 characters"></div>
    <div class="fi" style="margin-bottom:12px;"><label>Confirm New Password *</label><input type="password" id="cpw_confirm" placeholder="Repeat new password"></div>
    <div id="cpw_err" style="min-height:16px;font-size:12px;color:var(--red);margin-bottom:10px;"></div>
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-change-pw')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="doChangePassword()">üíæ Change Password</button>
    </div>
  </div>
</div>

<!-- RESET USER PASSWORD MODAL (Admin) -->
<div class="overlay" id="m-reset-pw">
  <div class="modal" style="min-width:420px;">
    <h3>üîì Reset User Password</h3>
    <div id="rpw_user_info" style="padding:10px;background:rgba(255,209,102,.08);border-radius:6px;font-size:12px;color:var(--amber);margin-bottom:14px;"></div>
    <div class="fi" style="margin-bottom:12px;"><label>New Password *</label><input type="password" id="rpw_new" placeholder="Minimum 6 characters"></div>
    <div class="fi" style="margin-bottom:12px;"><label>Confirm Password *</label><input type="password" id="rpw_confirm" placeholder="Repeat new password"></div>
    <input type="hidden" id="rpw_uid">
    <div id="rpw_err" style="min-height:16px;font-size:12px;color:var(--red);margin-bottom:10px;"></div>
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-reset-pw')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="doAdminResetPw()">üîì Reset Password</button>
    </div>
  </div>
</div>

<!-- MACHINE NAME MODAL -->
<div class="overlay" id="m-machine">
  <div class="modal" style="min-width:460px;">
    <h3 id="machine-modal-title">‚öô Add Machine</h3>
    <div class="fi" style="margin-bottom:12px;"><label>Machine Name *</label><input id="mach_name" placeholder="e.g. Sysmex XN-1000"></div>
    <div class="fi" style="margin-bottom:12px;"><label>Model / Make</label><input id="mach_model" placeholder="e.g. Hematology Analyzer"></div>
    <div class="fi" style="margin-bottom:12px;"><label>Manufacturer</label><input id="mach_mfr" placeholder="e.g. Sysmex"></div>
    <input type="hidden" id="mach_id">
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-machine')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="saveMachine()">üíæ Save Machine</button>
    </div>
  </div>
</div>

<!-- OPD REFERENCE MODAL -->
<div class="overlay" id="m-opd-ref">
  <div class="modal" style="min-width:540px;">
    <h3 id="opd-ref-modal-title">‚ûï Add Reference</h3>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Name *</label><input id="oref_name" placeholder="Reference name"></div>
      <div class="fi"><label>Code *</label><input id="oref_code" placeholder="Short code"></div>
    </div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Title / Designation</label><input id="oref_title" placeholder="e.g. Dr., Mr."></div>
      <div class="fi"><label>Contact</label><input id="oref_contact" placeholder="Phone number"></div>
    </div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Email</label><input id="oref_email" placeholder="email@example.com"></div>
      <div class="fi"><label>Commission (%)</label><input id="oref_commission" type="number" min="0" max="100" placeholder="0"></div>
    </div>
    <div class="fi" style="margin-bottom:12px;"><label>Address</label><input id="oref_addr" placeholder="Address"></div>
    <div class="fi" style="margin-bottom:12px;"><label>Description</label><textarea id="oref_desc" rows="2" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--font);font-size:13px;outline:none;resize:vertical;"></textarea></div>
    <input type="hidden" id="oref_id">
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-opd-ref')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="saveOpdRef()">üíæ Save Reference</button>
    </div>
  </div>
</div>

<!-- OPD DOCTOR MODAL -->
<div class="overlay" id="m-opd-doc">
  <div class="modal" style="min-width:540px;">
    <h3 id="opd-doc-modal-title">üë®‚Äç‚öïÔ∏è Add Doctor (OPD)</h3>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Name *</label><input id="odoc_name" placeholder="Full Name"></div>
      <div class="fi"><label>Degree *</label><input id="odoc_degree" placeholder="e.g. MBBS, FCPS"></div>
    </div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Contact</label><input id="odoc_contact" placeholder="Phone"></div>
      <div class="fi"><label>Department / Specialty</label><input id="odoc_dept" placeholder="e.g. Medicine"></div>
    </div>
    <div class="fi" style="margin-bottom:12px;"><label>Address</label><input id="odoc_addr" placeholder="Address"></div>
    <!-- Hidden code field for backend use -->
    <input type="hidden" id="odoc_code">
    <input type="hidden" id="odoc_title">
    <input type="hidden" id="odoc_email">
    <input type="hidden" id="odoc_desc">
    <input type="hidden" id="odoc_id">
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-opd-doc')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="saveOpdDoc()">üíæ Save Doctor</button>
    </div>
  </div>
</div>

<!-- IPD ADMISSION MODAL -->
<div class="overlay" id="m-ipd-admit">
  <div class="modal" style="min-width:580px;">
    <h3>üè• IPD Patient Admission</h3>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Patient Name *</label><input id="ia_name" placeholder="Full patient name"></div>
      <div class="fi"><label>Phone *</label><input id="ia_phone" placeholder="01X00-000000"></div>
    </div>
    <div class="f4" style="margin-bottom:12px;">
      <div class="fi"><label>Age</label>
        <div style="display:flex;gap:5px;align-items:center;">
          <input id="ia_age_y" type="number" min="0" placeholder="Yr" style="width:55px;padding:8px 6px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;outline:none;" oninput="updateIPDAgeVal()">
          <span style="font-size:12px;color:var(--text2);">Y</span>
          <input id="ia_age_m" type="number" min="0" max="11" placeholder="Mo" style="width:55px;padding:8px 6px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;outline:none;" oninput="updateIPDAgeVal()">
          <span style="font-size:12px;color:var(--text2);">M</span>
          <input type="hidden" id="ia_age" value="">
        </div>
      </div>
      <div class="fi"><label>Gender</label><select id="ia_gender"><option>Male</option><option>Female</option><option>Other</option></select></div>
      <div class="fi"><label>Blood Group</label><select id="ia_blood"><option>‚Äî</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option></select></div>
      <div class="fi"><label>Admission Date</label><input type="date" id="ia_date"></div>
    </div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Ward / Room</label><input id="ia_ward" placeholder="e.g. Cabin-101"></div>
      <div class="fi"><label>Attending Doctor</label><input id="ia_doctor" placeholder="Doctor name"></div>
    </div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Diagnosis</label><input id="ia_diag" placeholder="Primary diagnosis"></div>
      <div class="fi"><label>Ref. Doctor</label><input id="ia_refdoc" placeholder="Referring doctor"></div>
    </div>
    <div class="fi" style="margin-bottom:12px;"><label>Address</label><input id="ia_addr" placeholder="Patient address"></div>
    <div class="fi" style="margin-bottom:16px;"><label>Notes</label><textarea id="ia_notes" rows="2" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--font);font-size:13px;outline:none;resize:vertical;"></textarea></div>
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-ipd-admit')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="saveIPDAdmit()">üè• Admit Patient</button>
    </div>
  </div>
</div>

<!-- IPD DEPOSIT MODAL -->
<div class="overlay" id="m-ipd-deposit">
  <div class="modal" style="min-width:460px;">
    <h3>üí∞ IPD Deposit Entry</h3>
    <div class="fi" style="margin-bottom:12px;"><label>Patient ID / Admission No</label><input id="ipd_dep_pid" placeholder="e.g. IPD-2026-0001" oninput="loadIPDPatient()"></div>
    <div id="ipd_dep_info" style="padding:10px;background:rgba(0,180,216,.06);border-radius:6px;font-size:12px;margin-bottom:12px;color:var(--text2);"></div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Deposit Amount (‡ß≥) *</label><input type="number" id="ipd_dep_amt" placeholder="0.00" min="0"></div>
      <div class="fi"><label>Date</label><input type="date" id="ipd_dep_date"></div>
    </div>
    <div class="fi" style="margin-bottom:12px;"><label>Payment Method</label><select id="ipd_dep_method"><option>Cash</option><option>bKash</option><option>Nagad</option><option>Card</option><option>Bank Transfer</option></select></div>
    <div class="fi" style="margin-bottom:16px;"><label>Note</label><input id="ipd_dep_note" placeholder="Optional note"></div>
    <div class="modal-foot">
      <button class="btn btn-o btn-sm" onclick="closeModal('m-ipd-deposit')">Cancel</button>
      <button class="btn btn-t btn-sm" onclick="saveIPDDeposit()">üíæ Save Deposit</button>
    </div>
  </div>
</div>

<script>
'use strict';
// ============================================================
//  ASAD KIT BD v13 ‚Äî PRODUCTION ENGINE
//  Fixed: Invoice display, lab data, print sizing, doctor display,
//         due collection, search reliability, OPD form, ID search
// ============================================================

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATABASE LAYER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB = {
  _key: k => 'akbd_' + k,
  _load(k){ try{ return JSON.parse(localStorage.getItem(this._key(k))||'null'); }catch(e){ return null; }},
  _save(k,v){ try{ localStorage.setItem(this._key(k), JSON.stringify(v)); return true; }catch(e){ console.error('[DB] Save',k,e); return false; }},
  get(col){ return this._load(col)||[]; },
  getBy(col,field,val){ return this.get(col).filter(r=>r[field]===val); },
  findOne(col,pred){ return this.get(col).find(pred)||null; },
  insert(col,record){
    const rows=this.get(col); rows.push(record);
    if(!this._save(col,rows)) throw new Error('DB write failed: '+col);
    GS.sync('insert',col,record);
    return record;
  },
  update(col,pred,changes){
    const rows=this.get(col); let found=false;
    const updated=rows.map(r=>{if(pred(r)){found=true;return{...r,...changes};}return r;});
    if(!found) throw new Error('Record not found in: '+col);
    if(!this._save(col,updated)) throw new Error('DB write failed on update: '+col);
    GS.sync('update',col,changes);
    return true;
  },
  delete(col,pred){
    const rows=this.get(col);
    this._save(col,rows.filter(r=>!pred(r)));
    return true;
  },
  seed(col,data){ if(!this._load(col)){ this._save(col,data); }},
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GOOGLE SHEETS LAYER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GS = {
  _url: ()=> localStorage.getItem('akbd_gs_url')||'',
  async sync(action, col, data){
    const url = this._url();
    if(!url) return;
    try {
      await fetch(url, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action, collection: col, data, timestamp: new Date().toISOString() }) });
    } catch(e){ console.warn('[GS] Sync failed:', e.message); }
  },
  async testConnection(){
    const url = this._url();
    if(!url) return { ok: false, msg: 'No URL configured.' };
    try {
      const r = await fetch(url + '?action=ping', { mode:'cors', signal: AbortSignal.timeout(8000) });
      const txt = await r.text();
      return { ok: txt.includes('pong') || r.ok, msg: txt };
    } catch(e){
      return { ok: true, msg: 'Connection attempted (CORS limited ‚Äî assumed OK).' };
    }
  },
  async exportDaily(cid, date){
    const url = this._url();
    const invs = DB.getBy('invoices','cid',cid).filter(i=>i.date===date);
    const dueLogs = DB.get('due_log').filter(d=>{
      const inv=DB.findOne('invoices',i=>i.id===d.invId);
      return inv?.cid===cid && d.date===date;
    });
    if(!url) return { ok: false, msg: 'Google Sheets not configured.' };
    try {
      await fetch(url, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'daily_export', clinic_id:cid, date, invoices:invs, due_logs:dueLogs }) });
      return { ok: true, msg: `Exported ${invs.length} invoices for ${date}.` };
    } catch(e){ return { ok: false, msg: 'Export failed: '+e.message }; }
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ID GENERATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const uid = () => 'id_'+Date.now()+'_'+Math.random().toString(36).slice(2,7);

// ‚îÄ‚îÄ‚îÄ Invoice Number Utilities (v16) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Format : YYYY-Serial  (e.g. 2026-1 ¬∑ 2026-2 ¬∑ 2026-3)
//  Rules  : ‚Ä¢ Serial resets to 1 every new year
//           ‚Ä¢ No zero-padding (NOT 2026-0001)
//           ‚Ä¢ No prefixes (PATH- / OPD- are stripped on creation and search)
//           ‚Ä¢ One shared counter per clinic across ALL invoice tables
//           ‚Ä¢ Strict duplicate guard
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Strip legacy prefixes/padding so every invoice number is plain YYYY-N
const normalizeInvNo = (no) => {
  if(!no) return no;
  const s = String(no).trim();
  // Strip PATH- / OPD- prefix
  const stripped = s.replace(/^(?:PATH|OPD)-/i, '');
  // Strip zero-padding: 2026-0003 ‚Üí 2026-3
  const m = stripped.match(/^(\d{4})-0*(\d+)$/);
  return m ? `${m[1]}-${parseInt(m[2],10)}` : stripped;
};

// Extract the integer serial from a YYYY-N number
const parseInvSerial = (no) => {
  const norm = normalizeInvNo(no);
  const yr = new Date().getFullYear();
  const m = String(norm||'').match(/^(\d{4})-(\d+)$/);
  if(!m) return 0;
  return parseInt(m[1],10) === yr ? parseInt(m[2],10) : 0;
};

// Core: next invoice number ‚Äî unified across all tables for this clinic + year
const nextInvNo = (cid) => {
  const yr = new Date().getFullYear();
  const yrPfx = `${yr}-`;
  // Collect used serials from ALL invoice tables for this clinic
  const allNos = new Set();
  ['invoices','opd_invoices','pathology_invoices'].forEach(tbl => {
    DB.get(tbl)
      .filter(i => (i.cid===cid||!cid) && !i.void)
      .forEach(i => {
        const n = normalizeInvNo(i.no);
        if(n && String(n).startsWith(yrPfx)) allNos.add(n);
      });
  });
  // Find max serial
  let max = 0;
  allNos.forEach(n => {
    const s = parseInt(n.slice(yrPfx.length), 10);
    if(!isNaN(s) && s > max) max = s;
  });
  // Increment until no collision
  let next = max + 1;
  while(allNos.has(`${yrPfx}${next}`)) next++;
  return `${yrPfx}${next}`;
};

// Aliases ‚Äî all modules now share the same counter
const nextPathInvNo = nextInvNo;
const nextOpdInvNo  = nextInvNo;

// Receipt numbers: RC-YYYY-N (separate series from invoices)
const nextRcNo = (cid) => {
  const yr = new Date().getFullYear();
  const prefix = `RC-${yr}-`;
  const logs = DB.get('due_log').filter(d => (d.rcNo||'').startsWith(prefix));
  let max = 0;
  logs.forEach(d => {
    const m = String(d.rcNo||'').match(/RC-\d{4}-(\d+)$/);
    if(m) { const n = parseInt(m[1],10); if(n>max) max=n; }
  });
  let next = max + 1;
  const allRcNos = new Set(logs.map(d=>String(d.rcNo||'')));
  while(allRcNos.has(`${prefix}${next}`)) next++;
  return `${prefix}${next}`;
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PASSWORD HASHING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function hashPassword(plain){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(plain));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function verifyPassword(plain, hash){
  return (await hashPassword(plain)) === hash;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SEED DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async function seedDefaults(){
  DB.seed('clinics',[
    {id:'CLINIC_001', name:'Asad Kit BD Clinic', address:'Clinic Address, Bangladesh', phone:'01700-000001', email:'info@asadkitbd.com', header:'ASAD KIT BD CLINIC', logo:'', reg:'2026-01-01', clinic_status:'ON', recharge_expiry_date:'2027-12-31'},
    {id:'c2', name:'Chittagong Health Lab', address:'45 Port Road, Chittagong', phone:'01800-000002', email:'info@ctglab.com', header:'CHITTAGONG HEALTH LAB', logo:'', reg:'2025-03-15', clinic_status:'ON', recharge_expiry_date:'2027-12-31'},
  ]);

  if(!DB._load('users')){
    const users = [
      {id:'u1', u:'clinicadmin_001', p:'Admin@Clinic#123', name:'Clinic Admin', role:'admin', cid:'CLINIC_001', status:'active'},
      {id:'u2', u:'reception_001',   p:'Recv@123',         name:'Reception',   role:'reception', cid:'CLINIC_001', status:'active'},
      {id:'u3', u:'lab_001',         p:'Lab@123',          name:'Lab Staff',   role:'lab', cid:'CLINIC_001', status:'active'},
      {id:'u4', u:'accounts_001',    p:'Acc@123',          name:'Accounts',    role:'accounts', cid:'CLINIC_001', status:'active'},
    ];
    for(const u of users) u.p = await hashPassword(u.p);
    DB._save('users', users);
  }

  DB.seed('test_categories',[
    {id:'cat1', cid:'CLINIC_001', name:'Hematology'},
    {id:'cat2', cid:'CLINIC_001', name:'Biochemistry'},
    {id:'cat3', cid:'CLINIC_001', name:'Microbiology'},
    {id:'cat4', cid:'CLINIC_001', name:'Serology'},
    {id:'cat5', cid:'CLINIC_001', name:'Radiology'},
  ]);

  DB.seed('tests',[
    {id:'t1',  cid:'CLINIC_001', cat:'Hematology',   name:'CBC (TC-DC-HB%-ESR)(Conventional)', method:'Manual',       sample:'EDTA',  unit:'',       ref:'See Report',           price:400, status:'active'},
    {id:'t2',  cid:'CLINIC_001', cat:'Hematology',   name:'Hb%',                               method:'Sahli',        sample:'EDTA',  unit:'g/dL',   ref:'M:13-17 F:12-16',      price:150, status:'active'},
    {id:'t3',  cid:'CLINIC_001', cat:'Hematology',   name:'ESR',                               method:'Westergren',   sample:'EDTA',  unit:'mm/hr',  ref:'M:0-15 F:0-20',        price:150, status:'active'},
    {id:'t4',  cid:'CLINIC_001', cat:'Hematology',   name:'Blood Group (Rh factor)',            method:'Slide',        sample:'EDTA',  unit:'',       ref:'ABO+Rh',               price:150, status:'active'},
    {id:'t5',  cid:'CLINIC_001', cat:'Hematology',   name:'EDTA-Tub + ESR-Tub',                method:'Conventional', sample:'EDTA',  unit:'',       ref:'‚Äî',                    price:50,  status:'active'},
    {id:'t6',  cid:'CLINIC_001', cat:'Biochemistry', name:'RBS with CUS',                      method:'Enzymatic',    sample:'Serum', unit:'mmol/L', ref:'<7.8',                 price:150, status:'active'},
    {id:'t7',  cid:'CLINIC_001', cat:'Biochemistry', name:'FBS with CUS',                      method:'Enzymatic',    sample:'Serum', unit:'mmol/L', ref:'4.0-5.9',              price:150, status:'active'},
    {id:'t8',  cid:'CLINIC_001', cat:'Biochemistry', name:'HbA1c',                             method:'HPLC',         sample:'EDTA',  unit:'%',      ref:'<5.7',                 price:800, status:'active'},
    {id:'t9',  cid:'CLINIC_001', cat:'Biochemistry', name:'S.Creatinine',                      method:'Jaffe',        sample:'Serum', unit:'mg/dL',  ref:'M:0.7-1.2 F:0.5-1.0', price:500, status:'active'},
    {id:'t10', cid:'CLINIC_001', cat:'Biochemistry', name:'SGPT (ALT)',                        method:'IFCC',         sample:'Serum', unit:'U/L',    ref:'7-56',                 price:300, status:'active'},
    {id:'t11', cid:'CLINIC_001', cat:'Biochemistry', name:'Lipid Profile',                     method:'Enzymatic',    sample:'Serum', unit:'',       ref:'See Report',           price:700, status:'active'},
    {id:'t12', cid:'CLINIC_001', cat:'Microbiology', name:'Urine R/E',                         method:'Manual',       sample:'MSU',   unit:'',       ref:'See Report',           price:200, status:'active'},
    {id:'t13', cid:'CLINIC_001', cat:'Microbiology', name:'Stool R/E',                         method:'Manual',       sample:'Stool', unit:'',       ref:'See Report',           price:150, status:'active'},
    {id:'t14', cid:'CLINIC_001', cat:'Serology',     name:'ICT for HBsAg',                     method:'ICT',          sample:'Serum', unit:'',       ref:'Non-Reactive',         price:300, status:'active'},
    {id:'t15', cid:'CLINIC_001', cat:'Serology',     name:'Anti-HCV',                          method:'ELISA',        sample:'Serum', unit:'',       ref:'Non-Reactive',         price:600, status:'active'},
    {id:'t16', cid:'CLINIC_001', cat:'Serology',     name:'CRP (Quantitative)',                method:'Turbidimetry', sample:'Serum', unit:'mg/L',   ref:'<6',                   price:500, status:'active'},
    {id:'t17', cid:'CLINIC_001', cat:'Radiology',    name:'USG of Whole Abdomen',              method:'Ultrasound',   sample:'N/A',   unit:'',       ref:'See Report',           price:1200, status:'active'},
    {id:'t18', cid:'CLINIC_001', cat:'Radiology',    name:'USG Color Doppler PP',              method:'Doppler',      sample:'N/A',   unit:'',       ref:'See Report',           price:1200, status:'active'},
  ]);

  DB.seed('invoices',[
    {id:'i1', no:'2026-1', date:'2026-02-01', cid:'CLINIC_001', patient:'Most. Sumaiya Akhter', phone:'01711-111111', age:'16 Y', gender:'Female', doctor:'Helpstar', type:'General Patient', tests:['t1','t6','t4','t12','t18','t5','t9','t14'], subtotal:3150, discount:0, paid:0, due:3150, status:'due', by:'reception_001', byName:'Reception', createdAt:'2026-02-01T09:00:00.000Z'},
    {id:'i2', no:'2026-2', date:'2026-02-05', cid:'CLINIC_001', patient:'Md. Rahman Islam', phone:'01811-222222', age:'45 Y', gender:'Male', doctor:'Dr. Aminul Islam, MBBS, FCPS', type:'General Patient', tests:['t8','t9'], subtotal:1300, discount:100, paid:700, due:500, status:'due', by:'reception_001', byName:'Reception', createdAt:'2026-02-05T10:30:00.000Z'},
    {id:'i3', no:'2026-3', date:'2026-02-10', cid:'CLINIC_001', patient:'Fatima Begum', phone:'01912-333333', age:'32 Y', gender:'Female', doctor:'', type:'General Patient', tests:['t6','t12','t14'], subtotal:650, discount:0, paid:650, due:0, status:'paid', by:'reception_001', byName:'Reception', createdAt:'2026-02-10T11:00:00.000Z'},
  ]);

  DB.seed('patients',[
    {id:'P-001', name:'Most. Sumaiya Akhter', phone:'01711-111111', age:'16', gender:'Female', blood:'B+', cid:'CLINIC_001', reg:'2026-02-01'},
    {id:'P-002', name:'Md. Rahman Islam',     phone:'01811-222222', age:'45', gender:'Male',   blood:'O+', cid:'CLINIC_001', reg:'2026-02-05'},
    {id:'P-003', name:'Fatima Begum',         phone:'01912-333333', age:'32', gender:'Female', blood:'A+', cid:'CLINIC_001', reg:'2026-02-10'},
  ]);

  DB.seed('due_log',[
    {id:'dl1', invId:'i2', rcNo:'RC-2026-1', amount:200, date:'2026-02-12', by:'reception_001', byName:'Reception', receivedBy:'reception_001', receivedByName:'Reception', invoiceNo:'2026-2', prevDue:700, remainDue:500, note:'Partial payment', type:'LAB', createdAt:'2026-02-12T14:00:00.000Z'}
  ]);

  DB.seed('authorized_persons',[
    {id:'ap1', cid:'CLINIC_001', name:'Dr. Aminul Islam', designation:'MBBS, FCPS (Medicine)', phone:'01711-999001', reg:'2026-01-01'},
    {id:'ap2', cid:'CLINIC_001', name:'Dr. Nasrin Akter', designation:'MBBS, MD (Gynae)',      phone:'01811-999002', reg:'2026-01-01'},
  ]);

  DB.seed('doctors',[
    {id:'doc1', cid:'CLINIC_001', name:'Dr. Aminul Islam', degree:'MBBS, FCPS', dept:'Medicine', phone:'01711-999001', reg:'BD-001'},
    {id:'doc2', cid:'CLINIC_001', name:'Dr. Nasrin Akter', degree:'MBBS, MD', dept:'Gynecology', phone:'01811-999002', reg:'BD-002'},
  ]);

  // Load GS config
  const gsUrl = localStorage.getItem('akbd_gs_url');
  if(gsUrl){ updateGSStatus(true); document.getElementById('gs_url').value = gsUrl; }
})();

// Super Admin credentials (hard-coded, no signup)
const SA_CRED = {u:'superadmin', p:'SA@AsadKitBD#2026', role:'superadmin', name:'System Owner'};

// Accessors
const getClinic  = id  => DB.findOne('clinics',c=>c.id===id);
const myInvs     = ()  => DB.getBy('invoices','cid',S?.cid);
const myPats     = ()  => DB.getBy('patients','cid',S?.cid);
const myTests    = ()  => DB.getBy('tests','cid',S?.cid).filter(t=>t.status!=='inactive');
const myAllTests = ()  => DB.getBy('tests','cid',S?.cid);
const myCats     = ()  => DB.getBy('test_categories','cid',S?.cid);
const myAuthorized=()  => DB.getBy('authorized_persons','cid',S?.cid);
const myDoctors  = ()  => DB.getBy('doctors','cid',S?.cid);
const allClinics = ()  => DB.get('clinics');
const allUsers   = ()  => DB.get('users');
const getTestById= id  => DB.findOne('tests',t=>t.id===id);

// Session
let S = null;

// Restore session
(function restoreSession(){
  try{
    const saved = sessionStorage.getItem('akbd_session');
    if(!saved) return;
    const parsed = JSON.parse(saved);
    if(parsed.role==='superadmin'){
      S=parsed;
      document.getElementById('tbUser').textContent='System Owner';
      document.getElementById('tbTitle').textContent='Owner Console';
      renderSA(); showScreen('superadmin');
    } else {
      const cu=DB.findOne('users',x=>x.u===parsed.u&&x.role===parsed.role);
      if(!cu) return sessionStorage.removeItem('akbd_session');
      const clinic=getClinic(cu.cid);
      if(!clinic) return sessionStorage.removeItem('akbd_session');
      S=parsed;
      document.getElementById('tbUser').textContent=cu.name;
      document.getElementById('tbTitle').textContent=clinic.name;
      document.getElementById('dashClinic').textContent=clinic.name;
      document.getElementById('dashName').textContent=cu.name;
      buildGrid();
      routeByRole(cu.role);
    }
  }catch(e){ sessionStorage.removeItem('akbd_session'); }
})();

// Clock
setInterval(()=>{
  document.getElementById('tbClock').textContent=new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
},1000);

// Permissions
const PERMS = {
  superadmin:['billing','patients','pathology','reports','accounts','settings','export','opd','indoor'],
  admin:['billing','patients','pathology','reports','accounts','settings','export','opd','indoor'],
  reception:['billing','patients','pathology','reports','accounts','opd','indoor'],
  lab:['pathology'],
  accounts:['accounts','reports'],
  opd:['opd','patients','reports'],
  indoor:['indoor','patients','reports'],
};
const can = m => PERMS[S?.role]?.includes(m)||false;
const canPrice = () => ['admin','superadmin','lab'].includes(S?.role);
const canDeleteTest = () => ['admin','superadmin'].includes(S?.role);
const canEditTest = () => ['admin','superadmin','lab'].includes(S?.role);
const canDeleteInv  = () => S?.role==='superadmin';
const canManagePersonnel = () => ['admin','superadmin'].includes(S?.role);

// Screens
const showScreen = id => {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+id)?.classList.add('active');
};

function handleClose(){
  const a=document.querySelector('.screen.active')?.id;
  if(a==='screen-workspace') goToDash();
  else doLogout();
}
function goToDash(){
  // If SA was in a clinic, go back to SA console
  if(S?.role==='superadmin'&&S?._saMode){
    S={...S,cid:undefined,cliName:undefined,_saMode:false};
    sessionStorage.setItem('akbd_session',JSON.stringify(S));
    renderSA(); showScreen('superadmin');
    return;
  }
  document.getElementById('tbTitle').textContent=S?.cliName||'Asad Kit BD';
  showScreen('dashboard');
}
function doLogout(){
  S=null;
  sessionStorage.removeItem('akbd_session');
  ['lu','lp'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('loginErr').textContent='';
  document.getElementById('tbUser').textContent='‚Äî';
  document.getElementById('tbTitle').textContent='Asad Kit BD';
  showScreen('login');
}

function routeByRole(role){
  // Single-module roles go directly to their module
  if(role==='lab'){ openWS('pathology'); return; }
  if(role==='accounts'){ openWS('accounts'); return; }
  if(role==='opd'){ openOPD(); return; }
  if(role==='indoor'){ openIndoor(); return; }
  // Admin, reception ‚Üí dashboard tile screen
  showScreen('dashboard');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function login(){
  const u=document.getElementById('lu').value.trim();
  const p=document.getElementById('lp').value;
  const err=document.getElementById('loginErr');
  const btn=document.querySelector('.btn-login');
  err.textContent='';
  if(!u||!p){err.textContent='Username and password are required.';return;}
  btn.textContent='Signing in‚Ä¶'; btn.disabled=true;
  const timeout=setTimeout(()=>{btn.textContent='Sign In';btn.disabled=false;err.textContent='Request timed out.';},8000);
  try{
    if(u===SA_CRED.u){
      if(p!==SA_CRED.p){err.textContent='Invalid username or password';return;}
      S={u:SA_CRED.u,role:'superadmin',name:'System Owner'};
      sessionStorage.setItem('akbd_session',JSON.stringify(S));
      document.getElementById('tbUser').textContent='System Owner';
      document.getElementById('tbTitle').textContent='Owner Console';
      renderSA(); showScreen('superadmin');
      return;
    }
    const cu=DB.findOne('users',x=>x.u===u&&x.status==='active');
    if(!cu){err.textContent='Invalid username or password';return;}
    const valid=await verifyPassword(p,cu.p);
    if(!valid){err.textContent='Invalid username or password';return;}
    const clinic=getClinic(cu.cid);
    if(!clinic){err.textContent='Clinic configuration missing. Contact administrator.';return;}
    // ‚îÄ‚îÄ Clinic ON/OFF check ‚îÄ‚îÄ
    if(clinic.clinic_status==='OFF'){
      err.textContent='‚õî This clinic is currently suspended by the system administrator. Please contact support.';return;
    }
    // ‚îÄ‚îÄ Recharge expiry check ‚îÄ‚îÄ
    if(clinic.recharge_expiry_date){
      const today2=new Date(); today2.setHours(0,0,0,0);
      const expiry=new Date(clinic.recharge_expiry_date); expiry.setHours(0,0,0,0);
      if(expiry<today2){
        err.textContent='‚è∞ Subscription expired on '+clinic.recharge_expiry_date+'. Recharge required. Contact system administrator.';return;
      }
      // 7-day warning
      const diffDays=Math.floor((expiry-today2)/(1000*60*60*24));
      if(diffDays<=7){
        setTimeout(()=>N(`‚ö† Subscription expires in ${diffDays} day(s)! Please recharge soon.`,true),1500);
      }
    }
    S={u:cu.u,role:cu.role,name:cu.name,cid:cu.cid,cliName:clinic.name};
    sessionStorage.setItem('akbd_session',JSON.stringify(S));
    document.getElementById('tbUser').textContent=cu.name;
    document.getElementById('tbTitle').textContent=clinic.name;
    document.getElementById('dashClinic').textContent=clinic.name;
    document.getElementById('dashName').textContent=cu.name;
    buildGrid();
    routeByRole(cu.role);
  }catch(e){
    err.textContent='Login failed. Please try again.';
    console.error('[Login]',e);
  }finally{
    clearTimeout(timeout);
    btn.textContent='Sign In'; btn.disabled=false;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP GRID (TILE ACCESS SCREEN) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Per spec: After login show ONLY: Pathology, Indoor, OPD, Logout
// Admin gets Settings tile added.
const MODS_ROLE = {
  superadmin:[
    {k:'opd',      l:'OPD',       i:'üè•'},
    {k:'pathology',l:'Pathology', i:'üî¨'},
    {k:'indoor',   l:'Indoor',    i:'üõèÔ∏è'},
    {k:'settings', l:'Settings',  i:'‚öôÔ∏è'},
    {k:'logout',   l:'Logout',    i:'‚èèÔ∏è',color:'#dc2626'},
  ],
  admin:[
    {k:'opd',      l:'OPD',       i:'üè•'},
    {k:'pathology',l:'Pathology', i:'üî¨'},
    {k:'indoor',   l:'Indoor',    i:'üõèÔ∏è'},
    {k:'settings', l:'Settings',  i:'‚öôÔ∏è'},
    {k:'logout',   l:'Logout',    i:'‚èèÔ∏è',color:'#dc2626'},
  ],
  reception:[
    {k:'opd',      l:'OPD',       i:'üè•'},
    {k:'pathology',l:'Pathology', i:'üî¨'},
    {k:'indoor',   l:'Indoor',    i:'üõèÔ∏è'},
    {k:'logout',   l:'Logout',    i:'‚èèÔ∏è',color:'#dc2626'},
  ],
};

function buildGrid(){
  const tiles = MODS_ROLE[S?.role] || [
    {k:'opd',      l:'OPD',       i:'üè•'},
    {k:'pathology',l:'Pathology', i:'üî¨'},
    {k:'indoor',   l:'Indoor',    i:'üõèÔ∏è'},
    {k:'logout',   l:'Logout',    i:'‚èèÔ∏è'},
  ];
  const cols = tiles.length <= 3 ? tiles.length : tiles.length <= 4 ? 4 : tiles.length <= 6 ? 3 : 4;
  document.getElementById('appGrid').style.gridTemplateColumns = `repeat(${cols},160px)`;
  document.getElementById('appGrid').innerHTML=tiles.map(m=>{
    return`<div class="app-card" onclick="openModule('${m.k}')" style="padding:24px 10px;${m.color?'border-color:'+m.color+';background:'+m.color+'10;':''}">
      <div class="app-icon">${m.i}</div>
      <div class="app-label" style="${m.color?'color:'+m.color+';':''}">${m.l}</div>
    </div>`;
  }).join('');
}
function openModule(k){
  if(k==='logout'){doLogout();return;}
  if(k==='opd'){openOPD();return;}
  if(k==='indoor'){openIndoor();return;}
  if(k==='billing'){openWS('billing');return;}
  openWS(k);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WORKSPACE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WS_TABS={
  billing:['New Invoice','Invoice List','Due Collection','ID Search'],
  patients:['Patient List','Register Patient'],
  pathology:['üî¨ Result Entry','Test List','Categories','Machines','Settings'],
  reports:['Invoice Report','Lab Report','Date-wise','Daily Export'],
  accounts:['Summary','Date Range','Receipt Log','üë§ User Collection'],
  settings:['Clinic Profile','Personnel','Doctors','Authorized Persons','GS Config','My Profile'],
};
const WS_FUNS={
  billing:[rBilNew,rInvList,rDueColl,rIdSearch],
  patients:[rPatList,rPatReg],
  pathology:[rResultEntry,rTestList,rTestCats,rMachineNames,rPathologySettings],
  reports:[rRptInv,rRptLab,rRptDate,rDailyExport],
  accounts:[rAccSummary,rAccRange,rAccReceipts,rUserCollection],
  settings:[rSetClinic,rSetPersonnel,rSetDoctors,rSetAuth,rSetGS,rSetMyProfile],
};
let curWS=null, selTests=[], printData=null, dueInv=null, reviewInvId=null, lastDueLog=null;

function openWS(k){
  if(!can(k)){N('Access denied.',true);return;}
  curWS=k;
  document.getElementById('tbTitle').textContent=k.charAt(0).toUpperCase()+k.slice(1);
  buildTabs(k,0);
  WS_FUNS[k][0]();
  showScreen('workspace');
}
function buildTabs(k,ai){
  const singleRoles=['lab','accounts','opd','indoor'];
  const restricted=singleRoles.includes(S?.role);
  const backBtn=restricted
    ?`<button class="ws-back" onclick="doLogout()">‚èè Logout</button>`
    :`<button class="ws-back" onclick="goToDash()">‚Üê Dashboard</button>`;
  // For lab role in pathology, only show Admission/Result Entry/Test List/Categories/Settings (no Machines)
  let tabs=WS_TABS[k];
  let funs=WS_FUNS[k];
  if(k==='pathology'&&S?.role==='lab'){
    tabs=['üî¨ Result Entry','Test List','Categories','Settings'];
    funs=[rResultEntry,rTestList,rTestCats,rPathologySettings];
  }
  document.getElementById('wsNav').innerHTML=
    tabs.map((t,i)=>`<div class="ws-tab${i===ai?' active':''}" onclick="swTabDyn(this,${i},'${k}')">${t}</div>`).join('')+
    `<div class="ws-spacer"></div>${backBtn}`;
  window._wsTabFuns=funs;
}
function swTabDyn(el,i,k){
  document.querySelectorAll('.ws-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  (window._wsTabFuns||WS_FUNS[k]||[])[i]?.();
}
function swTab(el,k,i){
  document.querySelectorAll('.ws-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  WS_FUNS[k][i]();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PATHOLOGY: ADMISSION (REMOVED ‚Äî now goes to Result Entry) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rAdmission(){
  rResultEntry();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PATHOLOGY INVOICE SYSTEM (PATH-YYYY-XXX) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pathSelTests=[]; // selected tests for current PATH invoice

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PATHOLOGY: PATH INVOICE REMOVED (v17) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// All invoicing is done via OPD Invoice module.
// Pathology tests auto-link to OPD invoices.
// This function kept for backward compat only.
function rPathInvoice(){ rResultEntry(); }

function buildPathTRows(){ return ''; }
function fPathTests(){}
function addPathT(){}
function rmPathT(){}
function upPathSel(){}
function calcPathT(){}
function updatePathAgeVal(){}
function pathAutoFillDoc(){}
function searchPathInvoice(){}
async function savePathInvoice(){
  N('‚ö† Pathology invoices are no longer created here. Please use the OPD Invoice module.',true);
}
function renderPathInvoiceList(){}

// Legacy: display old pathology invoice search result (for backward compat)
function displayLegacyPathInvoiceResult(inv, resEl){
  const items = DB.get('pathology_invoice_items').filter(item => item.pathInvId === inv.id);
  const docDisplay = (inv.doctorName && inv.doctorDegree)
    ? `${escHtml(inv.doctorName)}, ${escHtml(inv.doctorDegree)}`
    : (inv.doctorName ? escHtml(inv.doctorName) : '‚Äî');
  const testsHtml = items.length
    ? `<table style="width:100%;border-collapse:collapse;font-size:11px;margin-top:4px;">
        <thead><tr style="background:rgba(109,40,217,.08);">
          <th style="padding:3px 7px;border:1px solid #ddd;text-align:left;">Test</th>
          <th style="padding:3px 7px;border:1px solid #ddd;text-align:center;">Qty</th>
          <th style="padding:3px 7px;border:1px solid #ddd;text-align:right;">Price</th>
        </tr></thead>
        <tbody>${items.map(item=>`
          <tr>
            <td style="padding:3px 7px;border:1px solid #eee;">${escHtml(item.testName||item.testId||'‚Äî')}</td>
            <td style="padding:3px 7px;border:1px solid #eee;text-align:center;">${item.qty||1}</td>
            <td style="padding:3px 7px;border:1px solid #eee;text-align:right;">‡ß≥${(item.unitPrice||0).toFixed(2)}</td>
          </tr>`).join('')}
        </tbody>
      </table>`
    : '<span style="color:var(--amber);font-size:11px;">‚ö† No tests linked to this invoice.</span>';

  if(resEl) resEl.innerHTML=`<div style="border:1px solid rgba(109,40,217,.25);border-radius:7px;overflow:hidden;">
    <div style="background:rgba(109,40,217,.06);padding:8px 12px;display:flex;justify-content:space-between;align-items:center;">
      <span style="font-weight:700;color:var(--purple);font-family:var(--mono);">${escHtml(inv.no)}</span>
      <div style="display:flex;gap:6px;">
        <button class="btn btn-o btn-sm" onclick="reviewPathInvoice('${inv.id}')">üëÅ Review</button>
        <button class="btn btn-t btn-sm" onclick="reprintPathInvoice('${inv.id}')" style="background:var(--purple);">üñ® Print</button>
      </div>
    </div>
    <div style="padding:10px 12px;font-size:11px;">
      <b>${escHtml(inv.patient)}</b> | ${escHtml(inv.date)} | Doctor: ${docDisplay}
      | Total: <strong>‡ß≥${(inv.subtotal||0).toLocaleString()}</strong>
      | Due: <span style="color:${(inv.due||0)>0?'var(--red)':'var(--green)'};">‡ß≥${(inv.due||0).toLocaleString()}</span>
      ${inv.void?'<span class="badge b-warn" style="margin-left:8px;">VOIDED</span>':''}
      <div style="margin-top:8px;"><strong>Tests (${items.length}):</strong>${testsHtml}</div>
    </div>
  </div>`;
}

// Legacy list display (no longer shown, kept for data access)
// Old pathology invoices can be reviewed via reviewPathInvoice(id) if needed.


function reviewPathInvoice(id){
  const inv=DB.findOne('pathology_invoices',i=>i.id===id);
  if(!inv){N('Pathology invoice not found.',true);return;}
  const items=DB.get('pathology_invoice_items').filter(item=>item.pathInvId===id);
  const clinic=getClinic(inv.cid)||{};
  const docDisplay=(inv.doctorName&&inv.doctorDegree)?`${inv.doctorName}, ${inv.doctorDegree}`:(inv.doctorName||'‚Äî');
  const net=(inv.subtotal||0)-(inv.discount||0);
  document.getElementById('m-review-body').innerHTML=`
  <div style="background:#fff;color:#000;padding:16px;border-radius:6px;">
    ${buildPathInvoiceHTML(inv,items,clinic)}
  </div>
  <div style="margin-top:12px;padding:10px;background:rgba(109,40,217,.06);border:1px solid rgba(109,40,217,.18);border-radius:7px;font-size:11px;color:var(--text2);">
    <strong style="color:var(--purple)">Pathology Invoice Details</strong><br>
    ID: <code style="color:var(--text)">${inv.id}</code> &nbsp;|&nbsp;
    Created: ${new Date(inv.createdAt||'').toLocaleString('en-GB')} &nbsp;|&nbsp;
    By: ${escHtml(inv.byName||inv.by)} &nbsp;|&nbsp;
    Status: <span style="color:${(inv.due||0)>0?'var(--red)':'var(--green)'};">${(inv.status||'').toUpperCase()}</span>
    ${inv.void?'&nbsp;|&nbsp;<strong style="color:var(--red);">‚ö† VOIDED</strong>':''}
  </div>`;
  document.getElementById('review-print-btn').onclick=()=>reprintPathInvoice(id);
  openModal('m-review');
}

function reprintPathInvoice(id){
  const inv=DB.findOne('pathology_invoices',i=>i.id===id);
  if(!inv){N('Invoice not found.',true);return;}
  const items=DB.get('pathology_invoice_items').filter(item=>item.pathInvId===id);
  const clinic=getClinic(inv.cid)||{};
  printPathInvoice(inv,items,clinic);
}

function buildPathInvoiceHTML(inv,items,clinic){
  const now=new Date();
  const ts=`${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()} ${now.toLocaleTimeString('en-GB')}`;
  const cl=clinic||getClinic(inv.cid)||{};
  const sub=inv.subtotal||0,disc=inv.discount||0,net=sub-disc,paid=inv.paid||0,due=inv.due||0;
  // Doctor: ONLY show name + degree, NEVER code
  const docDisplay=(inv.doctorName&&inv.doctorDegree)?`${escHtml(inv.doctorName)}, ${escHtml(inv.doctorDegree)}`:(inv.doctorName?escHtml(inv.doctorName):'');
  return`<div style="width:100%;font-family:'Times New Roman',Times,serif;font-size:11pt;color:#000;line-height:1.6;background:#fff;">
  <div style="display:flex;justify-content:space-between;font-size:8.5pt;margin-bottom:4px;color:#555;">
    <span style="letter-spacing:2px;font-family:monospace;">*${escHtml(inv.no)}*</span>
    <span>Printed: ${ts}</span>
  </div>
  <div style="text-align:center;margin-bottom:10px;border-bottom:2px double #000;padding-bottom:10px;">
    ${cl.logo?`<img src="${escHtml(cl.logo)}" style="height:50px;margin-bottom:6px;display:block;margin-left:auto;margin-right:auto;object-fit:contain;" alt="Logo">`:''}
    <div style="font-size:16pt;font-weight:bold;letter-spacing:1px;">${escHtml(cl.header||cl.name||'CLINIC')}</div>
    <div style="font-size:9pt;margin-top:2px;">${escHtml(cl.address||'')}</div>
    <div style="font-size:9pt;">Phone: ${escHtml(cl.phone||'')}${cl.email?'  |  '+escHtml(cl.email):''}</div>
  </div>
  <div style="text-align:center;font-weight:bold;font-size:9pt;border-top:1px dashed #000;border-bottom:1px dashed #000;padding:3px 0;margin-bottom:8px;">
    PATHOLOGY INVOICE
  </div>
  <div style="display:flex;justify-content:space-between;font-size:9.5pt;margin-bottom:6px;">
    <div>
      <div><strong>Invoice No :</strong> <strong style="letter-spacing:1px;color:#000;">${escHtml(inv.no)}</strong></div>
      <div><strong>Date :</strong> ${escHtml(inv.date||'')}</div>
      <div><strong>Patient ID :</strong> ${escHtml(inv.patientId||'‚Äî')}</div>
    </div>
    <div style="text-align:right;">
      <div><strong>Phone :</strong> ${escHtml(inv.phone||'‚Äî')}</div>
      ${inv.age&&inv.age!=='‚Äî'?`<div><strong>Age :</strong> ${escHtml(inv.age)}</div>`:''}
      ${inv.gender&&inv.gender!=='‚Äî'?`<div><strong>Gender :</strong> ${escHtml(inv.gender)}</div>`:''}
    </div>
  </div>
  <div style="border:1px solid #000;padding:5px 10px;margin-bottom:8px;font-size:9.5pt;">
    <div><strong>Patient Name :</strong> ${escHtml(inv.patient||'')}</div>
    ${docDisplay?`<div><strong>Referred By :</strong> ${docDisplay}</div>`:''}
  </div>
  <table style="width:100%;border-collapse:collapse;font-size:9.5pt;margin-bottom:6px;">
    <thead>
      <tr style="background:#f0f0f0;">
        <th style="text-align:center;padding:4px 6px;border:1px solid #ccc;width:28px;">SL</th>
        <th style="text-align:left;padding:4px 6px;border:1px solid #ccc;">Test Name</th>
        <th style="text-align:center;padding:4px 6px;border:1px solid #ccc;width:40px;">Qty</th>
        <th style="text-align:right;padding:4px 6px;border:1px solid #ccc;width:88px;">Unit Price (‡ß≥)</th>
        <th style="text-align:right;padding:4px 6px;border:1px solid #ccc;width:88px;">Total (‡ß≥)</th>
      </tr>
    </thead>
    <tbody>
      ${items.length?items.map((item,idx)=>`<tr>
        <td style="padding:3px 6px;border:1px solid #ddd;text-align:center;">${idx+1}</td>
        <td style="padding:3px 6px;border:1px solid #ddd;">${escHtml(item.testName||'')}</td>
        <td style="padding:3px 6px;border:1px solid #ddd;text-align:center;">${item.qty||1}</td>
        <td style="text-align:right;padding:3px 6px;border:1px solid #ddd;">${(item.unitPrice||0).toFixed(2)}</td>
        <td style="text-align:right;padding:3px 6px;border:1px solid #ddd;">${(item.lineTotal||0).toFixed(2)}</td>
      </tr>`).join(''):'<tr><td colspan="5" style="text-align:center;color:#999;padding:8px;">No tests</td></tr>'}
    </tbody>
    <tfoot>
      <tr style="background:#f5f5f5;">
        <td colspan="4" style="padding:3px 6px;border:1px solid #ccc;text-align:right;font-weight:700;">Total Tests: ${items.length}</td>
        <td style="padding:3px 6px;border:1px solid #ccc;text-align:right;font-weight:700;">${sub.toFixed(2)}</td>
      </tr>
    </tfoot>
  </table>
  <table style="width:100%;border-collapse:collapse;font-size:9.5pt;margin-bottom:8px;">
    <tr><td style="width:55%"></td><td style="padding:2px 6px;text-align:right;border-top:1px solid #ccc;">Sub Total (Tk.) :</td><td style="padding:2px 6px;text-align:right;border-top:1px solid #ccc;width:90px;">${sub.toFixed(2)}</td></tr>
    <tr><td></td><td style="padding:2px 6px;text-align:right;">Discount (Tk.) :</td><td style="padding:2px 6px;text-align:right;">${disc.toFixed(2)}</td></tr>
    <tr><td></td><td style="padding:2px 6px;text-align:right;border-top:1px solid #ccc;">Net Payable (Tk.) :</td><td style="padding:2px 6px;text-align:right;border-top:1px solid #ccc;">${net.toFixed(2)}</td></tr>
    <tr><td></td><td style="padding:2px 6px;text-align:right;">Total Paid (Tk.) :</td><td style="padding:2px 6px;text-align:right;color:green;">${paid.toFixed(2)}</td></tr>
    <tr style="background:#f8f8f8;"><td></td><td style="padding:4px 6px;text-align:right;font-weight:bold;font-size:11pt;border-top:2px solid #000;border-bottom:2px solid #000;">Due (Tk.) :</td><td style="padding:4px 6px;text-align:right;font-weight:bold;font-size:11pt;border-top:2px solid #000;border-bottom:2px solid #000;color:${due>0?'red':'green'};">${due.toFixed(2)}</td></tr>
  </table>
  ${due>0?`<div style="margin:6px 0;"><span style="font-size:18pt;font-weight:bold;border:3px solid red;color:red;padding:3px 18px;display:inline-block;letter-spacing:3px;">DUE</span></div>`:`<div style="margin:6px 0;color:green;font-weight:bold;font-size:11pt;">‚úì PAID IN FULL</div>`}
  ${inv.void?`<div style="margin:6px 0;color:red;font-weight:bold;font-size:12pt;border:2px solid red;display:inline-block;padding:4px 16px;letter-spacing:2px;">‚ö† VOIDED</div>`:''}
  <div style="margin-top:16px;border-top:1px dashed #000;padding-top:8px;display:flex;justify-content:space-between;font-size:8.5pt;color:#555;">
    <div>Prepared By : ${escHtml(inv.byName||inv.by||'‚Äî')}<br>Software : Asad Kit BD v17</div>
    <div style="text-align:right;">${ts}</div>
  </div>
  <div style="margin-top:6px;text-align:center;font-size:7.5pt;color:#999;">‚îÄ‚îÄ‚îÄ Thank you for choosing ${escHtml(cl.name||'our clinic')} ‚îÄ‚îÄ‚îÄ</div>
</div>`;
}

function printPathInvoice(inv,items,clinicArg){
  const clinic=clinicArg||getClinic(inv.cid)||{};
  const html=buildPathInvoiceHTML(inv,items,clinic);
  const el=document.getElementById('m-print-body');
  if(el){el.innerHTML=html; printData={d:inv,html};}
  // Open print window
  const w=window.open('','_blank','width=870,height=1100');
  if(!w){N('Pop-up blocked. Please allow pop-ups to print.',true);return;}
  w.document.write(`<!DOCTYPE html><html><head><title>Pathology Invoice ‚Äî ${escHtml(inv.no)}</title>
  <style>
    @page{size:8.5in 11in;margin:0.5in;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{width:7.5in;margin:0;padding:0;font-family:'Times New Roman',Times,serif;font-size:11pt;background:#fff;color:#000;}
    @media print{body{width:7.5in;} @page{size:8.5in 11in;margin:0.5in;}}
    table{width:100%;border-collapse:collapse;}
  </style></head>
  <body onload="setTimeout(()=>{window.print();window.close();},500);">${html}</body></html>`);
  w.document.close();
}

function voidPathInvoice(id){
  if(!['admin','superadmin'].includes(S?.role)){N('Only Admin can void invoices.',true);return;}
  const inv=DB.findOne('pathology_invoices',i=>i.id===id);
  if(!inv){N('Invoice not found.',true);return;}
  if(inv.void){N('Invoice already voided.',true);return;}
  if(!confirm(`Void pathology invoice ${inv.no}? This action is permanent. The ID will remain in the system.`)) return;
  try{
    DB.update('pathology_invoices',i=>i.id===id,{void:true,voidedAt:new Date().toISOString(),voidedBy:S.u});
    N(`‚úì Invoice ${inv.no} voided. ID preserved.`);
    renderPathInvoiceList();
  }catch(e){N('System error occurred. Please contact admin.',true);console.error('[VoidPath]',e);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PATHOLOGY: SETTINGS (Password Change Only) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rPathologySettings(){
  const cu=DB.findOne('users',u=>u.u===S.u)||{};
  document.getElementById('wsBody').innerHTML=`
  <div class="box" style="max-width:520px;">
    <div class="box-title">üî¨ Pathology ‚Äî My Account</div>
    <div class="f2" style="margin-bottom:10px;">
      <div class="fi"><label>Name</label><input value="${escHtml(cu.name||'')}" readonly style="background:var(--bg2);"></div>
      <div class="fi"><label>Username</label><input value="${escHtml(cu.u||'')}" readonly style="background:var(--bg2);"></div>
    </div>
    <div class="pw-section">
      <div class="box-title">üîë Change Password</div>
      <div class="fi" style="margin-bottom:10px;"><label>Current Password *</label><input type="password" id="path_sp_old" placeholder="Enter current password"></div>
      <div class="fi" style="margin-bottom:10px;"><label>New Password *</label><input type="password" id="path_sp_new" placeholder="Min 6 characters"></div>
      <div class="fi" style="margin-bottom:10px;"><label>Confirm New Password *</label><input type="password" id="path_sp_confirm" placeholder="Repeat new password"></div>
      <div id="path_sp_err" style="min-height:14px;font-size:12px;color:var(--red);margin-bottom:8px;"></div>
      <div class="action-row"><button class="btn btn-t" onclick="doPathologyChangePw()">üîë Change Password</button></div>
    </div>
  </div>`;
}
async function doPathologyChangePw(){
  const old=document.getElementById('path_sp_old')?.value;
  const nw=document.getElementById('path_sp_new')?.value;
  const cf=document.getElementById('path_sp_confirm')?.value;
  const err=document.getElementById('path_sp_err');
  if(err)err.textContent='';
  if(!old||!nw||!cf){if(err)err.textContent='All fields required.';return;}
  if(nw.length<6){if(err)err.textContent='Min 6 characters.';return;}
  if(nw!==cf){if(err)err.textContent='Passwords do not match.';return;}
  const cu=DB.findOne('users',u=>u.u===S.u);
  if(!cu){if(err)err.textContent='User not found.';return;}
  const valid=await verifyPassword(old,cu.p);
  if(!valid){if(err)err.textContent='Current password incorrect.';return;}
  try{
    DB.update('users',u=>u.u===S.u,{p:await hashPassword(nw),pwChangedAt:new Date().toISOString()});
    N('‚úì Password changed successfully.');
    ['path_sp_old','path_sp_new','path_sp_confirm'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  }catch(e){if(err)err.textContent='Failed: '+e.message;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BILLING: NEW INVOICE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rBilNew(){
  selTests=[];
  const today=new Date().toISOString().split('T')[0];
  const no=nextInvNo(S.cid);
  const TESTS=myTests();
  const cats=[...new Set(TESTS.map(t=>t.cat))];
  const doctors=myDoctors();
  const authorized=myAuthorized();
  // Combined ref list - show Name, Degree format (no codes, no arrows)
  const allRefDocs=[...new Set([
    ...doctors.map(d=>d.name+(d.degree?', '+d.degree:'')),
    ...authorized.map(a=>a.name+(a.designation?', '+a.designation:''))
  ])];
  document.getElementById('wsBody').innerHTML=`
  <div class="inv-layout">
    <div>
      <div class="box">
        <div class="box-title">Invoice Details</div>
        <div class="f4" style="margin-bottom:12px;">
          <div class="fi"><label>Invoice No</label><input id="i_no" value="${no}" readonly></div>
          <div class="fi"><label>Date</label><input type="date" id="i_date" value="${today}" onkeydown="if(event.key==='Enter'||event.key==='Tab'){event.preventDefault();document.getElementById('i_name')?.focus();}"></div>
          <div class="fi"><label>Patient Name *</label><input id="i_name" placeholder="Full name" autofocus onkeydown="if(event.key==='Enter'){document.getElementById('i_phone')?.focus();}"></div>
          <div class="fi"><label>Phone</label><input id="i_phone" placeholder="01X00-000000" onkeydown="if(event.key==='Enter'){document.getElementById('i_age_y')?.focus();}"></div>
        </div>
        <div class="f4">
          <div class="fi"><label>Age</label>
            <div style="display:flex;gap:6px;align-items:center;">
              <input id="i_age_y" type="number" min="0" placeholder="Yr" style="width:60px;padding:8px 8px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;outline:none;" oninput="updateAgeVal()">
              <span style="font-size:12px;color:var(--text2);">Y</span>
              <input id="i_age_m" type="number" min="0" max="11" placeholder="Mo" style="width:60px;padding:8px 8px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;outline:none;" oninput="updateAgeVal()">
              <span style="font-size:12px;color:var(--text2);">M</span>
              <input type="hidden" id="i_age" value="">
            </div>
          </div>
          <div class="fi"><label>Gender</label><select id="i_gender"><option value="">‚Äî Select ‚Äî</option><option>Male</option><option>Female</option><option>Other</option></select></div>
          <div class="fi"><label>Ref. Doctor</label>
            <input id="i_doc" placeholder="Dr. Name, Degree" list="ref-doc-list">
            <datalist id="ref-doc-list">${allRefDocs.map(d=>`<option value="${escHtml(d)}">`).join('')}</datalist>
          </div>
          <div class="fi"><label>Patient Type</label><select id="i_type"><option>General Patient</option><option>Emergency</option><option>Corporate</option></select></div>
        </div>
        <div class="f2" style="margin-top:10px;">
          <div class="fi"><label>Code (optional)</label><input id="i_code" placeholder="Enter code if required"></div>
        </div>
      </div>
      <div class="box">
        <div class="box-title">Test / Service Selection</div>
        <div class="bar" style="margin-bottom:10px;">
          <input id="tsq" placeholder="Search test name..." oninput="fTests()" style="flex:1;">
          <select id="tsc" onchange="fTests()">
            <option value="">All Categories</option>
            ${cats.map(c=>`<option>${escHtml(c)}</option>`).join('')}
          </select>
        </div>
        <div class="test-scroll" id="tListEl">${buildTRows('','')}</div>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
          <div class="box-title" style="margin-bottom:8px;">Selected Tests</div>
          <div id="selEl"><em style="font-size:12px;color:var(--text2)">No tests selected yet.</em></div>
        </div>
      </div>
    </div>
    <div>
      <div class="box">
        <div class="box-title">Billing Summary</div>
        <div class="tot-row"><span>Subtotal</span><span id="ts" style="font-family:var(--mono)">‡ß≥ 0</span></div>
        <div class="tot-row"><span>Discount (‡ß≥)</span><input class="tinput" id="td" type="number" min="0" value="0" oninput="calcT()"></div>
        <div class="tot-row"><span>Net Payable</span><span id="tn" style="font-family:var(--mono)">‡ß≥ 0</span></div>
        <div class="tot-row"><span>Paid (‡ß≥)</span><input class="tinput" id="tp" type="number" min="0" value="0" oninput="calcT()"></div>
        <div class="tot-row tot-grand"><span>Grand Total</span><span id="tg" style="font-family:var(--mono)">‡ß≥ 0</span></div>
        <div class="tot-row tot-due"><span>Due</span><span id="tdu" style="font-family:var(--mono)">‡ß≥ 0</span></div>
      </div>
      <div class="action-row">
        <button class="btn btn-t" id="btn-sp" onclick="saveAndPrint()">üñ® Save &amp; Print</button>
        <button class="btn btn-r" onclick="rBilNew()">‚úï Clear</button>
      </div>
    </div>
  </div>`;
}
function buildTRows(q,cat){
  const tests=myTests().filter(t=>t.name.toLowerCase().includes((q||'').toLowerCase())&&(cat===''||t.cat===cat));
  if(!tests.length) return `<div style="padding:10px;color:var(--text2);font-size:12px;">No tests found.</div>`;
  // Group by category
  const byCat={};
  tests.forEach(t=>{
    if(!byCat[t.cat]) byCat[t.cat]=[];
    byCat[t.cat].push(t);
  });
  if(cat!=='') {
    // Single category - no grouping needed
    return tests.map(t=>`<div class="test-row" onclick="addT('${t.id}')"><span>${escHtml(t.name)}</span><span class="tp">‡ß≥${t.price}</span></div>`).join('');
  }
  // Multiple categories - group with headers
  return Object.entries(byCat).map(([catName,items])=>`
    <div style="font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--text3);font-weight:700;padding:6px 11px 3px;background:var(--bg2);">${escHtml(catName)}</div>
    ${items.map(t=>`<div class="test-row" onclick="addT('${t.id}')"><span>${escHtml(t.name)}</span><span class="tp">‡ß≥${t.price}</span></div>`).join('')}
  `).join('');
}
function fTests(){
  const q=document.getElementById('tsq')?.value||'', c=document.getElementById('tsc')?.value||'';
  const el=document.getElementById('tListEl'); if(el) el.innerHTML=buildTRows(q,c);
}
function addT(id){
  if(selTests.find(t=>t.id===id)){N('Already added.',true);return;}
  const test=getTestById(id); if(!test){N('Test not found.',true);return;}
  selTests.push({...test}); upSel(); calcT();
}
function rmT(id){ selTests=selTests.filter(t=>t.id!==id); upSel(); calcT(); }
function upSel(){
  const el=document.getElementById('selEl'); if(!el) return;
  if(!selTests.length){el.innerHTML='<em style="font-size:12px;color:var(--text2)">No tests selected yet.</em>';return;}
  el.innerHTML=selTests.map(t=>`<div class="sel-item">
    <span>${escHtml(t.name)}</span>
    <span style="display:flex;align-items:center;gap:8px;">
      <span style="color:var(--teal);font-family:var(--mono);font-size:11px;">‡ß≥${t.price}</span>
      <span class="trm" onclick="rmT('${t.id}')">√ó</span>
    </span></div>`).join('');
}
function calcT(){
  const sub=selTests.reduce((s,t)=>s+t.price,0);
  const disc=Math.min(parseFloat(document.getElementById('td')?.value||0),sub);
  const net=sub-disc, paid=parseFloat(document.getElementById('tp')?.value||0), due=Math.max(net-paid,0);
  document.getElementById('ts').textContent=`‡ß≥ ${sub.toLocaleString()}`;
  document.getElementById('tn').textContent=`‡ß≥ ${net.toLocaleString()}`;
  document.getElementById('tg').textContent=`‡ß≥ ${net.toLocaleString()}`;
  document.getElementById('tdu').textContent=`‡ß≥ ${due.toLocaleString()}`;
}
function updateAgeVal(){
  const y=document.getElementById('i_age_y')?.value||'';
  const m=document.getElementById('i_age_m')?.value||'';
  let age='';
  if(y) age+=y+'Y';
  if(m) age+=(age?' ':'')+m+'M';
  const el=document.getElementById('i_age');
  if(el) el.value=age;
}
function getInvData(){
  const sub=selTests.reduce((s,t)=>s+t.price,0);
  const disc=Math.min(parseFloat(document.getElementById('td')?.value||0),sub);
  return{
    no:document.getElementById('i_no')?.value, date:document.getElementById('i_date')?.value,
    patient:document.getElementById('i_name')?.value?.trim()||'',
    phone:document.getElementById('i_phone')?.value||'',
    age:document.getElementById('i_age')?.value||'‚Äî', gender:document.getElementById('i_gender')?.value||'‚Äî',
    doctor:document.getElementById('i_doc')?.value||'', type:document.getElementById('i_type')?.value||'General Patient',
    tests:[...selTests], sub, disc, net:sub-disc,
    paid:parseFloat(document.getElementById('tp')?.value||0),
    due:Math.max(sub-disc-parseFloat(document.getElementById('tp')?.value||0),0),
    clinic:getClinic(S.cid)||{}, by:S.name
  };
}
async function saveAndPrint(){
  const btn=document.getElementById('btn-sp');
  const d=getInvData();
  if(!d.patient){N('Patient name is required.',true);return;}
  if(!d.tests.length){N('Select at least one test.',true);return;}
  if(!d.date){N('Invoice date is required.',true);return;}
  if(btn){btn.textContent='‚è≥ Saving‚Ä¶'; btn.disabled=true;}
  try{
    const record={
      id:uid(), no:d.no, date:d.date, cid:S.cid,
      patient:d.patient, phone:d.phone, age:d.age, gender:d.gender,
      doctor:d.doctor, type:d.type,
      code:document.getElementById('i_code')?.value?.trim()||'',
      tests:d.tests.map(t=>t.id),
      subtotal:d.sub, discount:d.disc, paid:d.paid, due:d.due,
      status:d.due>0?'due':'paid',
      by:S.u, byName:S.name||S.u,
      createdAt:new Date().toISOString()
    };
    DB.insert('invoices',record);
    // ‚îÄ‚îÄ Track in user_collections (always, for comprehensive reporting) ‚îÄ‚îÄ
    DB.insert('user_collections',{
      id:uid(), cid:S.cid,
      invoiceNo:d.no, invoiceId:record.id,
      invoiceType:'LAB',
      module:'Lab',
      patient:d.patient,
      amount:d.paid,
      receivedBy:S.u,
      receivedByName:S.name||S.u,
      receiveDate:d.date,
      location:getClinic(S.cid)?.name||'',
      note: d.paid>0 ? 'Payment on Lab invoice' : 'Invoice created (no payment)',
      createdAt:new Date().toISOString()
    });
    N(`‚úì Invoice ${d.no} saved.`);
    // Auto-register patient if new
    if(!myPats().find(p=>p.name.toLowerCase()===d.patient.toLowerCase()&&p.cid===S.cid)){
      const pCount=myPats().length+1;
      DB.insert('patients',{
        id:`P-${String(pCount).padStart(3,'0')}`, name:d.patient, phone:d.phone,
        age:d.age.replace(/[^0-9]/g,''), gender:d.gender, blood:'', cid:S.cid,
        reg:d.date
      });
    }
    buildPrint(d, '');
    openModal('m-print');
    rBilNew();
  }catch(e){
    N('Save failed: '+e.message,true);
    console.error('[Billing]',e);
  }finally{
    if(btn){btn.textContent='üñ® Save & Print'; btn.disabled=false;}
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRINT ENGINE (8√ó12 INCH) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildPrint(d, manualCode){
  const now=new Date();
  const ts=`${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()} ${now.toLocaleTimeString('en-GB')}`;
  const code=manualCode||'';
  document.getElementById('m-print-body').innerHTML=buildInvoiceHTML(d,code,ts);
  printData={d,code,ts};
}
function buildInvoiceHTML(d,code,ts){
  const barcode=d.no||'';
  const sub=d.sub||d.subtotal||0;
  const disc=d.disc||d.discount||0;
  const net=d.net!==undefined?d.net:(sub-disc);
  const paid=d.paid||0;
  const due=d.due!==undefined?d.due:Math.max(net-paid,0);
  const tests=d.tests||[];
  // v13: Doctor display ‚Äî NEVER show code. Show name + degree only.
  const doctorDisplay=(()=>{
    const raw=d.doctor||d.docName||'';
    if(!raw||raw==='‚Äî') return '';
    // Strip any code patterns like [ABC] or (CODE) that may have slipped through
    return raw.replace(/\[.*?\]/g,'').replace(/\(CODE:[^)]*\)/gi,'').trim();
  })();

  const clinic=d.clinic||{};
  const printSettings=clinic.printSettings||{};
  const fontSize=printSettings.fontSize||'11pt';
  const lineH=printSettings.lineHeight||'1.6';

  return`<div style="width:100%;font-family:'Times New Roman',Times,serif;font-size:${fontSize};color:#000;line-height:${lineH};background:#fff;">
  <!-- INVOICE NO top-right -->
  <div style="display:flex;justify-content:space-between;font-size:8.5pt;margin-bottom:4px;color:#555;">
    <span style="letter-spacing:2px;">*${escHtml(barcode)}*</span>
    <span>Date Printed: ${ts?ts:new Date().toLocaleDateString('en-GB')}</span>
  </div>
  <!-- CLINIC HEADER -->
  <div style="text-align:center;margin-bottom:10px;border-bottom:2px double #000;padding-bottom:10px;">
    ${clinic.logo?`<img src="${escHtml(clinic.logo)}" style="height:50px;margin-bottom:6px;display:block;margin-left:auto;margin-right:auto;object-fit:contain;" alt="Logo">`:''}
    <div style="font-size:16pt;font-weight:bold;letter-spacing:1px;">${escHtml(clinic.header||clinic.name||'CLINIC')}</div>
    <div style="font-size:9pt;margin-top:2px;">${escHtml(clinic.address||'')}</div>
    <div style="font-size:9pt;">Phone: ${escHtml(clinic.phone||'')}${clinic.email?'  |  '+escHtml(clinic.email):''}</div>
  </div>
  <!-- INVOICE META + PATIENT INFO in two-column -->
  <div style="display:flex;justify-content:space-between;font-size:9.5pt;margin-bottom:6px;">
    <div>
      <div><strong>Invoice No :</strong> <strong style="letter-spacing:1px;">${escHtml(d.no||'')}</strong></div>
      <div><strong>Date :</strong> ${escHtml(d.date||'')}</div>
      <div><strong>Type :</strong> ${escHtml(d.type||'General Patient')}</div>
    </div>
    <div style="text-align:right;">
      <div><strong>Phone :</strong> ${escHtml(d.phone||'‚Äî')}</div>
      ${d.age&&d.age!=='‚Äî'?`<div><strong>Age :</strong> ${escHtml(d.age)}</div>`:''}
      ${d.gender&&d.gender!=='‚Äî'?`<div><strong>Gender :</strong> ${escHtml(d.gender)}</div>`:''}
    </div>
  </div>
  <div style="border:1px solid #000;padding:5px 10px;margin-bottom:8px;font-size:9.5pt;">
    <div><strong>Patient Name :</strong> ${escHtml(d.patient||'')}</div>
    ${doctorDisplay?`<div><strong>Referred By :</strong> ${escHtml(doctorDisplay)}</div>`:''}
  </div>
  <div style="text-align:center;font-weight:bold;font-size:8.5pt;margin:4px 0;border-top:1px dashed #000;border-bottom:1px dashed #000;padding:3px 0;">
    INVOICE COPY
  </div>
  <!-- TEST TABLE -->
  <table style="width:100%;border-collapse:collapse;font-size:9.5pt;margin-bottom:6px;">
    <thead>
      <tr style="background:#f0f0f0;">
        <th style="text-align:left;padding:4px 6px;border:1px solid #ccc;width:28px;">SL</th>
        <th style="text-align:left;padding:4px 6px;border:1px solid #ccc;">Particulars</th>
        <th style="text-align:right;padding:4px 6px;border:1px solid #ccc;width:88px;">Amount (‡ß≥)</th>
      </tr>
    </thead>
    <tbody>
      ${(()=>{
        const byCat={};
        tests.forEach(t=>{
          const cat=t.cat||'Others';
          if(!byCat[cat]) byCat[cat]=[];
          byCat[cat].push(t);
        });
        let rows='';let sl=1;
        const catKeys=Object.keys(byCat);
        catKeys.forEach(cat=>{
          if(catKeys.length>1){
            rows+=`<tr><td colspan="3" style="padding:2px 6px;background:#f5f5f5;font-weight:700;font-size:8pt;color:#333;border:1px solid #e0e0e0;">${escHtml(cat)}</td></tr>`;
          }
          byCat[cat].forEach(t=>{
            rows+=`<tr><td style="padding:3px 6px;border:1px solid #ddd;text-align:center;">${sl++}</td><td style="padding:3px 6px;border:1px solid #ddd;">${escHtml(t.name||t)}</td><td style="text-align:right;padding:3px 6px;border:1px solid #ddd;">${(t.price||0).toFixed(2)}</td></tr>`;
          });
        });
        return rows||'<tr><td colspan="3" style="text-align:center;color:#999;">No tests</td></tr>';
      })()}
    </tbody>
  </table>
  <!-- TOTALS -->
  <table style="width:100%;border-collapse:collapse;font-size:9.5pt;margin-bottom:8px;">
    <tr><td style="width:55%"></td><td style="padding:2px 6px;text-align:right;border-top:1px solid #ccc;">Sub Total (Tk.) :</td><td style="padding:2px 6px;text-align:right;border-top:1px solid #ccc;width:90px;">${sub.toFixed(2)}</td></tr>
    <tr><td></td><td style="padding:2px 6px;text-align:right;">Discount (Tk.) :</td><td style="padding:2px 6px;text-align:right;">${disc.toFixed(2)}</td></tr>
    <tr><td></td><td style="padding:2px 6px;text-align:right;border-top:1px solid #ccc;">Net Payable (Tk.) :</td><td style="padding:2px 6px;text-align:right;border-top:1px solid #ccc;">${net.toFixed(2)}</td></tr>
    <tr><td></td><td style="padding:2px 6px;text-align:right;">Total Paid (Tk.) :</td><td style="padding:2px 6px;text-align:right;color:green;">${paid.toFixed(2)}</td></tr>
    <tr style="background:#f8f8f8;"><td></td><td style="padding:4px 6px;text-align:right;font-weight:bold;font-size:11pt;border-top:2px solid #000;border-bottom:2px solid #000;">Due (Tk.) :</td><td style="padding:4px 6px;text-align:right;font-weight:bold;font-size:11pt;border-top:2px solid #000;border-bottom:2px solid #000;color:${due>0?'red':'green'};">${due.toFixed(2)}</td></tr>
  </table>
  ${due>0
    ?`<div style="margin:6px 0;"><span style="font-size:18pt;font-weight:bold;border:3px solid red;color:red;padding:3px 18px;display:inline-block;letter-spacing:3px;">DUE</span></div>`
    :`<div style="margin:6px 0;color:green;font-weight:bold;font-size:11pt;">‚úì PAID IN FULL</div>`
  }
  <!-- FOOTER -->
  <div style="margin-top:16px;border-top:1px dashed #000;padding-top:8px;display:flex;justify-content:space-between;font-size:8.5pt;color:#555;">
    <div>Prepared By : ${escHtml(d.by||'‚Äî')}<br>Software : Asad Kit BD v17</div>
    <div style="text-align:right;">${ts||''}</div>
  </div>
  <div style="margin-top:6px;text-align:center;font-size:7.5pt;color:#999;">
    ‚îÄ‚îÄ‚îÄ Thank you for choosing ${escHtml(clinic.name||'our clinic')} ‚îÄ‚îÄ‚îÄ
  </div>
</div>`;
}

function doPrint(){
  const c=document.getElementById('m-print-body')?.innerHTML;
  if(!c){N('No invoice loaded.',true);return;}
  const clinic=getClinic(S?.cid||'')||{};
  const printSize=clinic.printSize||'long';

  let pageCSS, bodyCSS, extraCSS='';
  if(printSize==='short'){
    // 80mm Thermal ‚Äî auto height, compact, no page break
    pageCSS='size:80mm auto;margin:3mm;';
    bodyCSS='width:74mm;margin:0;padding:0;font-family:Arial,sans-serif;font-size:8.5pt;line-height:1.4;';
    extraCSS=`
      table{width:100%!important;border-collapse:collapse;}
      th,td{font-size:8pt!important;padding:2px 4px!important;}
      div{max-width:74mm;word-wrap:break-word;overflow-wrap:break-word;}
    `;
  } else if(printSize==='custom'){
    // 8√ó12 inch
    pageCSS='size:8in 12in;margin:0;';
    bodyCSS='width:8in;min-height:12in;margin:0;padding:0.5in;font-family:"Times New Roman",serif;font-size:11pt;';
  } else {
    // A4 / Letter ‚Äî MUST stay on ONE page, auto-scale if needed
    pageCSS='size:8.5in 11in;margin:0.5in;';
    bodyCSS='width:7.5in;margin:0;padding:0;font-family:"Times New Roman",serif;font-size:11pt;';
    extraCSS=`
      /* Auto-scale to fit single page */
      @page{size:8.5in 11in;margin:0.5in;}
      html{overflow:hidden;}
      body{transform-origin:top left;}
      /* Prevent page breaks everywhere */
      *{page-break-inside:avoid!important;page-break-before:avoid!important;page-break-after:avoid!important;}
    `;
  }

  const w=window.open('','_blank','width=870,height=1100');
  if(!w){N('Pop-up blocked. Please allow pop-ups to print.',true);return;}
  w.document.write(`<!DOCTYPE html><html><head><title>Invoice ‚Äî Asad Kit BD v17</title>
  <style>
    @page{${pageCSS}}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{${bodyCSS}background:#fff;color:#000;}
    @media print{
      body{${bodyCSS}}
      @page{${pageCSS}}
    }
    table{width:100%;border-collapse:collapse;}
    ${extraCSS}
  </style></head>
  <body onload="if(typeof autoScalePrint==='function')autoScalePrint();setTimeout(()=>{window.print();},500);">
  <script>
  function autoScalePrint(){
    ${printSize!=='short'?`
    var body=document.body;
    var contentH=body.scrollHeight;
    var pageH=11*96-96; // 11in at 96dpi minus 1in margin
    if(contentH>pageH){
      var scale=pageH/contentH;
      if(scale<0.5) scale=0.5;
      body.style.transform='scale('+scale+')';
      body.style.transformOrigin='top left';
      body.style.width=(100/scale)+'%';
    }`:''}
  }
  <\/script>
  ${c}</body></html>`);
  w.document.close();
}

function printDueReceipt(){
  const c=document.getElementById('m-due-receipt-body')?.innerHTML;
  if(!c){return;}
  const clinic=getClinic(S?.cid||'')||{};
  const printSize=clinic.printSize||'long';
  let pageCSS,bodyCSS;
  if(printSize==='short'){
    pageCSS='size:80mm auto;margin:3mm;';
    bodyCSS='width:74mm;margin:0;padding:0;font-family:Arial,sans-serif;font-size:8.5pt;';
  } else {
    pageCSS='size:8.5in 11in;margin:0.5in;';
    bodyCSS='width:7.5in;margin:0;padding:0;font-family:"Times New Roman",serif;font-size:11pt;';
  }
  const w=window.open('','_blank','width=870,height=1100');
  if(!w){N('Pop-up blocked.',true);return;}
  w.document.write(`<!DOCTYPE html><html><head><title>Due Receipt ‚Äî Asad Kit BD v17</title>
  <style>
    @page{${pageCSS}}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{${bodyCSS}background:#fff;color:#000;}
    @media print{body{${bodyCSS}} @page{${pageCSS}}}
    *{page-break-inside:avoid!important;}
  </style></head>
  <body onload="setTimeout(()=>{window.print();window.close();},500);">${c}</body></html>`);
  w.document.close();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REVIEW SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function reviewInvoice(invId){
  const inv=DB.findOne('invoices',i=>i.id===invId);
  if(!inv){N('Invoice not found.',true);return;}
  const clinic=getClinic(inv.cid)||{};
  // Resolve test IDs to full test objects
  const tests=inv.tests.map(tid=>{
    const t=getTestById(tid);
    return t||{name:tid,price:0,cat:'Unknown'};// fallback: show ID if test deleted
  });
  reviewInvId=invId;
  const net=(inv.subtotal||0)-(inv.discount||0);
  const dLog=DB.get('due_log').filter(d=>d.invId===invId);
  // Build doctor display: name first, degree after, never show code
  const docDisplay=(()=>{
    const docField=inv.doctor||inv.docName||'';
    return docField||'‚Äî';
  })();
  document.getElementById('m-review-body').innerHTML=`
  <div style="background:#fff;color:#000;padding:16px;border-radius:6px;">
    ${buildInvoiceHTML({...inv,tests,sub:inv.subtotal,disc:inv.discount,net,clinic,by:inv.by,doctor:docDisplay},'','') }
  </div>
  ${dLog.length?`
  <div style="margin-top:12px;background:rgba(6,214,160,.06);border:1px solid rgba(6,214,160,.2);border-radius:7px;padding:12px;font-size:12px;">
    <div style="color:var(--green);font-weight:700;margin-bottom:8px;">üí∞ Collection History</div>
    ${dLog.map(d=>`<div style="display:flex;gap:16px;padding:4px 0;border-bottom:1px solid rgba(0,0,0,.05);">
      <span style="color:var(--green);font-family:var(--mono)">${d.rcNo||'‚Äî'}</span>
      <span>‡ß≥${d.amount.toLocaleString()} collected</span>
      <span style="color:var(--text2)">${d.date}</span>
      <span style="color:var(--text2)">by ${d.by}</span>
      <span>Remaining: <strong style="color:${d.remainDue>0?'var(--red)':'var(--green)'}">‡ß≥${d.remainDue}</strong></span>
    </div>`).join('')}
  </div>`:''}
  <div style="margin-top:12px;padding:10px;background:rgba(0,180,216,.06);border:1px solid rgba(0,180,216,.18);border-radius:7px;font-size:11px;color:var(--text2);">
    <strong style="color:var(--teal)">Invoice Details</strong><br>
    ID: <code style="color:var(--text)">${inv.id}</code> &nbsp;|&nbsp;
    Created: ${new Date(inv.createdAt||'').toLocaleString('en-GB')} &nbsp;|&nbsp;
    By: ${escHtml(inv.by)} &nbsp;|&nbsp;
    Status: <span style="color:${inv.due>0?'var(--red)':'var(--green)'};">${(inv.status||'').toUpperCase()}</span>
  </div>
  <div style="margin-top:10px;">
    <button class="btn btn-o btn-sm" onclick="openEditPatient('${invId}','invoices')">‚úèÔ∏è Edit Patient Info</button>
  </div>`;
  openModal('m-review');
}
function printCurrentReview(){
  if(!reviewInvId){N('No invoice loaded.',true);return;}
  const inv=DB.findOne('invoices',i=>i.id===reviewInvId);
  if(!inv){N('Invoice not found.',true);return;}
  const clinic=getClinic(inv.cid)||{};
  const tests=inv.tests.map(tid=>{const t=getTestById(tid);return t||{name:tid,price:0,cat:'Unknown'};});
  const docDisplay=inv.doctor||inv.docName||'';
  buildPrint({...inv,tests,sub:inv.subtotal,disc:inv.discount,net:inv.subtotal-inv.discount,clinic,by:inv.by,doctor:docDisplay}, '');
  closeModal('m-review');
  setTimeout(doPrint,300);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVOICE LIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rInvList(){
  const invs=myInvs();
  document.getElementById('wsBody').innerHTML=`
  <div class="bar">
    <input id="isq" placeholder="Search invoice ID / patient / phone..." oninput="fInvs()" style="flex:1;">
    <span style="font-size:11px;color:var(--text2)">${invs.length} record(s)</span>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Invoice No</th><th>Date</th><th>Patient</th><th>Tests</th><th>Total</th><th>Discount</th><th>Paid</th><th>Due</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody id="invTb">${buildInvRows(invs)}</tbody>
  </table></div>`;
}
function buildInvRows(data){
  return data.map(v=>`<tr>
    <td style="font-family:var(--mono);color:var(--teal);white-space:nowrap">${v.no}</td>
    <td>${v.date}</td>
    <td style="font-weight:500">${escHtml(v.patient)}</td>
    <td style="font-size:11px;color:var(--text2)">${v.tests.length} test(s)</td>
    <td style="font-family:var(--mono)">‡ß≥${v.subtotal.toLocaleString()}</td>
    <td style="font-family:var(--mono);color:var(--amber)">‡ß≥${(v.discount||0).toLocaleString()}</td>
    <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
    <td><span class="badge ${v.due>0?'b-due':'b-active'}">‡ß≥${v.due.toLocaleString()}</span></td>
    <td><span class="badge ${v.status==='paid'?'b-active':'b-due'}">${(v.status||'').toUpperCase()}</span></td>
    <td style="white-space:nowrap">
      <button class="btn btn-o btn-sm" onclick="reviewInvoice('${v.id}')">üëÅ Review</button>
      <button class="btn btn-t btn-sm" onclick="printInv('${v.id}')">üñ®</button>
      ${canDeleteInv()?`<button class="btn btn-r btn-sm" onclick="deleteInvoice('${v.id}')">üóë</button>`:''}
    </td>
  </tr>`).join('')||`<tr><td colspan="10" style="text-align:center;color:var(--text2);padding:20px;">No invoices.</td></tr>`;
}
function fInvs(){
  const q=(document.getElementById('isq')?.value||'').trim().toLowerCase();
  const tb=document.getElementById('invTb');
  if(tb) tb.innerHTML=buildInvRows(myInvs().filter(v=>
    v.no.toLowerCase().includes(q)||
    v.patient.toLowerCase().includes(q)||
    (v.phone||'').includes(q)||
    (v.doctor||'').toLowerCase().includes(q)||
    (v.docName||'').toLowerCase().includes(q)
  ));
}
function printInv(id){
  const inv=DB.findOne('invoices',i=>i.id===id); if(!inv) return;
  const clinic=getClinic(inv.cid)||{};
  const tests=inv.tests.map(tid=>{const t=getTestById(tid);return t||{name:tid,price:0,cat:'Unknown'};});
  const docDisplay=inv.doctor||inv.docName||'';
  buildPrint({...inv,tests,sub:inv.subtotal,disc:inv.discount,net:inv.subtotal-inv.discount,clinic,by:inv.by,doctor:docDisplay}, '');
  openModal('m-print');
}
async function deleteInvoice(id){
  if(!canDeleteInv()){N('Only Super Admin can delete invoices.',true);return;}
  if(!confirm('Delete this invoice permanently?')) return;
  try{ DB.delete('invoices',i=>i.id===id); N('Invoice deleted.'); rInvList(); }
  catch(e){ N('Delete failed: '+e.message,true); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ID SEARCH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rIdSearch(){
  document.getElementById('wsBody').innerHTML=`
  <div class="box" style="max-width:680px;">
    <div class="box-title">Search by Invoice ID or Receipt ID</div>
    <p style="font-size:12px;color:var(--text2);margin-bottom:14px;">Works for all years ‚Äî even 5-10 year old records. Exact match: <strong>2026-1</strong>. Copy-paste supported.</p>
    <div style="display:flex;gap:10px;margin-bottom:14px;">
      <div class="fi" style="flex:1;margin-bottom:0;">
        <label>Invoice ID or Receipt ID</label>
        <input id="ws_ids_q" placeholder="e.g. 2026-1 or RC-2026-1"
          onkeydown="if(event.key==='Enter')wsIdSearch()"
          style="font-family:var(--mono);letter-spacing:.05em;">
      </div>
      <div style="align-self:flex-end;"><button class="btn btn-t" onclick="wsIdSearch()">üîç Search</button></div>
    </div>
    <div id="ws_ids_result"></div>
  </div>`;
}
function wsIdSearch(){
  const raw=document.getElementById('ws_ids_q')?.value||'';
  const q=raw.replace(/[\u200B-\u200D\uFEFF]/g,'').replace(/\s+/g,' ').trim();
  const el=document.getElementById('ws_ids_result');
  if(!el||!q){N('Enter an ID to search.',true);return;}
  const result=searchById(q,S.cid);
  el.innerHTML=renderIdSearchResult(result);
  if(!result) N('No record found for: '+q,true);
}
function doIdSearch(){
  const raw=document.getElementById('ids_q')?.value||'';
  const q=raw.replace(/[\u200B-\u200D\uFEFF]/g,'').replace(/\s+/g,' ').trim();
  const el=document.getElementById('ids_result');
  if(!el||!q){N('Enter an ID to search.',true);return;}
  const result=searchById(q,S?.cid);
  el.innerHTML=renderIdSearchResult(result);
  if(!result) N('No record found for: '+q,true);
}
function saSearch(){
  const q=(document.getElementById('sa_search')?.value||'').trim();
  const el=document.getElementById('sa_search_result');
  if(!el||!q){N('Enter an ID.',true);return;}
  const result=searchById(q,null);
  el.innerHTML=renderIdSearchResult(result);
}
function searchById(q,cid){
  if(!q) return null;
  const qn = q.replace(/[\u200B-\u200D\uFEFF]/g,'').replace(/\s+/g,' ').trim();
  if(!qn) return null;
  const qNorm = normalizeInvNo(qn);
  const qLow = qNorm.toLowerCase();

  // Helper: match by normalized invoice number or id
  const findInTable = (tbl) => {
    const list = DB.get(tbl).filter(i => cid ? i.cid===cid : true);
    return list.find(i => normalizeInvNo(i.no||'')===qNorm) ||
           list.find(i => normalizeInvNo(i.no||'').toLowerCase()===qLow) ||
           list.find(i => i.id===qn);
  };

  // ‚îÄ‚îÄ 1. Pathology invoices (search first ‚Äî all YYYY-N invoices may be here) ‚îÄ‚îÄ
  const pathInv = findInTable('pathology_invoices');
  if(pathInv){
    const items = DB.get('pathology_invoice_items').filter(item=>item.pathInvId===pathInv.id);
    return {type:'path_invoice', inv:pathInv, items};
  }

  // ‚îÄ‚îÄ 2. Lab invoices ‚îÄ‚îÄ
  const inv = findInTable('invoices');
  if(inv) return {type:'invoice', inv};

  // ‚îÄ‚îÄ 3. Due/receipt log ‚îÄ‚îÄ
  const log = DB.findOne('due_log', d =>
    String(d.rcNo||'').trim() === qn ||
    String(d.rcNo||'').trim().toLowerCase() === qLow
  );
  if(log){
    const relInv = DB.findOne('invoices', i => i.id===log.invId && (cid ? i.cid===cid : true));
    if(relInv) return {type:'receipt', log, inv:relInv};
  }

  // ‚îÄ‚îÄ 4. OPD invoices ‚îÄ‚îÄ
  const opdInv = findInTable('opd_invoices');
  if(opdInv) return {type:'opd_invoice', inv:opdInv};

  return null;
}
function renderIdSearchResult(result){
  if(!result) return `<div style="color:var(--red);font-size:13px;padding:10px;">‚ùå Invoice not found.</div>`;
  if(result.type==='path_invoice'){
    const inv=result.inv;
    const items=result.items||[];
    const docDisplay=(inv.doctorName&&inv.doctorDegree)?`${escHtml(inv.doctorName)}, ${escHtml(inv.doctorDegree)}`:(inv.doctorName?escHtml(inv.doctorName):'‚Äî');
    return`<div style="border:1px solid rgba(160,32,240,.3);border-radius:8px;overflow:hidden;">
      <div style="background:rgba(109,40,217,.07);padding:10px 14px;display:flex;justify-content:space-between;align-items:center;">
        <span style="font-size:13px;font-weight:700;color:var(--purple)">üî¨ Pathology Invoice: ${escHtml(inv.no)}</span>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-o btn-sm" onclick="reviewPathInvoice('${inv.id}')">üëÅ Review</button>
          <button class="btn btn-t btn-sm" onclick="reprintPathInvoice('${inv.id}')">üñ® Print</button>
        </div>
      </div>
      <div style="padding:14px;font-size:12px;">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:8px;">
          <div><strong>Patient</strong><br><span style="font-weight:600;">${escHtml(inv.patient)}</span></div>
          <div><strong>Patient ID</strong><br>${escHtml(inv.patientId||'‚Äî')}</div>
          <div><strong>Date</strong><br>${escHtml(inv.date||'‚Äî')}</div>
          <div><strong>Doctor</strong><br>${docDisplay}</div>
        </div>
        <div style="margin-bottom:8px;">
          <strong>Tests (${items.length}):</strong><br>
          <table style="width:100%;border-collapse:collapse;font-size:11px;margin-top:4px;">
            <thead><tr style="background:#f0f0f0;"><th style="padding:3px 6px;border:1px solid #ddd;text-align:left;">SL</th><th style="padding:3px 6px;border:1px solid #ddd;text-align:left;">Test Name</th><th style="padding:3px 6px;border:1px solid #ddd;text-align:center;">Qty</th><th style="padding:3px 6px;border:1px solid #ddd;text-align:right;">Unit Price</th><th style="padding:3px 6px;border:1px solid #ddd;text-align:right;">Total</th></tr></thead>
            <tbody>${items.map((item,i)=>`<tr><td style="padding:3px 6px;border:1px solid #eee;text-align:center;">${i+1}</td><td style="padding:3px 6px;border:1px solid #eee;">${escHtml(item.testName||'')}</td><td style="padding:3px 6px;border:1px solid #eee;text-align:center;">${item.qty||1}</td><td style="padding:3px 6px;border:1px solid #eee;text-align:right;">‡ß≥${(item.unitPrice||0).toFixed(2)}</td><td style="padding:3px 6px;border:1px solid #eee;text-align:right;">‡ß≥${(item.lineTotal||0).toFixed(2)}</td></tr>`).join('')||'<tr><td colspan="5" style="text-align:center;color:#999;padding:8px;">No items</td></tr>'}</tbody>
          </table>
        </div>
        <div style="display:flex;gap:20px;font-family:var(--mono);">
          <span>Total: <strong style="color:var(--teal)">‡ß≥${(inv.subtotal||0).toLocaleString()}</strong></span>
          <span>Paid: <strong style="color:var(--green)">‡ß≥${(inv.paid||0).toLocaleString()}</strong></span>
          <span>Due: <strong style="color:${(inv.due||0)>0?'var(--red)':'var(--green)'}">‡ß≥${(inv.due||0).toLocaleString()}</strong></span>
          ${inv.void?`<span class="badge b-warn">VOIDED</span>`:`<span class="badge ${inv.status==='paid'?'b-active':'b-due'}">${(inv.status||'').toUpperCase()}</span>`}
        </div>
      </div>
    </div>`;
  }
  if(result.type==='invoice'){
    const inv=result.inv;
    const clinic=getClinic(inv.cid)||{};
    const tests=inv.tests.map(tid=>getTestById(tid)).filter(Boolean);
    return`<div style="border:1px solid rgba(0,180,216,.3);border-radius:8px;overflow:hidden;">
      <div style="background:rgba(0,180,216,.08);padding:10px 14px;display:flex;justify-content:space-between;align-items:center;">
        <span style="font-size:13px;font-weight:600;color:var(--teal)">‚úì Invoice Found: ${inv.no}</span>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-o btn-sm" onclick="reviewInvoice('${inv.id}')">üëÅ Review</button>
          <button class="btn btn-t btn-sm" onclick="printInv('${inv.id}')">üñ® Print</button>
        </div>
      </div>
      <div style="padding:14px;font-size:12px;">
        <div class="f2" style="gap:8px;margin-bottom:8px;">
          <div><strong style="color:var(--gray)">Patient</strong><br><span style="font-size:13px;font-weight:600;">${escHtml(inv.patient)}</span></div>
          <div><strong style="color:var(--gray)">Date</strong><br>${inv.date}</div>
          <div><strong style="color:var(--gray)">Phone</strong><br>${inv.phone}</div>
          <div><strong style="color:var(--gray)">Type</strong><br>${inv.type}</div>
        </div>
      <div style="margin-bottom:8px;"><strong style="color:var(--gray)">Tests (${tests.length})</strong><br>
          ${tests.map(t=>escHtml(t.name||t)).join(' ¬∑ ')||'‚Äî'}
        </div>
        <div style="display:flex;gap:20px;font-family:var(--mono);">
          <span>Total: <strong style="color:var(--teal)">‡ß≥${inv.subtotal.toLocaleString()}</strong></span>
          <span>Paid: <strong style="color:var(--green)">‡ß≥${inv.paid.toLocaleString()}</strong></span>
          <span>Due: <strong style="color:${inv.due>0?'var(--red)':'var(--green)'}">‡ß≥${inv.due.toLocaleString()}</strong></span>
          <span class="badge ${inv.status==='paid'?'b-active':'b-due'}">${(inv.status||'').toUpperCase()}</span>
        </div>
      </div>
    </div>`;
  }
  if(result.type==='receipt'){
    const {log,inv}=result;
    return`<div style="border:1px solid rgba(6,214,160,.3);border-radius:8px;overflow:hidden;">
      <div style="background:rgba(6,214,160,.06);padding:10px 14px;display:flex;justify-content:space-between;align-items:center;">
        <span style="font-size:13px;font-weight:600;color:var(--green)">‚úì Receipt Found: ${log.rcNo}</span>
        <button class="btn btn-t btn-sm" onclick="reviewInvoice('${inv.id}')">üëÅ View Invoice</button>
      </div>
      <div style="padding:14px;font-size:12px;">
        <strong style="color:var(--gray)">Patient</strong>: ${escHtml(inv.patient)}<br>
        <strong style="color:var(--gray)">Invoice</strong>: ${inv.no} &nbsp;|&nbsp;
        <strong style="color:var(--gray)">Collection Date</strong>: ${log.date}<br>
        <strong style="color:var(--gray)">Collected</strong>: <span style="color:var(--green);font-family:var(--mono);">‡ß≥${log.amount.toLocaleString()}</span> &nbsp;|&nbsp;
        <strong style="color:var(--gray)">Remaining Due</strong>: <span style="color:${log.remainDue>0?'var(--red)':'var(--green)'};font-family:var(--mono);">‡ß≥${log.remainDue.toLocaleString()}</span>
      </div>
    </div>`;
  }
  return '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DUE COLLECTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rDueColl(){
  const dues=myInvs().filter(i=>i.due>0);
  const log=DB.get('due_log').filter(d=>{
    const inv=DB.findOne('invoices',i=>i.id===d.invId);
    return inv?.cid===S?.cid;
  });
  document.getElementById('wsBody').innerHTML=`
  <div class="box">
    <div class="box-title">Pending Dues</div>
    ${dues.length===0?'<p style="color:var(--green);font-size:13px;">‚úì No pending dues. All invoices settled.</p>':''}
    ${dues.length>0?`<div class="tbl-wrap"><table>
      <thead><tr><th>Invoice</th><th>Date</th><th>Patient</th><th>Total</th><th>Paid</th><th>Due</th><th>Actions</th></tr></thead>
      <tbody>${dues.map(v=>`<tr>
        <td style="font-family:var(--mono);color:var(--teal)">${v.no}</td><td>${v.date}</td>
        <td style="font-weight:500">${escHtml(v.patient)}</td>
        <td style="font-family:var(--mono)">‡ß≥${v.subtotal.toLocaleString()}</td>
        <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
        <td style="font-family:var(--mono);color:var(--red);font-weight:700;">‡ß≥${v.due.toLocaleString()}</td>
        <td style="white-space:nowrap">
          <button class="btn btn-o btn-sm" onclick="reviewInvoice('${v.id}')">üëÅ</button>
          <button class="btn btn-t btn-sm" onclick="openDue('${v.id}',false)">üí∞ Pay Due</button>
          <button class="btn btn-g btn-sm" onclick="openDue('${v.id}',true)">‚úì Full Pay</button>
        </td>
      </tr>`).join('')}</tbody>
    </table></div>`:''
    }
  </div>
  <div class="box">
    <div class="box-title">Collection History</div>
    ${log.length===0?'<p style="color:var(--gray);font-size:13px;">No collection records.</p>':''}
    ${log.length>0?`<div class="tbl-wrap"><table>
      <thead><tr><th>Receipt No</th><th>Invoice</th><th>Patient</th><th>Collected</th><th>Prev Due</th><th>Remaining</th><th>Date</th><th>By</th><th>Actions</th></tr></thead>
      <tbody>${log.map(d=>{const inv=DB.findOne('invoices',i=>i.id===d.invId);return`<tr>
        <td style="font-family:var(--mono);color:var(--green)">${d.rcNo||'‚Äî'}</td>
        <td style="font-family:var(--mono);color:var(--teal)">${inv?.no||d.invId}</td>
        <td style="font-weight:500">${escHtml(inv?.patient||'‚Äî')}</td>
        <td style="font-family:var(--mono);color:var(--green)">‡ß≥${d.amount.toLocaleString()}</td>
        <td style="font-family:var(--mono);color:var(--amber)">‡ß≥${(d.prevDue||0).toLocaleString()}</td>
        <td><span class="badge ${(d.remainDue||0)>0?'b-due':'b-active'}">‡ß≥${(d.remainDue||0).toLocaleString()}</span></td>
        <td>${d.date}</td><td>${escHtml(d.by)}</td>
        <td style="white-space:nowrap">
          ${inv?`<button class="btn btn-o btn-sm" onclick="reviewInvoice('${inv.id}')">üëÅ</button>`:'‚Äî'}
          <button class="btn btn-g btn-sm" onclick="printDueLog('${d.id}')">üñ®</button>
        </td>
      </tr>`;}).join('')}</tbody>
    </table></div>`:''
    }
  </div>`;
}
function openDue(id,fullPay){
  dueInv=DB.findOne('invoices',i=>i.id===id); if(!dueInv) return;
  const clinic=getClinic(dueInv.cid)||{};
  const tests=dueInv.tests.map(tid=>{const t=getTestById(tid);return t||{name:tid,price:0};});
  document.getElementById('m-due-info').innerHTML=
    `<strong>${escHtml(dueInv.patient)}</strong> &nbsp;|&nbsp; <span style="color:var(--teal);font-family:var(--mono)">${dueInv.no}</span> &nbsp;|&nbsp; ${dueInv.date}<br>
     Phone: ${dueInv.phone||'‚Äî'} &nbsp;|&nbsp; Age: ${dueInv.age||'‚Äî'} &nbsp;|&nbsp; Gender: ${dueInv.gender||'‚Äî'}<br>
     Total Bill: <span style="font-family:var(--mono)">‡ß≥${dueInv.subtotal.toLocaleString()}</span> &nbsp;|&nbsp;
     Paid: <span style="color:var(--green);font-family:var(--mono)">‡ß≥${dueInv.paid.toLocaleString()}</span> &nbsp;|&nbsp;
     Outstanding: <span style="color:var(--red);font-weight:700;font-family:var(--mono)">‡ß≥${dueInv.due.toLocaleString()}</span>`;
  // Show full original bill in due collection
  document.getElementById('m-due-bill').innerHTML=`
    <div style="font-size:11px;color:var(--text2);margin-bottom:4px;text-transform:uppercase;letter-spacing:.08em;">Original Test List</div>
    ${tests.map((t,i)=>`<div style="display:flex;justify-content:space-between;padding:3px 8px;font-size:12px;background:rgba(255,255,255,.03);border-radius:3px;margin-bottom:2px;">
      <span>${i+1}. ${escHtml(t.name)}</span>
      <span style="font-family:var(--mono);color:var(--teal)">‡ß≥${t.price}</span>
    </div>`).join('')}`;
  const amt=document.getElementById('m-due-amt');
  if(fullPay){amt.value=dueInv.due;amt.readOnly=true;}
  else{amt.value='';amt.readOnly=false;}
  openModal('m-due');
}
async function submitDue(){
  if(!dueInv) return;
  const a=parseFloat(document.getElementById('m-due-amt')?.value||0);
  if(a<=0){N('Enter a valid amount.',true);return;}
  if(a>dueInv.due){N(`Cannot exceed due of ‡ß≥${dueInv.due}.`,true);return;}
  const btn=document.querySelector('#m-due .btn-t');
  if(btn){btn.textContent='‚è≥ Processing‚Ä¶';btn.disabled=true;}
  try{
    const prevDue=dueInv.due, newDue=parseFloat((prevDue-a).toFixed(2));
    const newPaid=parseFloat((dueInv.paid+a).toFixed(2));
    const newStatus=newDue<=0?'paid':'due';
    const today=new Date().toISOString().split('T')[0];
    const rcNo=nextRcNo(S.cid);
    const logEntry={
      id:uid(), invId:dueInv.id, rcNo,
      invoiceNo:dueInv.no,
      invoiceType:dueInv._type||'LAB',
      amount:a, prevDue, remainDue:newDue,
      date:today,
      by:S.u, byName:S.name||S.u,
      receivedBy:S.u,
      receivedByName:S.name||S.u,
      receiveDate:today,
      location:getClinic(S.cid)?.name||'',
      collectedAt:new Date().toISOString(),
      note:newDue<=0?'Fully paid':'Partial payment'
    };
    DB.update('invoices',i=>i.id===dueInv.id,{paid:newPaid,due:newDue,status:newStatus});
    DB.insert('due_log',logEntry);
    // ‚îÄ‚îÄ Save to user_collections for unified tracking ‚îÄ‚îÄ
    DB.insert('user_collections',{
      id:uid(), cid:S.cid,
      invoiceNo:dueInv.no, invoiceId:dueInv.id,
      invoiceType:dueInv._type||'LAB',
      module:dueInv._type==='PATH'?'Pathology':dueInv._type==='OPD'?'OPD':'Lab',
      patient:dueInv.patient,
      amount:a,
      receivedBy:S.u,
      receivedByName:S.name||S.u,
      receiveDate:today,
      location:getClinic(S.cid)?.name||'',
      note:newDue<=0?'Due fully cleared':'Partial due payment',
      rcNo,
      createdAt:new Date().toISOString()
    });
    lastDueLog=logEntry;
    closeModal('m-due');
    N(`‚úì ‡ß≥${a.toLocaleString()} collected. Receipt: ${rcNo}.`);
    // Show due collection receipt
    showDueReceipt(logEntry,dueInv);
    rDueColl();
  }catch(e){
    N('Collection failed: '+e.message,true);
  }finally{
    if(btn){btn.textContent='Confirm & Collect';btn.disabled=false;}
    document.getElementById('m-due-amt').readOnly=false;
  }
}

function showDueReceipt(log,inv){
  const clinic=getClinic(inv.cid)||{};
  const tests=inv.tests.map(tid=>{const t=getTestById(tid);return t||{name:tid,price:0};});
  const html=buildDueReceiptHTML(log,inv,tests,clinic);
  document.getElementById('m-due-receipt-body').innerHTML=html;
  openModal('m-due-receipt');
}
function buildDueReceiptHTML(log,inv,tests,clinic){
  const now=new Date();
  const ts=`${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()} ${now.toLocaleTimeString('en-GB')}`;
  return`<div style="width:100%;font-family:'Times New Roman',Times,serif;font-size:11pt;color:#000;background:#fff;">
  <div style="text-align:center;border-bottom:2px double #000;padding-bottom:10px;margin-bottom:10px;">
    <div style="font-size:16pt;font-weight:bold;">${escHtml(clinic.header||clinic.name||'CLINIC')}</div>
    <div style="font-size:9pt;">${escHtml(clinic.address||'')}</div>
    <div style="font-size:9pt;">Phone: ${escHtml(clinic.phone||'')}</div>
  </div>
  <div style="text-align:center;font-weight:bold;font-size:12pt;border-bottom:1px dashed #000;margin-bottom:8px;padding-bottom:6px;">
    DUE COLLECTION RECEIPT
  </div>
  <div style="display:flex;justify-content:space-between;font-size:9.5pt;margin-bottom:8px;">
    <div>
      <div><strong>Receipt No :</strong> ${escHtml(log.rcNo||'')}</div>
      <div><strong>Date :</strong> ${log.date}</div>
    </div>
    <div style="text-align:right;">
      <div><strong>Against Invoice :</strong> ${escHtml(inv.no)}</div>
    </div>
  </div>
  <div style="border:1px solid #000;padding:6px 10px;margin-bottom:8px;font-size:9.5pt;">
    <div><strong>Patient Name :</strong> ${escHtml(inv.patient)}</div>
    <div style="display:flex;gap:16px;">
      <span><strong>Age :</strong> ${escHtml(inv.age||'‚Äî')}</span>
      <span><strong>Gender :</strong> ${escHtml(inv.gender||'‚Äî')}</span>
      <span><strong>Phone :</strong> ${escHtml(inv.phone||'‚Äî')}</span>
    </div>
  </div>
  <div style="border-top:1px dashed #000;border-bottom:1px dashed #000;padding:6px 0;margin-bottom:8px;font-size:9pt;">
    <div style="font-weight:bold;margin-bottom:4px;">Original Tests:</div>
    ${tests.map((t,i)=>`<div style="display:flex;justify-content:space-between;padding:2px 4px;">
      <span>${i+1}. ${escHtml(t.name)}</span>
      <span>‡ß≥${t.price.toFixed(2)}</span>
    </div>`).join('')}
  </div>
  <table style="width:100%;border-collapse:collapse;font-size:9.5pt;">
    <tr><td style="padding:2px 4px;">Sub Total (Tk.) :</td><td style="text-align:right;padding:2px 4px;">‡ß≥${inv.subtotal.toFixed(2)}</td></tr>
    <tr><td style="padding:2px 4px;">Discount (Tk.) :</td><td style="text-align:right;padding:2px 4px;">‡ß≥${(inv.discount||0).toFixed(2)}</td></tr>
    <tr><td style="padding:2px 4px;">Net Payable (Tk.) :</td><td style="text-align:right;padding:2px 4px;">‡ß≥${(inv.subtotal-inv.discount).toFixed(2)}</td></tr>
    <tr><td style="padding:2px 4px;border-top:1px dashed #000;">Previous Due (Tk.) :</td><td style="text-align:right;padding:2px 4px;border-top:1px dashed #000;">‡ß≥${log.prevDue.toFixed(2)}</td></tr>
    <tr style="background:#f8f8f8;">
      <td style="padding:4px;font-weight:bold;font-size:11pt;">Amount Collected (Tk.) :</td>
      <td style="text-align:right;padding:4px;font-weight:bold;font-size:11pt;color:green;">‡ß≥${log.amount.toFixed(2)}</td>
    </tr>
    <tr>
      <td style="padding:2px 4px;font-weight:bold;border-top:1px dashed #000;">Remaining Due (Tk.) :</td>
      <td style="text-align:right;padding:2px 4px;font-weight:bold;border-top:1px dashed #000;color:${log.remainDue>0?'red':'green'};">‡ß≥${log.remainDue.toFixed(2)}</td>
    </tr>
  </table>
  ${log.remainDue<=0?`<div style="margin:10px 0;color:green;font-weight:bold;font-size:12pt;">‚úì FULLY SETTLED</div>`:''}
  <div style="margin-top:30px;border-top:1px dashed #000;padding-top:8px;display:flex;justify-content:space-between;font-size:8.5pt;color:#555;">
    <div>Collected By: ${escHtml(log.by)}<br>Software: Asad Kit BD v17</div>
    <div style="text-align:right;">${ts}</div>
  </div>
</div>`;
}
function printDueLog(dlId){
  const log=DB.findOne('due_log',d=>d.id===dlId); if(!log) return;
  const inv=DB.findOne('invoices',i=>i.id===log.invId); if(!inv) return;
  const clinic=getClinic(inv.cid)||{};
  const tests=inv.tests.map(tid=>getTestById(tid)).filter(Boolean);
  document.getElementById('m-due-receipt-body').innerHTML=buildDueReceiptHTML(log,inv,tests,clinic);
  openModal('m-due-receipt');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PATIENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rPatList(){
  document.getElementById('wsBody').innerHTML=`
  <div class="bar">
    <input id="psq" placeholder="Search by name or ID..." oninput="fPats()" style="flex:1;">
    <button class="btn btn-t btn-sm" onclick="swTab(document.querySelectorAll('.ws-tab')[1],'patients',1)">+ Register Patient</button>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>ID</th><th>Name</th><th>Phone</th><th>Age</th><th>Gender</th><th>Blood</th><th>Reg. Date</th><th>Actions</th></tr></thead>
    <tbody id="patTb">${buildPatRows(myPats())}</tbody>
  </table></div>`;
}
function buildPatRows(data){
  return data.map(p=>`<tr>
    <td style="font-family:var(--mono);color:var(--teal)">${p.id}</td>
    <td style="font-weight:500">${escHtml(p.name)}</td><td>${p.phone}</td>
    <td>${p.age} Y</td><td>${p.gender}</td>
    <td><span class="badge b-paid">${p.blood||'‚Äî'}</span></td>
    <td>${p.reg}</td>
    <td><button class="btn btn-o btn-sm" onclick="openEditPatientById('${p.id}')">‚úèÔ∏è Edit</button></td>
  </tr>`).join('')||`<tr><td colspan="8" style="text-align:center;color:var(--text2);padding:20px;">No patients registered.</td></tr>`;
}
function fPats(){
  const q=(document.getElementById('psq')?.value||'').toLowerCase();
  const tb=document.getElementById('patTb');
  if(tb) tb.innerHTML=buildPatRows(myPats().filter(p=>p.name.toLowerCase().includes(q)||p.id.toLowerCase().includes(q)));
}
function rPatReg(){
  document.getElementById('wsBody').innerHTML=`
  <div class="box" style="max-width:680px;">
    <div class="box-title">Register New Patient</div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Full Name *</label><input id="rp_n" placeholder="Patient full name" autofocus></div>
      <div class="fi"><label>Phone</label><input id="rp_ph" placeholder="01X00-000000"></div>
    </div>
    <div class="f4" style="margin-bottom:12px;">
      <div class="fi"><label>Age</label><input id="rp_a" type="number" placeholder="Years"></div>
      <div class="fi"><label>Gender</label><select id="rp_g"><option>Male</option><option>Female</option><option>Other</option></select></div>
      <div class="fi"><label>Blood Group</label><select id="rp_b"><option>‚Äî</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option></select></div>
      <div class="fi"><label>Date</label><input type="date" id="rp_d" value="${new Date().toISOString().split('T')[0]}"></div>
    </div>
    <div class="action-row">
      <button class="btn btn-t" onclick="savePat()">üíæ Register</button>
      <button class="btn btn-r" onclick="rPatReg()">‚úï Clear</button>
    </div>
  </div>`;
}
function savePat(){
  const name=document.getElementById('rp_n')?.value?.trim();
  if(!name){N('Patient name is required.',true);return;}
  try{
    const pats=myPats();
    const id=`P-${String(pats.length+1).padStart(3,'0')}`;
    DB.insert('patients',{
      id,name,cid:S.cid,
      phone:document.getElementById('rp_ph')?.value||'',
      age:document.getElementById('rp_a')?.value||'',
      gender:document.getElementById('rp_g')?.value||'',
      blood:document.getElementById('rp_b')?.value||'',
      reg:document.getElementById('rp_d')?.value||new Date().toISOString().split('T')[0]
    });
    N(`‚úì Patient ${id} registered.`); rPatReg();
  }catch(e){N('Failed: '+e.message,true);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDIT PATIENT (v17) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openEditPatientById(patId){
  const p=DB.findOne('patients',x=>x.id===patId&&x.cid===S.cid);
  if(!p){N('Patient not found.',true);return;}
  document.getElementById('ep_pat_id').value=p.id;
  document.getElementById('ep_inv_id').value='';
  document.getElementById('ep_inv_table').value='';
  document.getElementById('ep_name').value=p.name||'';
  document.getElementById('ep_phone').value=p.phone||'';
  document.getElementById('ep_age').value=p.age||'';
  document.getElementById('ep_gender').value=p.gender||'';
  document.getElementById('ep_doctor').value='';
  document.getElementById('ep_reference').value='';
  openModal('m-edit-patient');
}
function openEditPatient(invId, invTable){
  let inv=null;
  if(invTable==='invoices') inv=DB.findOne('invoices',i=>i.id===invId);
  else if(invTable==='opd_invoices') inv=DB.findOne('opd_invoices',i=>i.id===invId);
  else if(invTable==='pathology_invoices') inv=DB.findOne('pathology_invoices',i=>i.id===invId);
  if(!inv){N('Invoice not found.',true);return;}
  const p=DB.findOne('patients',x=>x.name.toLowerCase()===inv.patient.toLowerCase()&&x.cid===S.cid);
  document.getElementById('ep_pat_id').value=p?.id||'';
  document.getElementById('ep_inv_id').value=invId;
  document.getElementById('ep_inv_table').value=invTable;
  document.getElementById('ep_name').value=inv.patient||'';
  document.getElementById('ep_phone').value=inv.phone||'';
  document.getElementById('ep_age').value=inv.age||'';
  document.getElementById('ep_gender').value=inv.gender||'';
  document.getElementById('ep_doctor').value=inv.docName||inv.doctorName||'';
  document.getElementById('ep_reference').value='';
  openModal('m-edit-patient');
}
function savePatientEdit(){
  const name=document.getElementById('ep_name').value.trim();
  if(!name){N('Patient name is required.',true);return;}
  const patId=document.getElementById('ep_pat_id').value;
  const invId=document.getElementById('ep_inv_id').value;
  const invTable=document.getElementById('ep_inv_table').value;
  const phone=document.getElementById('ep_phone').value.trim();
  const age=document.getElementById('ep_age').value.trim();
  const gender=document.getElementById('ep_gender').value.trim();
  const doctor=document.getElementById('ep_doctor').value.trim();
  try{
    // Update patient record
    if(patId){
      DB.update('patients',p=>p.id===patId,{name,phone,age,gender});
    }
    // Update invoice records (audit-safe: only patient info fields)
    const invUpdate={patient:name,phone,age,gender};
    if(doctor) invUpdate.docName=doctor;
    ['invoices','opd_invoices','pathology_invoices'].forEach(tbl=>{
      const rows=DB.get(tbl).filter(i=>i.cid===S.cid&&i.patient.toLowerCase()===document.getElementById('ep_name').value.toLowerCase());
      rows.forEach(i=>{ try{ DB.update(tbl,x=>x.id===i.id,invUpdate); }catch(e){} });
    });
    // If editing from invoice context, update that specific invoice
    if(invId&&invTable){
      try{ DB.update(invTable,i=>i.id===invId,invUpdate); }catch(e){}
    }
    N('‚úì Patient information updated successfully.');
    closeModal('m-edit-patient');
    // Refresh patient list if open
    if(document.getElementById('patTb')) fPats();
  }catch(e){N('Update failed: '+e.message,true);}
}
function rTestCats(){
  const cats=myCats();
  const tests=myAllTests();
  const canEdit=['admin','superadmin'].includes(S?.role);
  document.getElementById('wsBody').innerHTML=`
  <div class="box">
    <div class="box-title" style="display:flex;justify-content:space-between;align-items:center;">
      <span>Test Categories</span>
      ${canEdit?`<button class="btn btn-t btn-sm" onclick="openModal('m-add-cat')">+ Add Category</button>`:''}
    </div>
    ${cats.length===0?'<p style="color:var(--gray);font-size:13px;">No categories defined yet.</p>':''}
    ${cats.length>0?`<div class="tbl-wrap"><table>
      <thead><tr><th>Category Name</th><th>Test Count</th><th>Avg Price</th><th>Active Tests</th>${canEdit?'<th>Actions</th>':''}</tr></thead>
      <tbody>${cats.map(c=>{
        const ct=tests.filter(t=>t.cat===c.name);
        const active=ct.filter(t=>t.status!=='inactive').length;
        const avg=ct.length?Math.round(ct.reduce((s,t)=>s+t.price,0)/ct.length):0;
        return`<tr>
          <td style="font-weight:600">${escHtml(c.name)}</td>
          <td style="font-family:var(--mono)">${ct.length}</td>
          <td style="font-family:var(--mono);color:var(--teal)">‡ß≥${avg}</td>
          <td><span class="badge b-active">${active}</span></td>
          ${canEdit?`<td style="white-space:nowrap">
            <button class="btn btn-o btn-sm" onclick="openEditCat('${c.id}','${escHtml(c.name)}')">‚úèÔ∏è Edit</button>
            <button class="btn btn-r btn-sm" onclick="deleteCat('${c.id}','${escHtml(c.name)}')">üóë</button>
          </td>`:''}
        </tr>`;}).join('')}</tbody>
    </table></div>`:''
    }
  </div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-top:4px;">
    ${cats.map(c=>{const n=tests.filter(t=>t.cat===c.name).length;
      return`<div class="stat-card"><div class="snum" style="font-size:22px;color:var(--teal)">${n}</div><div class="slbl">${escHtml(c.name)}</div></div>`;}).join('')}
  </div>`;
  // Populate datalists
  const dl=document.getElementById('et-cat-list');
  if(dl) dl.innerHTML=cats.map(c=>`<option value="${escHtml(c.name)}">`).join('');
}
function openEditCat(id,name){
  document.getElementById('ec_id').value=id;
  document.getElementById('ec_name').value=name;
  openModal('m-edit-cat');
}
function saveEditCat(){
  const id=document.getElementById('ec_id').value;
  const name=document.getElementById('ec_name').value.trim();
  if(!name){N('Category name required.',true);return;}
  try{
    DB.update('test_categories',c=>c.id===id,{name});
    N(`‚úì Category updated to "${name}".`);
    closeModal('m-edit-cat');
    rTestCats();
  }catch(e){N('Update failed: '+e.message,true);}
}
function saveAddCat(){
  const name=document.getElementById('ac_name').value.trim();
  if(!name){N('Category name required.',true);return;}
  if(myCats().find(c=>c.name.toLowerCase()===name.toLowerCase())){N('Category already exists.',true);return;}
  try{
    DB.insert('test_categories',{id:uid(),cid:S.cid,name,createdBy:S.u,createdAt:new Date().toISOString()});
    N(`‚úì Category "${name}" added.`);
    document.getElementById('ac_name').value='';
    closeModal('m-add-cat');
    rTestCats();
  }catch(e){N('Failed: '+e.message,true);}
}
function deleteCat(id,name){
  if(!canDeleteTest()){N('Permission denied.',true);return;}
  const testsInCat=myAllTests().filter(t=>t.cat===name);
  if(testsInCat.length){if(!confirm(`Category "${name}" has ${testsInCat.length} tests. Delete category anyway? Tests will remain but be uncategorized.`))return;}
  else{if(!confirm(`Delete category "${name}"?`))return;}
  try{DB.delete('test_categories',c=>c.id===id);N(`‚úì Category "${name}" deleted.`);rTestCats();}
  catch(e){N('Delete failed: '+e.message,true);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TEST LIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rTestList(){
  const tests=myAllTests();
  const canEdit=['admin','superadmin'].includes(S?.role);
  const cats=myCats();
  document.getElementById('wsBody').innerHTML=`
  <div class="bar">
    <input id="tlq" placeholder="Search test..." oninput="filterTestList()" style="flex:1;">
    <select id="tlc" onchange="filterTestList()">
      <option value="">All Categories</option>
      ${cats.map(c=>`<option>${escHtml(c.name)}</option>`).join('')}
    </select>
    <select id="tls" onchange="filterTestList()">
      <option value="">All Status</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
    </select>
    ${canEdit?`<button class="btn btn-t btn-sm" onclick="showAddTestForm()">+ Add Test</button>`:''}
  </div>
  <div id="test-list-wrap">
  <div class="tbl-wrap"><table>
    <thead><tr><th>Name</th><th>Category</th><th>Method</th><th>Sample</th><th>Ref. Range</th><th>Unit</th>${canEdit?'<th>Price</th>':''}
    <th>Status</th>${canEdit?'<th>Actions</th>':''}</tr></thead>
    <tbody id="testTb">${buildTestTableRows(tests,canEdit)}</tbody>
  </table></div>
  </div>`;
  const dl=document.getElementById('et-cat-list');
  if(dl) dl.innerHTML=myCats().map(c=>`<option value="${escHtml(c.name)}">`).join('');
}
function buildTestTableRows(tests,canEdit){
  return tests.map(t=>`<tr style="${t.status==='inactive'?'opacity:.5':''}">
    <td style="font-weight:500">${escHtml(t.name)}</td>
    <td><span class="badge b-paid">${escHtml(t.cat)}</span></td>
    <td style="font-size:11px;color:var(--text2)">${escHtml(t.method||'‚Äî')}</td>
    <td style="font-size:11px">${escHtml(t.sample||'‚Äî')}</td>
    <td style="font-size:11px;color:var(--text2)">${escHtml(t.ref||'‚Äî')}</td>
    <td style="font-size:11px">${escHtml(t.unit||'‚Äî')}</td>
    ${canEdit?`<td style="font-family:var(--mono);color:var(--teal)">‡ß≥${t.price}</td>`:''}
    <td><span class="badge ${t.status==='inactive'?'b-due':'b-active'}">${(t.status||'active').toUpperCase()}</span></td>
    ${canEdit?`<td style="white-space:nowrap">
      <button class="btn btn-o btn-sm" onclick="openEditTest('${t.id}')">‚úèÔ∏è Edit</button>
      ${canDeleteTest()?`<button class="btn btn-r btn-sm" onclick="deleteTest('${t.id}')">üóë</button>`:''}
    </td>`:''}
  </tr>`).join('')||`<tr><td colspan="9" style="text-align:center;color:var(--text2);padding:20px;">No tests found.</td></tr>`;
}
function filterTestList(){
  const q=(document.getElementById('tlq')?.value||'').toLowerCase();
  const cat=document.getElementById('tlc')?.value||'';
  const status=document.getElementById('tls')?.value||'';
  const canEdit=['admin','superadmin'].includes(S?.role);
  const tests=myAllTests().filter(t=>
    t.name.toLowerCase().includes(q)&&(cat===''||t.cat===cat)&&(status===''||t.status===status)
  );
  const tb=document.getElementById('testTb');
  if(tb) tb.innerHTML=buildTestTableRows(tests,canEdit);
}
function openEditTest(id){
  const t=getTestById(id); if(!t){N('Test not found.',true);return;}
  document.getElementById('et_id').value=t.id;
  document.getElementById('et_name').value=t.name;
  document.getElementById('et_cat').value=t.cat;
  document.getElementById('et_method').value=t.method||'';
  document.getElementById('et_sample').value=t.sample||'';
  document.getElementById('et_unit').value=t.unit||'';
  document.getElementById('et_ref').value=t.ref||'';
  document.getElementById('et_status').value=t.status||'active';
  const priceEl=document.getElementById('et_price');
  priceEl.value=t.price;
  priceEl.readOnly=!canPrice();
  if(!canPrice()) priceEl.title='Only Admin can edit price';
  const dl=document.getElementById('et-cat-list');
  if(dl) dl.innerHTML=myCats().map(c=>`<option value="${escHtml(c.name)}">`).join('');
  openModal('m-edit-test');
}
function saveEditTest(){
  const id=document.getElementById('et_id').value;
  const name=document.getElementById('et_name').value.trim();
  const cat=document.getElementById('et_cat').value.trim();
  const ref=document.getElementById('et_ref').value.trim();
  if(!name||!cat||!ref){N('Name, Category, and Reference Range are required.',true);return;}
  const changes={
    name, cat, ref,
    method:document.getElementById('et_method').value.trim()||'Manual',
    sample:document.getElementById('et_sample').value.trim()||'N/A',
    unit:document.getElementById('et_unit').value.trim()||'',
    status:document.getElementById('et_status').value||'active',
    updatedBy:S.u, updatedAt:new Date().toISOString()
  };
  if(canPrice()){
    const p=parseFloat(document.getElementById('et_price').value||0);
    if(p<0){N('Price cannot be negative.',true);return;}
    changes.price=p;
  }
  try{
    DB.update('tests',t=>t.id===id,changes);
    N(`‚úì Test "${name}" updated.`);
    closeModal('m-edit-test');
    rTestList();
  }catch(e){N('Update failed: '+e.message,true);}
}
function showAddTestForm(){
  if(document.getElementById('add-test-form')) return;
  const wrap=document.getElementById('test-list-wrap');
  if(!wrap) return;
  const cats=myCats();
  const div=document.createElement('div');
  div.id='add-test-form';
  div.className='box';
  div.style.cssText='background:rgba(0,180,216,.04);border-color:rgba(0,180,216,.2);margin-bottom:14px;';
  div.innerHTML=`
  <div class="box-title">Add New Test</div>
  <div class="f2" style="margin-bottom:12px;">
    <div class="fi"><label>Test Name *</label><input id="nt_name" placeholder="e.g. Complete Blood Count" autofocus></div>
    <div class="fi"><label>Category *</label>
      <input id="nt_cat" placeholder="e.g. Hematology" list="nt-cat-list">
      <datalist id="nt-cat-list">${cats.map(c=>`<option value="${escHtml(c.name)}">`).join('')}</datalist>
    </div>
  </div>
  <div class="f4" style="margin-bottom:12px;">
    <div class="fi"><label>Method</label><input id="nt_method" placeholder="e.g. Manual"></div>
    <div class="fi"><label>Sample Type</label><input id="nt_sample" placeholder="e.g. EDTA"></div>
    <div class="fi"><label>Unit</label><input id="nt_unit" placeholder="e.g. g/dL"></div>
    <div class="fi"><label>Price (‡ß≥) *</label><input id="nt_price" type="number" min="0" placeholder="e.g. 400"></div>
  </div>
  <div class="fi" style="margin-bottom:16px;"><label>Reference Range *</label><input id="nt_ref" placeholder="e.g. M:13-17 F:12-16 or See Report"></div>
  <div class="action-row">
    <button class="btn btn-t" id="btn-add-test" onclick="saveNewTest()">üíæ Save Test</button>
    <button class="btn btn-o" onclick="document.getElementById('add-test-form').remove()">Cancel</button>
  </div>`;
  wrap.parentNode.insertBefore(div, wrap);
}
async function saveNewTest(){
  const name=document.getElementById('nt_name')?.value?.trim();
  const cat=document.getElementById('nt_cat')?.value?.trim();
  const price=parseFloat(document.getElementById('nt_price')?.value||'0');
  const ref=document.getElementById('nt_ref')?.value?.trim();
  const errs=[];
  if(!name) errs.push('Test Name');
  if(!cat) errs.push('Category');
  if(!price||price<=0) errs.push('Price (>0)');
  if(!ref) errs.push('Reference Range');
  if(errs.length){N('Required: '+errs.join(', '),true);return;}
  if(myAllTests().find(t=>t.name.toLowerCase()===name.toLowerCase())){N('Test name already exists.',true);return;}
  if(!myCats().find(c=>c.name.toLowerCase()===cat.toLowerCase())){
    DB.insert('test_categories',{id:uid(),cid:S.cid,name:cat,createdBy:S.u,createdAt:new Date().toISOString()});
  }
  const btn=document.getElementById('btn-add-test');
  if(btn){btn.textContent='‚è≥ Saving‚Ä¶';btn.disabled=true;}
  try{
    DB.insert('tests',{
      id:uid(), cid:S.cid, name, cat,
      method:document.getElementById('nt_method')?.value?.trim()||'Manual',
      sample:document.getElementById('nt_sample')?.value?.trim()||'N/A',
      unit:document.getElementById('nt_unit')?.value?.trim()||'',
      ref, price, status:'active',
      addedBy:S.u, addedAt:new Date().toISOString()
    });
    N(`‚úì Test "${name}" saved.`);
    document.getElementById('add-test-form')?.remove();
    rTestList();
  }catch(e){
    N('Failed: '+e.message,true);
    if(btn){btn.textContent='üíæ Save Test';btn.disabled=false;}
  }
}
async function deleteTest(id){
  if(!canDeleteTest()){N('Permission denied.',true);return;}
  if(!confirm('Delete this test?')) return;
  try{DB.delete('tests',t=>t.id===id);N('Test deleted.');rTestList();}
  catch(e){N('Delete failed: '+e.message,true);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESULT ENTRY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rResultEntry(){
  document.getElementById('wsBody').innerHTML=`
  <div style="background:rgba(0,150,199,.06);border:1px solid rgba(0,150,199,.2);border-radius:9px;padding:10px 16px;margin-bottom:12px;font-size:12px;color:var(--teal2);">
    üî¨ <strong>Unified Pathology Results:</strong> All tests come from the main OPD Invoice. Search by invoice number (e.g. 2026-1) to load patient tests for result entry.
  </div>
  <div style="display:grid;grid-template-columns:300px 1fr;gap:16px;">
    <div class="box">
      <div class="box-title">üîç Patient Lookup</div>
      <div class="fi" style="margin-bottom:8px;"><label>Invoice No or Patient ID</label>
        <input id="re_id" placeholder="e.g. 2026-1 or P-001"
          onkeydown="if(event.key==='Enter'){event.preventDefault();loadPR();}"
          style="font-family:var(--mono);letter-spacing:.05em;">
      </div>
      <button class="btn btn-t btn-sm" style="width:100%;margin-bottom:10px;" onclick="loadPR()">üîç Load Patient</button>
      <div id="re_inf" style="font-size:12px;color:var(--text2)">Enter invoice number and press Enter or click Load.</div>
    </div>
    <div class="box">
      <div class="box-title">üìù Result Entry</div>
      <div id="re_tests" style="min-height:60px;"><p style="color:var(--text2);font-size:13px;">No patient loaded. Search by Invoice No above.</p></div>
      <div class="action-row" style="margin-top:14px;">
        <button class="btn btn-t" onclick="saveResults()">üíæ Save Results</button>
        <button class="btn btn-o" onclick="rResultEntry()">üîÑ Reset</button>
      </div>
    </div>
  </div>`;
}
function loadPR(){
  const raw=document.getElementById('re_id')?.value||'';
  // Strip zero-width / extra spaces
  const id=raw.replace(/[\u200B-\u200D\uFEFF]/g,'').replace(/\s+/g,' ').trim();
  const inf=document.getElementById('re_inf');
  const tel=document.getElementById('re_tests');
  if(!id){
    if(inf) inf.innerHTML='Enter Invoice No or Patient ID to load tests.';
    if(tel) tel.innerHTML='<p style="color:var(--text2);font-size:13px;">No patient selected.</p>';
    return;
  }

  // Normalize the entered value (strip PATH-/OPD- prefix, strip zero-padding)
  const idNorm = normalizeInvNo(id);

  // ‚îÄ‚îÄ Search helper: normalized exact, then case-insensitive, then partial ‚îÄ‚îÄ
  const matchInv = (list, field) => {
    // 1. Exact normalized match
    let hit = list.find(i => normalizeInvNo(i[field]||'') === idNorm);
    if(hit) return hit;
    // 2. Case-insensitive normalized
    hit = list.find(i => normalizeInvNo(i[field]||'').toLowerCase() === idNorm.toLowerCase());
    if(hit) return hit;
    // 3. UUID match
    hit = list.find(i => i.id === id);
    if(hit) return hit;
    // 4. Partial (only if 3+ chars)
    if(id.length >= 3){
      hit = list.find(i => normalizeInvNo(i[field]||'').toLowerCase().includes(idNorm.toLowerCase()));
      if(hit) return hit;
    }
    return null;
  };

  // ‚îÄ‚îÄ Step 1: Search OPD invoices FIRST (primary source in v17) ‚îÄ‚îÄ
  const opdList = DB.get('opd_invoices').filter(i => i.cid===S.cid);
  const opdInv = matchInv(opdList, 'no');

  if(opdInv && (opdInv.pathTests||[]).length){
    // Load pathology tests from OPD invoice
    const tests = (opdInv.pathTests||[]).map(tid=>{
      const fullTest = getTestById(tid) || {};
      return { id: tid, name: fullTest.name||tid, price: fullTest.price||0,
        sample: fullTest.sample||'', method: fullTest.method||'', ref: fullTest.ref||'', unit: fullTest.unit||'' };
    }).filter(t=>t.name!==t.id||getTestById(t.id));
    const docDisp = opdInv.docName ? escHtml(opdInv.docName) : '‚Äî';
    if(inf) inf.innerHTML=`
      <div style="padding:8px;background:rgba(0,150,199,.06);border-radius:6px;border:1px solid rgba(0,150,199,.18);">
        <strong style="color:var(--teal2);font-size:13px;">${escHtml(opdInv.patient)}</strong><br>
        <span style="font-size:11px;color:var(--text2)">${opdInv.phone||'‚Äî'} ¬∑ ${opdInv.age||'‚Äî'} ¬∑ ${opdInv.gender||'‚Äî'}</span><br>
        <span style="color:var(--teal);font-family:var(--mono);font-size:12px;">OPD Invoice: ${escHtml(opdInv.no)}</span>
        ${opdInv.due>0?`<span style="margin-left:8px;color:var(--red);font-size:11px;">Due: ‡ß≥${opdInv.due.toLocaleString()}</span>`:''}
        <br><span style="font-size:11px;color:var(--text2)">Doctor: ${docDisp}</span>
        <br><span style="font-size:10px;background:rgba(0,150,199,.1);color:var(--teal2);padding:2px 6px;border-radius:4px;">üî¨ ${tests.length} pathology test(s)</span>
      </div>`;
    if(!tests.length){
      if(tel) tel.innerHTML='<p style="color:var(--amber);font-size:13px;">‚ö† No pathology tests found on this OPD invoice.</p>';
      return;
    }
    renderResultFields(tel, tests, opdInv.id, true);
    return;
  }

  // ‚îÄ‚îÄ Step 2: Search legacy pathology invoices (backward compat) ‚îÄ‚îÄ
  const pathList = DB.get('pathology_invoices').filter(i => i.cid===S.cid && !i.void);
  const pathInv = matchInv(pathList, 'no');

  if(pathInv){
    // Load items via invoice_id relation
    const items = DB.get('pathology_invoice_items').filter(item => item.pathInvId === pathInv.id);
    const tests = items.map(item => {
      const fullTest = getTestById(item.testId) || {};
      return {
        id: item.testId,
        name: item.testName || fullTest.name || item.testId,
        price: item.unitPrice || fullTest.price || 0,
        sample: fullTest.sample || '',
        method: fullTest.method || '',
        ref: fullTest.ref || '',
        unit: fullTest.unit || ''
      };
    });
    const docDisp = pathInv.doctorName
      ? escHtml(pathInv.doctorName+(pathInv.doctorDegree?', '+pathInv.doctorDegree:''))
      : '‚Äî';
    if(inf) inf.innerHTML=`
      <div style="padding:8px;background:rgba(109,40,217,.06);border-radius:6px;border:1px solid rgba(109,40,217,.18);">
        <strong style="color:var(--purple);font-size:13px;">${escHtml(pathInv.patient)}</strong><br>
        <span style="font-size:11px;color:var(--text2)">${pathInv.phone||'‚Äî'} ¬∑ ${pathInv.age||'‚Äî'} ¬∑ ${pathInv.gender||'‚Äî'}</span><br>
        <span style="color:var(--purple);font-family:var(--mono);font-size:12px;">Invoice: ${escHtml(pathInv.no)}</span>
        ${pathInv.due>0?`<span style="margin-left:8px;color:var(--red);font-size:11px;">Due: ‡ß≥${pathInv.due.toLocaleString()}</span>`:''}
        <br><span style="font-size:11px;color:var(--text2)">Referred by: ${docDisp}</span>
      </div>`;
    if(!tests.length){
      if(tel) tel.innerHTML='<p style="color:var(--amber);font-size:13px;">‚ö† No tests found on this invoice.</p>';
      return;
    }
    renderResultFields(tel, tests, pathInv.id, true);
    return;
  }

  // ‚îÄ‚îÄ Step 2: Search lab invoices ‚îÄ‚îÄ
  const labList = DB.get('invoices').filter(i => i.cid===S.cid);
  const inv = matchInv(labList, 'no');

  if(!inv){
    // Try by patient ID
    const p = myPats().find(x => x.id===id || x.id.toLowerCase()===id.toLowerCase());
    if(p){
      if(inf) inf.innerHTML=`<strong style="color:var(--text)">${escHtml(p.name)}</strong><br>${p.phone} ¬∑ ${p.age}Y ¬∑ ${p.gender}`;
      const tids=[...new Set(myInvs().filter(i=>i.patient.toLowerCase()===p.name.toLowerCase()).flatMap(i=>i.tests))];
      const tests=tids.map(tid=>getTestById(tid)).filter(Boolean);
      if(!tests.length){if(tel)tel.innerHTML='<p style="color:var(--text2);font-size:13px;">No tests on record for this patient.</p>';return;}
      renderResultFields(tel,tests,null); return;
    }
    if(inf) inf.innerHTML=`<span style="color:var(--red)">‚ùå Invoice not found.</span>`;
    if(tel) tel.innerHTML='<p style="color:var(--text2);font-size:13px;">No patient selected.</p>';
    return;
  }

  if(inf) inf.innerHTML=`
    <div style="padding:8px;background:rgba(0,150,199,.06);border-radius:6px;border:1px solid rgba(0,150,199,.15);">
      <strong style="color:var(--text);font-size:13px;">${escHtml(inv.patient)}</strong><br>
      <span style="font-size:11px;color:var(--text2)">${inv.phone||'‚Äî'} ¬∑ ${inv.age||'‚Äî'} ¬∑ ${inv.gender||'‚Äî'}</span><br>
      <span style="color:var(--teal);font-family:var(--mono);font-size:12px;">Invoice: ${inv.no}</span>
      ${inv.due>0?`<span style="margin-left:8px;color:var(--red);font-size:11px;">Due: ‡ß≥${inv.due.toLocaleString()}</span>`:''}
    </div>`;

  const tests=inv.tests.map(tid=>getTestById(tid)).filter(Boolean);
  if(!tests.length){if(tel)tel.innerHTML='<p style="color:var(--text2);font-size:13px;">No tests on invoice.</p>';return;}
  renderResultFields(tel,tests,inv.id);
}
function renderResultFields(tel,tests,invId,isPath){
  // Load existing saved results if any
  const existing = invId ? DB.findOne('test_results', r=>r.invId===invId) : null;
  if(tel) tel.innerHTML=tests.map(t=>{
    const savedVal = existing ? (existing.results[t.id]||'') : '';
    return`<div style="display:grid;grid-template-columns:1fr 150px 90px 60px;gap:8px;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);" data-inv-type="${isPath?'path':'lab'}">
      <div>
        <div style="font-weight:600;font-size:13px;">${escHtml(t.name)}</div>
        <div style="font-size:10px;color:var(--text3);margin-top:1px;">${escHtml(t.sample||'')} ${t.method?'¬∑ '+escHtml(t.method):''}</div>
      </div>
      <div style="font-size:11px;color:var(--text2);font-family:var(--mono);">${escHtml(t.ref||'‚Äî')}</div>
      <input id="res_${t.id}" value="${escHtml(savedVal)}" placeholder="Result"
        style="padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;outline:none;text-align:right;"
        onfocus="this.style.borderColor='var(--teal)';this.style.background='#fff'"
        onblur="this.style.borderColor='var(--border)';this.style.background='var(--bg)';autoFlag('${t.id}','${escHtml(t.ref||'').replace(/'/g,'')}',this.value)"
        oninput="autoFlag('${t.id}','${escHtml(t.ref||'').replace(/'/g,'')}',this.value)">
      <div id="flag_${t.id}" style="font-size:11px;font-weight:700;text-align:center;min-width:28px;">${savedVal?getFlagText(savedVal,t.ref||''):''}</div>
    </div>
    <div style="font-size:11px;color:var(--text2);padding-bottom:2px;">${escHtml(t.unit||'')}</div>`;
  }).join('');
}
function autoFlag(testId, refRange, val){
  const el=document.getElementById('flag_'+testId); if(!el) return;
  el.textContent=getFlagText(val,refRange);
  el.style.color=el.textContent==='H'?'var(--red)':el.textContent==='L'?'var(--teal)':'var(--text3)';
}
function getFlagText(val, refRange){
  if(!val||!refRange) return '';
  const num=parseFloat(val);
  if(isNaN(num)) return '';
  // Parse ranges like "M:13-17 F:12-16", "0-15", "4.0-5.9", "<7.8", ">0.5"
  // Try simple X-Y range
  const rangeMatch=refRange.match(/(\d+\.?\d*)\s*[-‚Äì]\s*(\d+\.?\d*)/);
  if(rangeMatch){
    const lo=parseFloat(rangeMatch[1]), hi=parseFloat(rangeMatch[2]);
    if(num>hi) return 'H';
    if(num<lo) return 'L';
    return '';
  }
  // Try <X
  const ltMatch=refRange.match(/^<\s*(\d+\.?\d*)/);
  if(ltMatch){ return num>=parseFloat(ltMatch[1])?'H':''; }
  // Try >X
  const gtMatch=refRange.match(/^>\s*(\d+\.?\d*)/);
  if(gtMatch){ return num<=parseFloat(gtMatch[1])?'L':''; }
  return '';
}
function saveResults(){
  const raw=document.getElementById('re_id')?.value||'';
  const pid=raw.replace(/[\u200B-\u200D\uFEFF]/g,'').replace(/\s+/g,' ').trim();
  if(!pid){N('No patient selected.',true);return;}
  const pidNorm = normalizeInvNo(pid);

  // Try pathology invoices first (normalized match)
  let inv = DB.findOne('pathology_invoices', i =>
    i.cid===S.cid && (
      normalizeInvNo(i.no)===pidNorm ||
      normalizeInvNo(i.no).toLowerCase()===pidNorm.toLowerCase() ||
      i.id===pid
    )
  );
  let isPath = !!inv;
  let tests = [];

  if(isPath){
    const items = DB.get('pathology_invoice_items').filter(item => item.pathInvId === inv.id);
    tests = items.map(item => ({
      id: item.testId,
      name: item.testName || item.testId,
    }));
  } else {
    // Try lab invoices
    inv = DB.findOne('invoices', i =>
      i.cid===S.cid && (
        normalizeInvNo(i.no)===pidNorm ||
        normalizeInvNo(i.no).toLowerCase()===pidNorm.toLowerCase() ||
        i.id===pid
      )
    );
    if(inv) tests = inv.tests.map(tid=>getTestById(tid)).filter(Boolean);
  }

  if(!inv){N('Invoice not found.',true);return;}
  if(!tests.length){N('No tests on this invoice.',true);return;}

  const results={};
  tests.forEach(t=>{
    const val=document.getElementById('res_'+t.id)?.value?.trim()||'';
    if(val) results[t.id]=val;
  });
  if(!Object.keys(results).length){N('Enter at least one test result.',true);return;}
  try{
    const existing=DB.findOne('test_results',r=>r.invId===inv.id);
    if(existing){
      DB.update('test_results',r=>r.invId===inv.id,{results,updatedAt:new Date().toISOString(),by:S.u});
    } else {
      DB.insert('test_results',{
        id:uid(), invId:inv.id, cid:S.cid,
        patientName:inv.patient, invNo:inv.no,
        invoiceType:isPath?'PATH':'LAB',
        results, savedAt:new Date().toISOString(), by:S.u
      });
    }
    N(`‚úì Results saved for ${inv.patient} (${inv.no}).`);
  }catch(e){N('Save failed: '+e.message,true);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê v16 MIGRATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Normalize ALL invoice numbers to plain YYYY-N (no PATH-, no OPD-, no zero-padding)
// Backward-compatible: existing records are updated in-place, no data deleted.
(function migrateV16(){
  try{
    // normalizeInvNo is already defined above ‚Äî strip prefix + zero-padding
    const migrateTable = (tbl) => {
      const rows = DB.get(tbl);
      let changed = false;
      const updated = rows.map(r => {
        if(!r.no) return r;
        const newNo = normalizeInvNo(r.no);
        if(newNo !== r.no){ changed = true; return {...r, no:newNo}; }
        return r;
      });
      if(changed) DB._save(tbl, updated);
    };
    migrateTable('invoices');
    migrateTable('opd_invoices');
    migrateTable('pathology_invoices');

    // Backfill byName on lab invoices
    const invs = DB.get('invoices');
    let invChanged = false;
    const updInvs = invs.map(i => {
      if(!i.byName){
        invChanged = true;
        const u = DB.findOne('users', x => x.u===i.by);
        return {...i, byName: u?.name||i.by||'‚Äî'};
      }
      return i;
    });
    if(invChanged) DB._save('invoices', updInvs);

    // Normalize RC numbers in due_log + backfill fields
    const logs = DB.get('due_log');
    let logsChanged = false;
    const updLogs = logs.map(d => {
      const newRcNo = (() => {
        if(!d.rcNo) return d.rcNo;
        const m = String(d.rcNo).match(/^RC-(\d{4})-0*(\d+)$/i);
        return m ? `RC-${m[1]}-${parseInt(m[2],10)}` : d.rcNo;
      })();
      const inv = DB.findOne('invoices',i=>i.id===d.invId) ||
                  DB.findOne('opd_invoices',i=>i.id===d.invId) ||
                  DB.findOne('pathology_invoices',i=>i.id===d.invId);
      const needsFix = newRcNo!==d.rcNo || !d.receivedBy || !d.byName || !d.invoiceNo;
      if(needsFix){
        logsChanged = true;
        return {...d,
          rcNo: newRcNo,
          receivedBy: d.receivedBy||d.by||'‚Äî',
          receivedByName: d.receivedByName||d.byName||d.by||'‚Äî',
          byName: d.byName||d.by||'‚Äî',
          invoiceNo: d.invoiceNo||(inv?normalizeInvNo(inv.no):d.invId)||'‚Äî',
          invoiceType: d.invoiceType||(inv?.no?.startsWith?.('PATH')?'PATH':'LAB'),
        };
      }
      return d;
    });
    if(logsChanged) DB._save('due_log', updLogs);

    // Backfill invoiceNo on pathology_invoice_items (new v16 field)
    const items = DB.get('pathology_invoice_items');
    let itemsChanged = false;
    const updItems = items.map(item => {
      if(!item.invoiceNo){
        const pi = DB.findOne('pathology_invoices', i => i.id===item.pathInvId);
        if(pi){ itemsChanged=true; return {...item, invoiceNo: pi.no}; }
      }
      return item;
    });
    if(itemsChanged) DB._save('pathology_invoice_items', updItems);

  }catch(e){console.warn('[v16 Migration]',e);}
})();

// Initialize collections
DB.seed('test_results',[]);
DB.seed('user_collections',[]); // unified user-wise collection tracking

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACCOUNTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rAccSummary(){
  const invs=myInvs();
  const tot=invs.reduce((s,i)=>s+i.subtotal,0);
  const coll=invs.reduce((s,i)=>s+i.paid,0);
  const due=invs.reduce((s,i)=>s+i.due,0);
  const disc=invs.reduce((s,i)=>s+i.discount,0);
  document.getElementById('wsBody').innerHTML=`
  <div class="acc-cards">
    <div class="acc-card"><div class="an" style="color:var(--teal)">‡ß≥${tot.toLocaleString()}</div><div class="al">Total Bills</div></div>
    <div class="acc-card"><div class="an" style="color:var(--green)">‡ß≥${coll.toLocaleString()}</div><div class="al">Total Collected</div></div>
    <div class="acc-card"><div class="an" style="color:var(--red)">‡ß≥${due.toLocaleString()}</div><div class="al">Total Due</div></div>
    <div class="acc-card"><div class="an" style="color:var(--amber)">‡ß≥${disc.toLocaleString()}</div><div class="al">Total Discount</div></div>
  </div>
  <div class="box">
    <div class="box-title">All Invoices Summary</div>
    <div class="tbl-wrap"><table>
      <thead><tr><th>Invoice</th><th>Date</th><th>Patient</th><th>Total</th><th>Paid</th><th>Due</th><th>Status</th><th></th></tr></thead>
      <tbody>${invs.map(v=>`<tr>
        <td style="font-family:var(--mono);color:var(--teal)">${v.no}</td>
        <td>${v.date}</td><td style="font-weight:500">${escHtml(v.patient)}</td>
        <td style="font-family:var(--mono)">‡ß≥${v.subtotal.toLocaleString()}</td>
        <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
        <td><span class="badge ${v.due>0?'b-due':'b-active'}">‡ß≥${v.due.toLocaleString()}</span></td>
        <td><span class="badge ${v.status==='paid'?'b-active':'b-due'}">${(v.status||'').toUpperCase()}</span></td>
        <td><button class="btn btn-o btn-sm" onclick="reviewInvoice('${v.id}')">üëÅ</button></td>
      </tr>`).join('')||`<tr><td colspan="8" style="text-align:center;color:var(--text2);padding:20px;">No invoices.</td></tr>`}</tbody>
    </table></div>
  </div>`;
}
function rAccRange(){
  document.getElementById('wsBody').innerHTML=`
  <div class="box">
    <div class="box-title">Date Range Summary</div>
    <div class="bar">
      From: <input type="date" id="rf" value="${new Date().getFullYear()+'-01-01'}" style="color:var(--text);">
      To: <input type="date" id="rt" value="${new Date().toISOString().split('T')[0]}" style="color:var(--text);">
      <button class="btn btn-t btn-sm" onclick="calcRange()">Generate</button>
    </div>
    <div id="range_out"><p style="color:var(--gray);font-size:13px;">Select dates and click Generate.</p></div>
  </div>`;
}
function calcRange(){
  const f=document.getElementById('rf')?.value,t=document.getElementById('rt')?.value;
  if(!f||!t){N('Select both dates.',true);return;}
  if(f>t){N('From date must be before To date.',true);return;}
  const filtered=myInvs().filter(i=>i.date>=f&&i.date<=t);
  const tot=filtered.reduce((s,i)=>s+i.subtotal,0);
  const coll=filtered.reduce((s,i)=>s+i.paid,0);
  const due=filtered.reduce((s,i)=>s+i.due,0);
  const disc=filtered.reduce((s,i)=>s+i.discount,0);
  const byUser={};
  filtered.forEach(i=>{
    if(!byUser[i.by])byUser[i.by]={count:0,paid:0};
    byUser[i.by].count++;byUser[i.by].paid+=i.paid;
  });
  document.getElementById('range_out').innerHTML=`
  <div class="acc-cards" style="margin-bottom:14px;">
    <div class="acc-card"><div class="an" style="color:var(--teal)">‡ß≥${tot.toLocaleString()}</div><div class="al">Total Bills</div></div>
    <div class="acc-card"><div class="an" style="color:var(--green)">‡ß≥${coll.toLocaleString()}</div><div class="al">Received</div></div>
    <div class="acc-card"><div class="an" style="color:var(--red)">‡ß≥${due.toLocaleString()}</div><div class="al">Due</div></div>
    <div class="acc-card"><div class="an" style="color:var(--amber)">‡ß≥${disc.toLocaleString()}</div><div class="al">Discount</div></div>
  </div>
  ${Object.keys(byUser).length?`
  <div class="box"><div class="box-title">Cash Flow Per User ‚Äî ${f} to ${t}</div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>User</th><th>Invoices</th><th>Collected</th></tr></thead>
    <tbody>${Object.entries(byUser).map(([u,v])=>`<tr>
      <td style="font-family:var(--mono)">${escHtml(u)}</td>
      <td style="font-family:var(--mono)">${v.count}</td>
      <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
    </tr>`).join('')}</tbody>
  </table></div></div>`:''}
  <div class="box"><div class="box-title">Invoice Detail ‚Äî ${f} to ${t}</div>
    ${filtered.length===0?'<p style="color:var(--gray);font-size:13px;">No invoices in this range.</p>':
    `<div class="tbl-wrap"><table>
      <thead><tr><th>Invoice</th><th>Date</th><th>Patient</th><th>Total</th><th>Paid</th><th>Due</th><th></th></tr></thead>
      <tbody>${filtered.map(v=>`<tr>
        <td style="font-family:var(--mono);color:var(--teal)">${v.no}</td><td>${v.date}</td>
        <td style="font-weight:500">${escHtml(v.patient)}</td>
        <td style="font-family:var(--mono)">‡ß≥${v.subtotal.toLocaleString()}</td>
        <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
        <td><span class="badge ${v.due>0?'b-due':'b-active'}">‡ß≥${v.due.toLocaleString()}</span></td>
        <td><button class="btn btn-o btn-sm" onclick="reviewInvoice('${v.id}')">üëÅ</button></td>
      </tr>`).join('')}</tbody>
    </table></div>`}
  </div>`;
}
function rAccReceipts(){
  const log=DB.get('due_log').filter(d=>{
    const inv=DB.findOne('invoices',i=>i.id===d.invId)||DB.findOne('opd_invoices',i=>i.id===d.invId);
    return inv?.cid===S?.cid;
  });
  document.getElementById('wsBody').innerHTML=`
  <div class="box">
    <div class="box-title">Due Collection Receipt Log</div>
    ${log.length===0?'<p style="color:var(--gray);font-size:13px;">No due collections recorded.</p>':
    `<div class="tbl-wrap"><table>
      <thead><tr><th>Receipt No</th><th>Invoice</th><th>Patient</th><th>Collected</th><th>Prev Due</th><th>Remaining</th><th>Date</th><th>Received By</th><th>Actions</th></tr></thead>
      <tbody>${log.map(d=>{
        const inv=DB.findOne('invoices',i=>i.id===d.invId)||DB.findOne('opd_invoices',i=>i.id===d.invId);
        return`<tr>
        <td style="font-family:var(--mono);color:var(--green)">${d.rcNo||'‚Äî'}</td>
        <td style="font-family:var(--mono);color:var(--teal)">${escHtml(d.invoiceNo||inv?.no||d.invId)}</td>
        <td style="font-weight:500">${escHtml(inv?.patient||'‚Äî')}</td>
        <td style="font-family:var(--mono);color:var(--green)">‡ß≥${d.amount.toLocaleString()}</td>
        <td style="font-family:var(--mono);color:var(--amber)">‡ß≥${(d.prevDue||0).toLocaleString()}</td>
        <td><span class="badge ${(d.remainDue||0)>0?'b-due':'b-active'}">‡ß≥${(d.remainDue||0).toLocaleString()}</span></td>
        <td>${d.receiveDate||d.date}</td>
        <td><span style="font-weight:500;color:var(--navy)">${escHtml(d.receivedByName||d.byName||d.by||'‚Äî')}</span></td>
        <td style="white-space:nowrap">
          ${inv?`<button class="btn btn-o btn-sm" onclick="reviewInvoice('${inv.id}')">üëÅ</button>`:'‚Äî'}
          <button class="btn btn-g btn-sm" onclick="printDueLog('${d.id}')">üñ®</button>
        </td>
      </tr>`;}).join('')}</tbody>
    </table></div>`}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê USER COLLECTION REPORT (v16) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rUserCollection(){
  const isAdmin = ['admin','superadmin'].includes(S?.role);
  const isReception = S?.role === 'reception';
  if(!isAdmin && !isReception){
    document.getElementById('wsBody').innerHTML=`
    <div class="box">
      <div class="box-title">üë§ User Collection Report</div>
      <p style="color:var(--red);font-size:13px;">Access restricted. Please contact your administrator.</p>
    </div>`;
    return;
  }
  const today = new Date().toISOString().split('T')[0];
  const yearStart = new Date().getFullYear()+'-01-01';
  const users = DB.get('users').filter(u=>u.cid===S.cid);
  const userOpts = isAdmin
    ? `<select id="uc_user" style="padding:7px 10px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:12px;outline:none;">
         <option value="">All Users</option>
         ${users.map(u=>`<option value="${escHtml(u.u)}">${escHtml(u.name||u.u)}</option>`).join('')}
       </select>`
    : `<input type="hidden" id="uc_user" value="${escHtml(S.u)}">
       <span style="font-size:12px;color:var(--text2);padding:4px 8px;background:var(--teal-light);border-radius:6px;">üë§ ${escHtml(S.name||S.u)}</span>`;

  document.getElementById('wsBody').innerHTML=`
  <div class="box">
    <div class="box-title">üë§ ${isAdmin?'User-wise Collection Report':'My Collection Summary'}</div>
    <div class="bar" style="flex-wrap:wrap;gap:8px;margin-bottom:12px;">
      From: <input type="date" id="uc_f" value="${yearStart}" style="color:var(--text);">
      To: <input type="date" id="uc_t" value="${today}" style="color:var(--text);">
      <select id="uc_type" style="padding:7px 10px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:12px;outline:none;">
        <option value="">All Modules</option>
        <option value="LAB">Lab</option>
        <option value="PATH">Pathology</option>
        <option value="OPD">OPD</option>
        <option value="IPD">Indoor/IPD</option>
      </select>
      ${userOpts}
      <button class="btn btn-t btn-sm" onclick="genUserColl()">üìä Generate</button>
      ${isAdmin?`<button class="btn btn-o btn-sm" onclick="printUserCollReport()">üñ® Print</button>`:''}
    </div>
    <div id="uc_out"><p style="color:var(--text2);font-size:13px;">Select date range and click Generate.</p></div>
  </div>`;
}

function _getUserCollData(f, t, typeF, userF){
  // Pull from user_collections
  let colls = DB.get('user_collections').filter(c =>
    c.cid===S.cid &&
    (c.receiveDate||'')>=f && (c.receiveDate||'')<=t &&
    (typeF===''||c.invoiceType===typeF) &&
    (userF===''||c.receivedBy===userF) &&
    (c.amount||0) > 0   // only entries where money changed hands
  );
  // Backfill from due_log (pre-v16 data)
  const dlColls = DB.get('due_log').filter(d=>{
    const inv = DB.findOne('invoices',i=>i.id===d.invId) ||
                DB.findOne('opd_invoices',i=>i.id===d.invId) ||
                DB.findOne('pathology_invoices',i=>i.id===d.invId);
    if(!inv||inv.cid!==S.cid) return false;
    const dt = d.receiveDate||d.date||'';
    if(dt<f||dt>t) return false;
    if(typeF&&(d.invoiceType||'LAB')!==typeF) return false;
    if(userF&&(d.receivedBy||d.by||'')!==userF) return false;
    return !colls.find(c=>c.rcNo===d.rcNo&&d.rcNo); // no double-count
  }).map(d=>{
    const inv = DB.findOne('invoices',i=>i.id===d.invId)||
                DB.findOne('opd_invoices',i=>i.id===d.invId)||
                DB.findOne('pathology_invoices',i=>i.id===d.invId)||{};
    return {
      id:d.id, invoiceNo:d.invoiceNo||normalizeInvNo(inv.no)||'‚Äî',
      invoiceType:d.invoiceType||'LAB', module:d.module||d.invoiceType||'Lab',
      patient:inv.patient||'‚Äî', amount:d.amount||0,
      receivedBy:d.receivedBy||d.by||'‚Äî',
      receivedByName:d.receivedByName||d.byName||d.by||'‚Äî',
      receiveDate:d.receiveDate||d.date||'‚Äî',
      location:d.location||getClinic(S.cid)?.name||'',
      rcNo:d.rcNo, note:d.note||''
    };
  });
  return [...colls,...dlColls].sort((a,b)=>(b.receiveDate||'').localeCompare(a.receiveDate||''));
}

function genUserColl(){
  const f=document.getElementById('uc_f')?.value;
  const t=document.getElementById('uc_t')?.value;
  const typeF=document.getElementById('uc_type')?.value||'';
  const userF=document.getElementById('uc_user')?.value||'';
  if(!f||!t){N('Select date range.',true);return;}
  if(f>t){N('From must be before To.',true);return;}

  const isAdmin = ['admin','superadmin'].includes(S?.role);
  const allColls = _getUserCollData(f, t, typeF, userF);
  const totalAmt = allColls.reduce((s,c)=>s+(c.amount||0),0);

  // Group by user
  const byUser={};
  allColls.forEach(c=>{
    const k=c.receivedBy||'‚Äî';
    if(!byUser[k]) byUser[k]={name:c.receivedByName||k,userId:k,total:0,count:0};
    byUser[k].total+=c.amount||0; byUser[k].count++;
  });
  // Group by date
  const byDate={};
  allColls.forEach(c=>{
    const d=c.receiveDate||'‚Äî';
    if(!byDate[d]) byDate[d]={date:d,total:0,count:0};
    byDate[d].total+=c.amount||0; byDate[d].count++;
  });
  // Group by module
  const byMod={};
  allColls.forEach(c=>{
    const m=c.invoiceType||'‚Äî';
    if(!byMod[m]) byMod[m]={mod:m,total:0,count:0};
    byMod[m].total+=c.amount||0; byMod[m].count++;
  });
  // Group by location (admin only)
  const byLoc={};
  if(isAdmin) allColls.forEach(c=>{
    const l=c.location||'‚Äî';
    if(!byLoc[l]) byLoc[l]={location:l,total:0,count:0};
    byLoc[l].total+=c.amount||0; byLoc[l].count++;
  });

  const modBadge=tp=>tp==='PATH'?'b-warn':tp==='OPD'?'b-active':tp==='IPD'?'b-purple':'b-info';

  const el=document.getElementById('uc_out');
  if(!el) return;
  el.innerHTML=`
  <!-- Summary Cards -->
  <div class="acc-cards" style="margin-bottom:16px;">
    <div class="acc-card"><div class="an" style="color:var(--green)">‡ß≥${totalAmt.toLocaleString()}</div><div class="al">Total Collected</div></div>
    <div class="acc-card"><div class="an" style="color:var(--teal)">${allColls.length}</div><div class="al">Transactions</div></div>
    ${isAdmin?`<div class="acc-card"><div class="an" style="color:var(--navy)">${Object.keys(byUser).length}</div><div class="al">Staff Members</div></div>`:''}
    <div class="acc-card"><div class="an" style="color:var(--purple)">${Object.keys(byDate).length}</div><div class="al">Active Days</div></div>
  </div>

  ${isAdmin ? `
  <!-- Admin: Per-user summary -->
  <div class="box" style="margin-bottom:14px;">
    <div class="box-title" style="color:var(--navy)">üë§ Collection Per Staff Member</div>
    ${Object.keys(byUser).length===0?'<p style="color:var(--text2);font-size:13px;">No data.</p>':`
    <div class="tbl-wrap"><table>
      <thead><tr><th>Staff Name</th><th>Invoice Count</th><th>Total Received (‡ß≥)</th><th></th></tr></thead>
      <tbody>${Object.values(byUser).sort((a,b)=>b.total-a.total).map(u=>`<tr>
        <td style="font-weight:600;color:var(--navy)">${escHtml(u.name)}</td>
        <td style="font-family:var(--mono);text-align:center">${u.count}</td>
        <td style="font-family:var(--mono);color:var(--green);font-weight:700">‡ß≥${u.total.toLocaleString()}</td>
        <td><button class="btn btn-o btn-sm" onclick="showUserCollDetail('${escHtml(u.userId)}')">Detail</button></td>
      </tr>`).join('')}
      </tbody>
    </table></div>`}
  </div>` : ''}

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;">
    <!-- Daily Summary -->
    <div class="box">
      <div class="box-title" style="color:var(--teal)">üìÖ Daily Summary</div>
      ${Object.keys(byDate).length===0?'<p style="color:var(--text2);font-size:13px;">No data.</p>':`
      <div class="tbl-wrap"><table>
        <thead><tr><th>Date</th><th>Transactions</th><th>Total (‡ß≥)</th></tr></thead>
        <tbody>${Object.values(byDate).sort((a,b)=>b.date.localeCompare(a.date)).map(d=>`<tr>
          <td style="font-weight:500">${d.date}</td>
          <td style="font-family:var(--mono);text-align:center">${d.count}</td>
          <td style="font-family:var(--mono);color:var(--green)">‡ß≥${d.total.toLocaleString()}</td>
        </tr>`).join('')}</tbody>
      </table></div>`}
    </div>
    <!-- Module Summary -->
    <div class="box">
      <div class="box-title" style="color:var(--purple)">üìä By Module</div>
      ${Object.keys(byMod).length===0?'<p style="color:var(--text2);font-size:13px;">No data.</p>':`
      <div class="tbl-wrap"><table>
        <thead><tr><th>Module</th><th>Transactions</th><th>Total (‡ß≥)</th></tr></thead>
        <tbody>${Object.values(byMod).sort((a,b)=>b.total-a.total).map(m=>`<tr>
          <td><span class="badge ${modBadge(m.mod)}">${escHtml(m.mod)}</span></td>
          <td style="font-family:var(--mono);text-align:center">${m.count}</td>
          <td style="font-family:var(--mono);color:var(--green)">‡ß≥${m.total.toLocaleString()}</td>
        </tr>`).join('')}</tbody>
      </table></div>`}
    </div>
  </div>

  ${isAdmin && Object.keys(byLoc).length>1?`
  <div class="box" style="margin-bottom:14px;">
    <div class="box-title" style="color:var(--amber)">üìç Location-wise Collection</div>
    <div class="tbl-wrap"><table>
      <thead><tr><th>Location</th><th>Transactions</th><th>Total (‡ß≥)</th></tr></thead>
      <tbody>${Object.values(byLoc).sort((a,b)=>b.total-a.total).map(l=>`<tr>
        <td style="font-weight:500">${escHtml(l.location)}</td>
        <td style="font-family:var(--mono);text-align:center">${l.count}</td>
        <td style="font-family:var(--mono);color:var(--green)">‡ß≥${l.total.toLocaleString()}</td>
      </tr>`).join('')}</tbody>
    </table></div>
  </div>`:''}

  <!-- Full Transaction Log -->
  <div class="box">
    <div class="box-title">üìã Transaction Log ‚Äî ${escHtml(f)} ‚Üí ${escHtml(t)}</div>
    ${allColls.length===0?`<p style="color:var(--text2);font-size:13px;">No transactions in this range.</p>`:`
    <div class="tbl-wrap"><table>
      <thead><tr>
        <th>Date</th><th>Invoice No</th><th>Module</th><th>Patient</th>
        <th>Amount (‡ß≥)</th>${isAdmin?'<th>Received By</th>':''}<th>Note</th>
      </tr></thead>
      <tbody>${allColls.map(c=>`<tr>
        <td style="white-space:nowrap;font-size:11px;">${c.receiveDate||'‚Äî'}</td>
        <td style="font-family:var(--mono);color:var(--teal);font-weight:600;">${escHtml(c.invoiceNo||'‚Äî')}</td>
        <td><span class="badge ${modBadge(c.invoiceType)}">${escHtml(c.invoiceType||'‚Äî')}</span></td>
        <td style="font-weight:500;">${escHtml(c.patient||'‚Äî')}</td>
        <td style="font-family:var(--mono);color:var(--green);font-weight:700;">‡ß≥${(c.amount||0).toLocaleString()}</td>
        ${isAdmin?`<td style="font-weight:500;color:var(--navy);">${escHtml(c.receivedByName||c.receivedBy||'‚Äî')}</td>`:''}
        <td style="font-size:11px;color:var(--text2);">${escHtml(c.note||'‚Äî')}</td>
      </tr>`).join('')}</tbody>
    </table></div>`}
  </div>`;
}

function showUserCollDetail(userId){
  const f=document.getElementById('uc_f')?.value||'';
  const t=document.getElementById('uc_t')?.value||'';
  const data = _getUserCollData(f,t,'',userId);
  const total = data.reduce((s,c)=>s+(c.amount||0),0);
  const userName = data[0]?.receivedByName||userId;
  // Show in notification + detail panel if admin
  N(`${userName}: ${data.length} transaction(s) | Total: ‡ß≥${total.toLocaleString()}`);
}

function printUserCollReport(){
  const out=document.getElementById('uc_out');
  if(!out||!out.querySelector('table')){N('Generate report first.',true);return;}
  const clinic=getClinic(S.cid)||{};
  const f=document.getElementById('uc_f')?.value||'‚Äî';
  const t=document.getElementById('uc_t')?.value||'‚Äî';
  const w=window.open('','_blank','width=1100,height=1200');
  if(!w){N('Pop-up blocked.',true);return;}
  w.document.write(`<!DOCTYPE html><html><head><title>User Collection Report</title>
  <style>
    body{font-family:Arial,sans-serif;padding:28px;color:#000;font-size:10pt;}
    h2{font-size:16pt;margin:0;} .sub{font-size:9pt;color:#555;margin-bottom:16px;}
    table{width:100%;border-collapse:collapse;margin-bottom:14px;}
    th,td{border:1px solid #ccc;padding:4px 7px;font-size:9pt;} th{background:#f0f0f0;font-weight:bold;}
    .badge{display:inline-block;padding:1px 6px;border-radius:3px;font-size:8pt;font-weight:600;}
    .b-warn{background:#fff3cd;color:#856404;} .b-active{background:#d1e7dd;color:#0a3622;}
    .b-info{background:#cff4fc;color:#055160;} .b-due{background:#f8d7da;color:#842029;} .b-purple{background:#f3e8ff;color:#6d28d9;}
    .acc-cards{display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap;}
    .acc-card{border:1px solid #ccc;border-radius:6px;padding:12px 16px;min-width:120px;text-align:center;}
    .an{font-size:16pt;font-weight:bold;} .al{font-size:8pt;color:#555;}
    .box{border:1px solid #ddd;border-radius:6px;padding:12px;margin-bottom:12px;}
    .box-title{font-size:9pt;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#555;margin-bottom:8px;}
    @media print{@page{margin:0.5in;}}
  </style></head><body>
  <div style="text-align:center;border-bottom:2px solid #000;padding-bottom:10px;margin-bottom:14px;">
    <h2>${escHtml(clinic.header||clinic.name||'CLINIC')}</h2>
    <div class="sub">User-wise Collection Report &nbsp;|&nbsp; ${escHtml(f)} to ${escHtml(t)}</div>
  </div>
  ${out.innerHTML}
  <div style="margin-top:20px;border-top:1px dashed #999;padding-top:8px;font-size:8pt;color:#777;display:flex;justify-content:space-between;">
    <span>Generated by: ${escHtml(S.name||S.u)}</span>
    <span>Asad Kit BD v17 &nbsp;|&nbsp; ${new Date().toLocaleString('en-GB')}</span>
  </div>
  </body></html>`);
  w.document.close();
  setTimeout(()=>{w.print();},600);
}


function rRptInv(){
  document.getElementById('wsBody').innerHTML=`
  <div class="bar">
    From:<input type="date" id="rf1" value="${new Date().getFullYear()+'-01-01'}" style="color:var(--text);">
    To:<input type="date" id="rt1" value="${new Date().toISOString().split('T')[0]}" style="color:var(--text);">
    <button class="btn btn-t btn-sm" onclick="genRpt1()">Generate</button>
  </div>
  <div id="r1out"><p style="color:var(--gray);font-size:13px;">Click Generate to load report.</p></div>`;
}
function genRpt1(){
  const f=document.getElementById('rf1')?.value,t=document.getElementById('rt1')?.value;
  const data=myInvs().filter(i=>i.date>=f&&i.date<=t);
  document.getElementById('r1out').innerHTML=`<div class="tbl-wrap"><table>
    <thead><tr><th>Invoice</th><th>Date</th><th>Patient</th><th>Tests</th><th>Total</th><th>Discount</th><th>Paid</th><th>Due</th><th></th></tr></thead>
    <tbody>${buildInvRows(data)}</tbody>
  </table></div>${data.length===0?'<p style="color:var(--gray);padding:12px;font-size:13px;">No records found.</p>':''}`;
}
function rRptLab(){
  document.getElementById('wsBody').innerHTML=`
  <div class="bar"><input placeholder="Search patient..." style="flex:1;" oninput="fRptLab(this.value)"></div>
  <div class="tbl-wrap" id="lab-rpt-wrap"><table>
    <thead><tr><th>Patient</th><th>Tests</th><th>Invoice</th><th>Date</th><th>Status</th><th></th></tr></thead>
    <tbody id="lab-rpt-tb">${myInvs().map(v=>`<tr>
      <td style="font-weight:500">${escHtml(v.patient)}</td>
      <td style="font-size:11px;color:var(--text2)">${v.tests.slice(0,3).map(id=>escHtml(getTestById(id)?.name||'')).filter(Boolean).join(', ')}${v.tests.length>3?` +${v.tests.length-3}`:''}</td>
      <td style="font-family:var(--mono);color:var(--teal)">${v.no}</td>
      <td>${v.date}</td>
      <td><span class="badge b-active">Ready</span></td>
      <td><button class="btn btn-o btn-sm" onclick="reviewInvoice('${v.id}')">üëÅ</button></td>
    </tr>`).join('')||`<tr><td colspan="6" style="text-align:center;color:var(--text2)">No data.</td></tr>`}</tbody>
  </table></div>`;
}
function fRptLab(q){
  const tb=document.getElementById('lab-rpt-tb'); if(!tb) return;
  const data=myInvs().filter(i=>i.patient.toLowerCase().includes(q.toLowerCase()));
  tb.innerHTML=data.map(v=>`<tr>
    <td style="font-weight:500">${escHtml(v.patient)}</td>
    <td style="font-size:11px;color:var(--text2)">${v.tests.slice(0,3).map(id=>escHtml(getTestById(id)?.name||'')).filter(Boolean).join(', ')}${v.tests.length>3?` +${v.tests.length-3}`:''}</td>
    <td style="font-family:var(--mono);color:var(--teal)">${v.no}</td>
    <td>${v.date}</td>
    <td><span class="badge b-active">Ready</span></td>
    <td><button class="btn btn-o btn-sm" onclick="reviewInvoice('${v.id}')">üëÅ</button></td>
  </tr>`).join('')||`<tr><td colspan="6" style="text-align:center;color:var(--text2)">No data.</td></tr>`;
}
function rRptDate(){
  document.getElementById('wsBody').innerHTML=`
  <div class="bar">
    From:<input type="date" id="dw_f" value="${new Date().getFullYear()+'-01-01'}" style="color:var(--text);">
    To:<input type="date" id="dw_t" value="${new Date().toISOString().split('T')[0]}" style="color:var(--text);">
    <button class="btn btn-t btn-sm" onclick="genDW()">Generate</button>
  </div>
  <div id="dw_out"><p style="color:var(--gray);font-size:13px;">Click Generate.</p></div>`;
}
function genDW(){
  const f=document.getElementById('dw_f')?.value,t=document.getElementById('dw_t')?.value;
  const invs=myInvs().filter(i=>i.date>=f&&i.date<=t);
  const bd={};
  invs.forEach(i=>{
    if(!bd[i.date])bd[i.date]={c:0,tot:0,paid:0,due:0};
    bd[i.date].c++;bd[i.date].tot+=i.subtotal;bd[i.date].paid+=i.paid;bd[i.date].due+=i.due;
  });
  document.getElementById('dw_out').innerHTML=Object.keys(bd).length===0?'<p style="color:var(--gray);font-size:13px;">No data found.</p>':`
  <div class="tbl-wrap"><table>
    <thead><tr><th>Date</th><th>Invoices</th><th>Total Bills</th><th>Collected</th><th>Due</th></tr></thead>
    <tbody>${Object.entries(bd).sort().map(([d,v])=>`<tr>
      <td style="font-weight:500">${d}</td>
      <td style="font-family:var(--mono)">${v.c}</td>
      <td style="font-family:var(--mono)">‡ß≥${v.tot.toLocaleString()}</td>
      <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
      <td><span class="badge ${v.due>0?'b-due':'b-active'}">‡ß≥${v.due.toLocaleString()}</span></td>
    </tr>`).join('')}</tbody>
  </table></div>`;
}
function rDailyExport(){
  const today=new Date().toISOString().split('T')[0];
  document.getElementById('wsBody').innerHTML=`
  <div class="box" style="max-width:640px;">
    <div class="box-title">Daily Closing &amp; Export</div>
    <p style="font-size:12px;color:var(--text2);margin-bottom:14px;">Export all invoices, receipts, and collections for a specific date to Google Sheet or Excel.</p>
    <div class="fi" style="margin-bottom:16px;"><label>Export Date</label>
      <input type="date" id="exp_date_ws" value="${today}">
    </div>
    <div class="action-row">
      <button class="btn btn-o" onclick="exportToGSheetWS()">üìä Export to Google Sheet</button>
      <button class="btn btn-t" onclick="exportToExcelWS()">‚¨á Download Excel (.xlsx)</button>
    </div>
    <div id="export_result" style="margin-top:14px;"></div>
  </div>`;
}
async function exportToGSheetWS(){
  const date=document.getElementById('exp_date_ws')?.value;
  if(!date){N('Select export date.',true);return;}
  const result=await GS.exportDaily(S.cid,date);
  document.getElementById('export_result').innerHTML=`<div style="padding:10px;border-radius:6px;background:${result.ok?'rgba(6,214,160,.1)':'rgba(239,71,111,.1)'};color:${result.ok?'var(--green)':'var(--red)'};font-size:12px;">${result.ok?'‚úì':'‚ùå'} ${result.msg}</div>`;
  if(result.ok) N('‚úì Export sent to Google Sheet.');
  else N(result.msg,true);
}
function exportToExcelWS(){
  const date=document.getElementById('exp_date_ws')?.value;
  if(!date){N('Select export date.',true);return;}
  exportExcelFile(S.cid,date);
}
function exportToGSheet(){
  const date=document.getElementById('exp_date')?.value||new Date().toISOString().split('T')[0];
  (async()=>{
    const result=await GS.exportDaily(S?.cid,date);
    N(result.ok?'‚úì Export sent.':result.msg,!result.ok);
  })();
}
function exportToExcel(){
  const date=document.getElementById('exp_date')?.value||new Date().toISOString().split('T')[0];
  exportExcelFile(S?.cid,date);
}
function exportExcelFile(cid,date){
  const invs=DB.getBy('invoices','cid',cid).filter(i=>i.date===date);
  const logs=DB.get('due_log').filter(d=>{const inv=DB.findOne('invoices',i=>i.id===d.invId);return inv?.cid===cid&&d.date===date;});
  if(!invs.length&&!logs.length){N('No data found for '+date,true);return;}
  const clinic=getClinic(cid)||{};
  let content=`Asad Kit BD ‚Äî Daily Report\t${date}\t${clinic.name||''}\n\n`;
  content+=`INVOICES\nInvoice No\tDate\tPatient\tPhone\tAge\tGender\tTests\tSubtotal\tDiscount\tPaid\tDue\tStatus\n`;
  invs.forEach(v=>{
    const testNames=v.tests.map(id=>getTestById(id)?.name||'').filter(Boolean).join('; ');
    content+=`${v.no}\t${v.date}\t${v.patient}\t${v.phone}\t${v.age}\t${v.gender}\t${testNames}\t${v.subtotal}\t${v.discount}\t${v.paid}\t${v.due}\t${v.status}\n`;
  });
  content+=`\nCOLLECTION RECEIPTS\nReceipt No\tInvoice No\tPatient\tAmount\tPrev Due\tRemaining\tDate\tBy\n`;
  logs.forEach(d=>{
    const inv=DB.findOne('invoices',i=>i.id===d.invId);
    content+=`${d.rcNo||'‚Äî'}\t${inv?.no||'‚Äî'}\t${inv?.patient||'‚Äî'}\t${d.amount}\t${d.prevDue||0}\t${d.remainDue||0}\t${d.date}\t${d.by}\n`;
  });
  const tot=invs.reduce((s,i)=>s+i.subtotal,0);
  const paid=invs.reduce((s,i)=>s+i.paid,0);
  const due=invs.reduce((s,i)=>s+i.due,0);
  content+=`\nSUMMARY\nTotal Bills\t‡ß≥${tot}\nTotal Collected\t‡ß≥${paid}\nTotal Due\t‡ß≥${due}\n`;
  content+=`\nSoftware By: Asad Kit BD v17\tExported: ${new Date().toLocaleString('en-GB')}\n`;
  const blob=new Blob(['\uFEFF'+content],{type:'application/vnd.ms-excel;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`AsadKitBD_Daily_Report_${date}.xls`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  N(`‚úì Excel file downloaded: AsadKitBD_Daily_Report_${date}.xls`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rSetClinic(){
  if(!['admin','superadmin'].includes(S?.role)){
    document.getElementById('wsBody').innerHTML='<div class="box"><p style="color:var(--amber);">‚ö† Only Clinic Admin can edit clinic profile.</p></div>';return;
  }
  const c=getClinic(S.cid)||{};
  document.getElementById('wsBody').innerHTML=`
  <div class="box" style="max-width:640px;">
    <div class="box-title">Clinic Profile</div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Clinic Name</label><input id="cp_n" value="${escHtml(c.name||'')}"></div>
      <div class="fi"><label>Phone</label><input id="cp_ph" value="${escHtml(c.phone||'')}"></div>
    </div>
    <div class="fi" style="margin-bottom:12px;"><label>Address</label><input id="cp_a" value="${escHtml(c.address||'')}"></div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Email</label><input id="cp_e" value="${escHtml(c.email||'')}"></div>
      <div class="fi"><label>Invoice Header</label><input id="cp_h" value="${escHtml(c.header||'')}"></div>
    </div>
    <div class="fi" style="margin-bottom:16px;"><label>Clinic Logo</label>
      <div style="display:flex;gap:10px;align-items:center;">
        <input type="file" id="cp_l_file" accept="image/*" onchange="handleLogoUpload(this)" style="flex:1;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:7px;font-size:12px;">
        ${c.logo?`<img src="${escHtml(c.logo)}" style="height:40px;border-radius:4px;border:1px solid var(--border);" alt="Logo">`:
        '<span style="font-size:12px;color:var(--text3);">No logo uploaded</span>'}
      </div>
      <input type="hidden" id="cp_l" value="${escHtml(c.logo||'')}">
    </div>
    <div class="fi" style="margin-bottom:16px;"><label>Invoice / Receipt Print Size</label>
      <select id="cp_print_size">
        <option value="long" ${(c.printSize||'long')==='long'?'selected':''}>A4 / Letter (8.5√ó11 inch ‚Äî Recommended)</option>
        <option value="short" ${c.printSize==='short'?'selected':''}>80mm Thermal Receipt</option>
        <option value="custom" ${c.printSize==='custom'?'selected':''}>Custom 8√ó12 inch</option>
      </select>
    </div>
    <!-- PRINT CUSTOMIZATION PANEL v13 -->
    <div style="background:var(--teal-light);border:1px solid rgba(0,150,199,.2);border-radius:8px;padding:14px;margin-bottom:16px;">
      <div class="box-title" style="margin-bottom:12px;">üñ® Print Customization (Admin)</div>
      <div class="f4" style="margin-bottom:10px;">
        <div class="fi"><label>Font Size (pt)</label>
          <input id="cp_ps_fontsize" type="number" min="7" max="16" value="${(c.printSettings||{}).fontSize||'11'.replace('pt','')}" placeholder="11">
        </div>
        <div class="fi"><label>Line Height</label>
          <input id="cp_ps_lineheight" type="number" min="1.0" max="2.5" step="0.1" value="${(c.printSettings||{}).lineHeight||'1.6'}" placeholder="1.6">
        </div>
        <div class="fi"><label>Header Spacing (px)</label>
          <input id="cp_ps_headspace" type="number" min="0" max="40" value="${(c.printSettings||{}).headerSpacing||'10'}" placeholder="10">
        </div>
        <div class="fi"><label>Footer Spacing (px)</label>
          <input id="cp_ps_footspace" type="number" min="0" max="40" value="${(c.printSettings||{}).footerSpacing||'16'}" placeholder="16">
        </div>
      </div>
      <div class="f2">
        <div class="fi"><label>Auto-Scale to Fit Page</label>
          <select id="cp_ps_autoscale">
            <option value="on" ${(c.printSettings||{}).autoScale!==false?'selected':''}>ON (Recommended)</option>
            <option value="off" ${(c.printSettings||{}).autoScale===false?'selected':''}>OFF</option>
          </select>
        </div>
        <div class="fi"><label>Invoice Width</label>
          <select id="cp_ps_width">
            <option value="7.5in" ${((c.printSettings||{}).invoiceWidth||'7.5in')==='7.5in'?'selected':''}>7.5 inch (Letter default)</option>
            <option value="7in" ${(c.printSettings||{}).invoiceWidth==='7in'?'selected':''}>7 inch</option>
            <option value="80mm" ${(c.printSettings||{}).invoiceWidth==='80mm'?'selected':''}>80mm (Thermal)</option>
          </select>
        </div>
      </div>
    </div>
    <div class="action-row"><button class="btn btn-t" onclick="saveClinic()">üíæ Save Profile</button></div>
  </div>`;
}
function handleLogoUpload(input){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const el=document.getElementById('cp_l');
    if(el) el.value=e.target.result;
    N('‚úì Logo loaded. Save profile to apply.');
  };
  reader.readAsDataURL(file);
}
function saveClinic(){
  try{
    const fs=document.getElementById('cp_ps_fontsize')?.value;
    const printSettings={
      fontSize:(fs?(fs+'pt'):'11pt'),
      lineHeight:parseFloat(document.getElementById('cp_ps_lineheight')?.value||'1.6'),
      headerSpacing:parseInt(document.getElementById('cp_ps_headspace')?.value||'10',10),
      footerSpacing:parseInt(document.getElementById('cp_ps_footspace')?.value||'16',10),
      autoScale:document.getElementById('cp_ps_autoscale')?.value!=='off',
      invoiceWidth:document.getElementById('cp_ps_width')?.value||'7.5in',
    };
    DB.update('clinics',c=>c.id===S.cid,{
      name:document.getElementById('cp_n')?.value||'',
      phone:document.getElementById('cp_ph')?.value||'',
      address:document.getElementById('cp_a')?.value||'',
      email:document.getElementById('cp_e')?.value||'',
      header:document.getElementById('cp_h')?.value||'',
      logo:document.getElementById('cp_l')?.value||'',
      printSize:document.getElementById('cp_print_size')?.value||'long',
      printSettings,
    });
    const c=getClinic(S.cid);
    S.cliName=c.name;
    sessionStorage.setItem('akbd_session',JSON.stringify(S));
    document.getElementById('tbTitle').textContent=c.name;
    document.getElementById('dashClinic').textContent=c.name;
    N('‚úì Clinic profile & print settings saved.');
  }catch(e){N('Save failed: '+e.message,true);}
}
function rSetPersonnel(){
  if(!canManagePersonnel()){
    document.getElementById('wsBody').innerHTML='<div class="box"><p style="color:var(--amber);">‚ö† Only Clinic Admin can manage users.</p></div>';return;
  }
  renderPersonnelList();
}
function renderPersonnelList(){
  const users=S.role==='superadmin'?allUsers():DB.getBy('users','cid',S.cid);
  const canDelete=['admin','superadmin'].includes(S?.role);
  document.getElementById('wsBody').innerHTML=`
  <div class="box">
    <div class="box-title">Personnel ‚Äî ${S.role==='superadmin'?'All Clinics':S.cliName||'This Clinic'}</div>
    <div class="tbl-wrap" style="margin-bottom:14px;"><table>
      <thead><tr><th>Username</th><th>Name</th><th>Role</th><th>Clinic</th><th>Status</th>${canDelete?'<th>Actions</th>':''}</tr></thead>
      <tbody id="userListTb">${buildUserRows(users,canDelete)}</tbody>
    </table></div>
    <div style="margin-top:14px;"><button class="btn btn-t btn-sm" onclick="showAddUserForm()">+ Add User</button></div>
  </div>
  <div id="add-user-area"></div>`;
}
function buildUserRows(users,canDelete){
  return users.map(u=>{
    const clinic=getClinic(u.cid);
    const canDelThis=S.role==='superadmin'||(S.role==='admin'&&u.cid===S.cid&&u.u!==S.u);
    const canReset=S.role==='superadmin'||(S.role==='admin'&&u.cid===S.cid&&u.u!==S.u);
    return`<tr>
      <td style="font-family:var(--mono)">${escHtml(u.u)}</td>
      <td style="font-weight:500">${escHtml(u.name)}</td>
      <td><span class="badge b-warn">${u.role}</span></td>
      <td style="font-size:11px;color:var(--teal)">${escHtml(clinic?.name||u.cid)}</td>
      <td><span class="badge ${u.status==='active'?'b-active':'b-due'}">${u.status||'active'}</span></td>
      ${canDelete?`<td style="white-space:nowrap">${canReset?`<button class="btn btn-o btn-sm" onclick="openAdminResetPw('${u.id}','${escHtml(u.u)}','${escHtml(u.name)}')">üîë Reset PW</button>`:''}${canDelThis?`<button class="btn btn-r btn-sm" onclick="deleteUser('${u.id}')">üóë</button>`:'<span style="color:var(--gray);font-size:11px"></span>'}</td>`:''}
    </tr>`;
  }).join('')||'<tr><td colspan="6" style="color:var(--gray);text-align:center;padding:16px;">No users.</td></tr>';
}
function showAddUserForm(){
  const area=document.getElementById('add-user-area');
  if(!area) return;
  area.innerHTML=`
  <div class="box" id="add-user-form">
    <div class="box-title">Create New User</div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Full Name *</label><input id="nu_name" placeholder="e.g. Reception Staff" autofocus></div>
      <div class="fi"><label>Username *</label><input id="nu_user" placeholder="e.g. reception_002" autocomplete="off"></div>
    </div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Role *</label>
        <select id="nu_role">
          <option value="">‚Äî Select Role ‚Äî</option>
          <option value="reception">Reception</option>
          <option value="lab">Lab Staff</option>
          <option value="accounts">Accounts</option>
          <option value="opd">OPD Staff</option>
          <option value="indoor">Indoor Staff</option>
          ${S.role==='superadmin'?'<option value="admin">Clinic Admin</option>':''}
        </select>
      </div>
      <div class="fi"><label>Password *</label><input type="password" id="nu_pass" placeholder="Minimum 6 characters" autocomplete="new-password"></div>
    </div>
    <div id="nu_err" style="min-height:16px;font-size:12px;color:var(--red);margin-bottom:10px;"></div>
    <div class="action-row">
      <button class="btn btn-t" id="btn-add-user" onclick="saveNewUser()">üíæ Create User</button>
      <button class="btn btn-o" onclick="document.getElementById('add-user-area').innerHTML=''">Cancel</button>
    </div>
  </div>`;
}
async function saveNewUser(){
  const name=document.getElementById('nu_name')?.value?.trim();
  const uname=document.getElementById('nu_user')?.value?.trim();
  const role=document.getElementById('nu_role')?.value;
  const pass=document.getElementById('nu_pass')?.value;
  const errEl=document.getElementById('nu_err');
  const errs=[];
  if(!name) errs.push('Full Name');
  if(!uname) errs.push('Username');
  if(!role) errs.push('Role');
  if(!pass) errs.push('Password');
  if(pass&&pass.length<6) errs.push('Password (min 6 chars)');
  if(errs.length){errEl.textContent='Required: '+errs.join(', ');return;}
  if(DB.findOne('users',u=>u.u.toLowerCase()===uname.toLowerCase())){errEl.textContent=`Username "${uname}" already taken.`;return;}
  if(uname.toLowerCase()==='superadmin'){errEl.textContent='This username is reserved.';return;}
  const btn=document.getElementById('btn-add-user');
  if(btn){btn.textContent='‚è≥ Creating‚Ä¶';btn.disabled=true;}
  errEl.textContent='';
  try{
    DB.insert('users',{
      id:uid(), u:uname, p:await hashPassword(pass),
      name, role, cid:S.cid, status:'active',
      createdBy:S.u, createdAt:new Date().toISOString()
    });
    N(`‚úì User "${uname}" created successfully.`);
    document.getElementById('add-user-area').innerHTML='';
    renderPersonnelList();
  }catch(e){
    errEl.textContent='Failed: '+e.message;
  }finally{
    if(btn){btn.textContent='üíæ Create User';btn.disabled=false;}
  }
}
async function deleteUser(id){
  const target=DB.findOne('users',u=>u.id===id);
  if(!target){N('User not found.',true);return;}
  if(S.role!=='superadmin'&&target.cid!==S.cid){N('Permission denied.',true);return;}
  if(target.u===S.u){N('Cannot delete your own account.',true);return;}
  if(!confirm(`Delete user "${target.u}"? This cannot be undone.`)) return;
  try{DB.delete('users',u=>u.id===id);N(`‚úì User "${target.u}" deleted.`);renderPersonnelList();}
  catch(e){N('Delete failed: '+e.message,true);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DOCTORS MODULE (NEW ‚Äî FULLY FUNCTIONAL) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rSetDoctors(){
  if(!canManagePersonnel()){
    document.getElementById('wsBody').innerHTML='<div class="box"><p style="color:var(--amber);">‚ö† Only Clinic Admin can manage doctors.</p></div>';return;
  }
  renderDoctorsList();
}
function renderDoctorsList(){
  const docs=myDoctors();
  document.getElementById('wsBody').innerHTML=`
  <div class="box">
    <div class="box-title" style="display:flex;justify-content:space-between;align-items:center;">
      <span>Doctors (${docs.length})</span>
      <button class="btn btn-t btn-sm" onclick="openAddDoctor()">+ Add Doctor</button>
    </div>
    ${docs.length===0?'<p style="color:var(--gray);font-size:13px;">No doctors added yet.</p>':''}
    ${docs.length>0?`<div class="tbl-wrap"><table>
      <thead><tr><th>Name</th><th>Degree</th><th>Department</th><th>Phone</th><th>Reg No</th><th>Actions</th></tr></thead>
      <tbody>${docs.map(d=>`<tr>
        <td style="font-weight:600">${escHtml(d.name)}</td>
        <td style="font-size:11px;color:var(--purple)">${escHtml(d.degree||'‚Äî')}</td>
        <td><span class="badge b-paid">${escHtml(d.dept||'‚Äî')}</span></td>
        <td>${escHtml(d.phone||'‚Äî')}</td>
        <td style="font-size:11px;color:var(--text2)">${escHtml(d.reg||'‚Äî')}</td>
        <td style="white-space:nowrap">
          <button class="btn btn-o btn-sm" onclick="openEditDoctor('${d.id}')">‚úèÔ∏è Edit</button>
          ${S.role==='superadmin'?`<button class="btn btn-r btn-sm" onclick="deleteDoctor('${d.id}')">üóë</button>`:''}
        </td>
      </tr>`).join('')}</tbody>
    </table></div>`:''}
  </div>`;
}
function openAddDoctor(){
  document.getElementById('doc_id').value='';
  document.getElementById('doc_name').value='';
  document.getElementById('doc_degree').value='';
  document.getElementById('doc_dept').value='';
  document.getElementById('doc_phone').value='';
  document.getElementById('doc_reg').value='';
  document.getElementById('doc-modal-title').textContent='üë®‚Äç‚öïÔ∏è Add Doctor';
  openModal('m-edit-doctor');
}
function openEditDoctor(id){
  const d=DB.findOne('doctors',x=>x.id===id); if(!d){N('Doctor not found.',true);return;}
  document.getElementById('doc_id').value=d.id;
  document.getElementById('doc_name').value=d.name||'';
  document.getElementById('doc_degree').value=d.degree||'';
  document.getElementById('doc_dept').value=d.dept||'';
  document.getElementById('doc_phone').value=d.phone||'';
  document.getElementById('doc_reg').value=d.reg||'';
  document.getElementById('doc-modal-title').textContent='‚úèÔ∏è Edit Doctor';
  openModal('m-edit-doctor');
}
function saveDoctor(){
  const id=document.getElementById('doc_id').value;
  const name=document.getElementById('doc_name').value.trim();
  const degree=document.getElementById('doc_degree').value.trim();
  const dept=document.getElementById('doc_dept').value.trim();
  if(!name||!degree||!dept){N('Name, Degree, and Department are required.',true);return;}
  const btn=document.querySelector('#m-edit-doctor .btn-t');
  if(btn){btn.textContent='‚è≥ Saving‚Ä¶';btn.disabled=true;}
  try{
    if(id){
      // Edit existing
      DB.update('doctors',d=>d.id===id,{name,degree,dept,
        phone:document.getElementById('doc_phone').value.trim(),
        reg:document.getElementById('doc_reg').value.trim(),
        updatedBy:S.u,updatedAt:new Date().toISOString()});
      N(`‚úì Doctor "${name}" updated.`);
    } else {
      // Add new
      DB.insert('doctors',{
        id:uid(),cid:S.cid,name,degree,dept,
        phone:document.getElementById('doc_phone').value.trim(),
        reg:document.getElementById('doc_reg').value.trim(),
        addedBy:S.u,addedAt:new Date().toISOString()
      });
      N(`‚úì Doctor "${name}" added.`);
    }
    closeModal('m-edit-doctor');
    renderDoctorsList();
  }catch(e){
    N('Save failed: '+e.message,true);
  }finally{
    if(btn){btn.textContent='üíæ Save Doctor';btn.disabled=false;}
  }
}
async function deleteDoctor(id){
  if(S.role!=='superadmin'){N('Only Super Admin can delete doctors.',true);return;}
  const d=DB.findOne('doctors',x=>x.id===id); if(!d) return;
  if(!confirm(`Delete doctor "${d.name}"?`)) return;
  try{DB.delete('doctors',x=>x.id===id);N(`‚úì Doctor "${d.name}" deleted.`);renderDoctorsList();}
  catch(e){N('Delete failed: '+e.message,true);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTHORIZED PERSONS MODULE (FIXED) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rSetAuth(){
  if(!canManagePersonnel()){
    document.getElementById('wsBody').innerHTML='<div class="box"><p style="color:var(--amber);">‚ö† Only Clinic Admin can manage authorized persons.</p></div>';return;
  }
  renderAuthPersons();
}
function renderAuthPersons(){
  const persons=myAuthorized();
  document.getElementById('wsBody').innerHTML=`
  <div class="box">
    <div class="box-title" style="display:flex;justify-content:space-between;align-items:center;">
      <span>Authorized Persons / Referring Doctors (${persons.length})</span>
      <button class="btn btn-t btn-sm" onclick="showAddAuthForm()">+ Add Authorized Person</button>
    </div>
    ${persons.length===0?'<p style="color:var(--gray);font-size:13px;margin-bottom:14px;">No authorized persons registered yet.</p>':''}
    ${persons.length>0?`<div class="tbl-wrap" style="margin-bottom:14px;"><table>
      <thead><tr><th>Name</th><th>Designation</th><th>Phone</th><th>Registered</th><th>Actions</th></tr></thead>
      <tbody>${persons.map(p=>`<tr>
        <td style="font-weight:500">${escHtml(p.name)}</td>
        <td style="font-size:11px;color:var(--text2)">${escHtml(p.designation)}</td>
        <td>${escHtml(p.phone)}</td>
        <td style="font-size:11px;color:var(--text2)">${p.reg}</td>
        <td style="white-space:nowrap">
          <button class="btn btn-o btn-sm" onclick="editAuthPerson('${p.id}')">‚úèÔ∏è Edit</button>
          <button class="btn btn-r btn-sm" onclick="deleteAuthPerson('${p.id}')">Delete</button>
        </td>
      </tr>`).join('')}</tbody>
    </table></div>`:''}
    <div id="add-auth-area"></div>
  </div>`;
}
function showAddAuthForm(){
  const area=document.getElementById('add-auth-area');
  if(!area) return;
  area.innerHTML=`
  <div class="box" id="auth-form" style="background:rgba(0,180,216,.04);border-color:rgba(0,180,216,.2);">
    <div class="box-title">Add Authorized Person</div>
    <input type="hidden" id="ap_edit_id" value="">
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Full Name *</label><input id="ap_name" placeholder="Dr. Full Name" autofocus></div>
      <div class="fi"><label>Designation *</label><input id="ap_desig" placeholder="e.g. MBBS, FCPS (Medicine)"></div>
    </div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Phone</label><input id="ap_phone" placeholder="01X00-000000"></div>
      <div class="fi"><label>Registration No</label><input id="ap_reg" placeholder="Medical registration no."></div>
    </div>
    <div class="action-row">
      <button class="btn btn-t" id="btn-add-ap" onclick="saveAuthPerson()">üíæ Save Person</button>
      <button class="btn btn-o" onclick="document.getElementById('add-auth-area').innerHTML=''">Cancel</button>
    </div>
  </div>`;
}
function editAuthPerson(id){
  const p=DB.findOne('authorized_persons',x=>x.id===id); if(!p) return;
  showAddAuthForm();
  setTimeout(()=>{
    document.getElementById('ap_edit_id').value=id;
    document.getElementById('ap_name').value=p.name;
    document.getElementById('ap_desig').value=p.designation;
    document.getElementById('ap_phone').value=p.phone||'';
    document.getElementById('ap_reg').value=p.reg||'';
  },50);
}
async function saveAuthPerson(){
  const editId=document.getElementById('ap_edit_id')?.value;
  const name=document.getElementById('ap_name')?.value?.trim();
  const desig=document.getElementById('ap_desig')?.value?.trim();
  if(!name||!desig){N('Name and Designation are required.',true);return;}
  const btn=document.getElementById('btn-add-ap');
  if(btn){btn.textContent='‚è≥ Saving‚Ä¶';btn.disabled=true;}
  try{
    if(editId){
      DB.update('authorized_persons',x=>x.id===editId,{
        name, designation:desig,
        phone:document.getElementById('ap_phone')?.value?.trim()||'',
        reg:document.getElementById('ap_reg')?.value?.trim()||new Date().toISOString().split('T')[0],
        updatedBy:S.u, updatedAt:new Date().toISOString()
      });
      N(`‚úì "${name}" updated.`);
    } else {
      DB.insert('authorized_persons',{
        id:uid(), cid:S.cid, name, designation:desig,
        phone:document.getElementById('ap_phone')?.value?.trim()||'',
        reg:document.getElementById('ap_reg')?.value?.trim()||new Date().toISOString().split('T')[0],
        addedBy:S.u, addedAt:new Date().toISOString()
      });
      N(`‚úì "${name}" added.`);
    }
    document.getElementById('add-auth-area').innerHTML='';
    renderAuthPersons();
  }catch(e){
    N('Failed: '+e.message,true);
    if(btn){btn.textContent='üíæ Save Person';btn.disabled=false;}
  }
}
async function deleteAuthPerson(id){
  if(!canManagePersonnel()){N('Permission denied.',true);return;}
  const p=DB.findOne('authorized_persons',x=>x.id===id); if(!p) return;
  if(!confirm(`Delete "${p.name}"?`)) return;
  try{DB.delete('authorized_persons',x=>x.id===id);N(`‚úì "${p.name}" removed.`);renderAuthPersons();}
  catch(e){N('Delete failed: '+e.message,true);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GS CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rSetGS(){
  const url=localStorage.getItem('akbd_gs_url')||'';
  const sheetId=localStorage.getItem('akbd_gs_sheet_id')||'';
  document.getElementById('wsBody').innerHTML=`
  <div class="box" style="max-width:640px;">
    <div class="box-title">Google Sheets Integration</div>
    <div style="background:rgba(255,209,102,.08);border:1px solid rgba(255,209,102,.2);border-radius:7px;padding:12px;margin-bottom:16px;font-size:12px;color:var(--amber);">
      ‚ö† Google Sheets requires a deployed Google Apps Script Web App URL. All data syncs to your Sheet.
    </div>
    <div class="fi" style="margin-bottom:12px;"><label>Apps Script Web App URL</label>
      <input id="ws_gs_url" value="${escHtml(url)}" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
    </div>
    <div class="fi" style="margin-bottom:16px;"><label>Google Sheets ID (reference only)</label>
      <input id="ws_gs_sheet_id" value="${escHtml(sheetId)}" placeholder="Sheet ID from URL">
    </div>
    <div id="ws_gs_msg" style="font-size:12px;margin-bottom:12px;"></div>
    <div class="action-row">
      <button class="btn btn-o" onclick="wsTestGS()">Test Connection</button>
      <button class="btn btn-t" onclick="wsSaveGS()">üíæ Save Config</button>
      ${url?`<button class="btn btn-r" onclick="clearGSConfig()">‚úï Disconnect</button>`:''}
    </div>
    <div style="margin-top:16px;padding:12px;background:rgba(255,255,255,.03);border-radius:7px;font-size:11px;color:var(--text2);">
      <strong style="color:var(--text);">Apps Script Setup Guide:</strong><br>
      1. Open Google Sheets ‚Üí create sheet with tabs: Invoices, Test_Master, Test_Categories<br>
      2. Extensions ‚Üí Apps Script ‚Üí paste provided script code<br>
      3. Deploy ‚Üí New Deployment ‚Üí Web App ‚Üí Execute as: Me ‚Üí Access: Anyone<br>
      4. Copy Web App URL and paste above ‚Üí Save
    </div>
  </div>`;
}
async function wsTestGS(){
  const url=document.getElementById('ws_gs_url')?.value?.trim();
  if(!url){N('Enter URL first.',true);return;}
  document.getElementById('ws_gs_msg').innerHTML='<span style="color:var(--amber);">Testing connection‚Ä¶</span>';
  localStorage.setItem('akbd_gs_url',url);
  const res=await GS.testConnection();
  document.getElementById('ws_gs_msg').innerHTML=`<span style="color:${res.ok?'var(--green)':'var(--red)'};">${res.ok?'‚úì Connection OK':'‚ùå Connection failed'}: ${res.msg}</span>`;
}
function wsSaveGS(){
  const url=document.getElementById('ws_gs_url')?.value?.trim();
  const sid=document.getElementById('ws_gs_sheet_id')?.value?.trim();
  if(url) localStorage.setItem('akbd_gs_url',url);
  if(sid) localStorage.setItem('akbd_gs_sheet_id',sid);
  updateGSStatus(!!url);
  N(url?'‚úì Google Sheets config saved.':'‚úì Config cleared (using local storage).');
}
function clearGSConfig(){
  if(!confirm('Disconnect Google Sheets? Data stays local.')) return;
  localStorage.removeItem('akbd_gs_url');
  localStorage.removeItem('akbd_gs_sheet_id');
  updateGSStatus(false);
  N('‚úì Google Sheets disconnected.');
  rSetGS();
}
function updateGSStatus(connected){
  const el=document.getElementById('gsStatus');
  if(!el) return;
  if(connected){el.className='gs-indicator gs-connected';el.textContent='‚òÅ GSheet';}
  else{el.className='gs-indicator gs-local';el.textContent='üíæ Local';}
}

// GS modal functions
function testGSConnection(){
  const url=document.getElementById('gs_url')?.value?.trim()||'';
  if(!url){document.getElementById('gs_status_msg').innerHTML='<span style="color:var(--red);">Enter a URL first.</span>';return;}
  localStorage.setItem('akbd_gs_url',url);
  document.getElementById('gs_status_msg').innerHTML='<span style="color:var(--amber);">Testing‚Ä¶</span>';
  GS.testConnection().then(res=>{
    document.getElementById('gs_status_msg').innerHTML=`<span style="color:${res.ok?'var(--green)':'var(--red)'};">${res.ok?'‚úì Connected':'‚ùå Failed'}: ${res.msg}</span>`;
    if(res.ok) updateGSStatus(true);
  });
}
function saveGSConfig(){
  const url=document.getElementById('gs_url')?.value?.trim();
  const sid=document.getElementById('gs_sheet_id')?.value?.trim();
  if(url) localStorage.setItem('akbd_gs_url',url);
  if(sid) localStorage.setItem('akbd_gs_sheet_id',sid);
  updateGSStatus(!!url);
  N(url?'‚úì Config saved.':'‚úì Cleared.','');
  closeModal('m-gs-config');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUPER ADMIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSA(){
  const clinics=allClinics();
  const users=allUsers();
  const invs=DB.get('invoices');
  const totalColl=invs.reduce((s,i)=>s+i.paid,0);
  document.getElementById('sa_nc').textContent=clinics.length;
  document.getElementById('sa_nu').textContent=users.length;
  document.getElementById('sa_ni').textContent=invs.length;
  document.getElementById('sa_nc2').textContent='‡ß≥'+totalColl.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
  const tbody=document.getElementById('sa_tbody');
  if(tbody){
    tbody.innerHTML=clinics.map((c,i)=>{
      const cinvs=DB.getBy('invoices','cid',c.id);
      const cusers=DB.getBy('users','cid',c.id);
      const coll=cinvs.reduce((s,v)=>s+v.paid,0);
      const due=cinvs.reduce((s,v)=>s+v.due,0);
      const admin=cusers.find(u=>u.role==='admin');
      // Expiry badge
      const isOn=c.clinic_status!=='OFF';
      let expiryBadge='<span class="badge b-active">Active</span>';
      if(c.recharge_expiry_date){
        const today=new Date(); today.setHours(0,0,0,0);
        const exp=new Date(c.recharge_expiry_date); exp.setHours(0,0,0,0);
        const diff=Math.floor((exp-today)/(1000*60*60*24));
        if(exp<today) expiryBadge=`<span class="badge b-due">Expired</span>`;
        else if(diff<=7) expiryBadge=`<span class="badge b-warn">Exp in ${diff}d</span>`;
        else expiryBadge=`<span class="badge b-active">${c.recharge_expiry_date}</span>`;
      }
      const statusBadge=isOn
        ?`<span class="badge b-active">ON</span>`
        :`<span class="badge b-due">OFF</span>`;
      return`<tr>
        <td style="font-family:var(--mono);color:var(--text2)">${i+1}</td>
        <td style="font-weight:600;color:var(--text)">${escHtml(c.name)}</td>
        <td style="font-family:var(--mono);font-size:11px">${escHtml(admin?.u||'‚Äî')}</td>
        <td style="font-family:var(--mono)">${cinvs.length}</td>
        <td style="font-family:var(--mono);color:var(--green);font-weight:600">‡ß≥${coll.toLocaleString()}</td>
        <td><span class="badge ${due>0?'b-due':'b-active'}">‡ß≥${due.toLocaleString()}</span></td>
        <td>${cusers.length}</td>
        <td style="font-size:11px;color:var(--text2)">${c.reg}</td>
        <td>${expiryBadge}</td>
        <td>${statusBadge}</td>
        <td style="white-space:nowrap">
          <button class="btn btn-o btn-sm" onclick="viewClinicDetail('${c.id}')">üëÅ View</button>
          <button class="btn btn-t btn-sm" onclick="enterClinic('${c.id}')">üîë Enter</button>
          <button class="btn btn-sm" style="background:${isOn?'var(--amber)':'var(--green)'};color:#fff;padding:5px 10px;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="saToggleClinic('${c.id}')">${isOn?'‚è∏ OFF':'‚ñ∂ ON'}</button>
          <button class="btn btn-sm" style="background:var(--purple);color:#fff;padding:5px 10px;border:none;border-radius:6px;font-size:11px;cursor:pointer;" onclick="openRecharge('${c.id}')">üí≥ Recharge</button>
          <button class="btn btn-r btn-sm" onclick="saDeleteClinic('${c.id}')">üóë Delete</button>
        </td>
      </tr>`;
    }).join('')||`<tr><td colspan="11" style="color:var(--gray);text-align:center;padding:20px;">No clinics registered.</td></tr>`;
  }
}

function saToggleClinic(cid){
  const c=getClinic(cid); if(!c){N('Clinic not found.',true);return;}
  const isOn=c.clinic_status!=='OFF';
  const newStatus=isOn?'OFF':'ON';
  if(!confirm(`${isOn?'Suspend':'Reactivate'} clinic "${c.name}"?\n\n${isOn?'Users will not be able to login until reactivated. Data is preserved.':'Clinic will be reactivated. Users can login again.'}`)) return;
  try{
    DB.update('clinics',x=>x.id===cid,{clinic_status:newStatus});
    N(`‚úì Clinic "${c.name}" is now ${newStatus}.`);
    renderSA();
  }catch(e){N('Failed: '+e.message,true);}
}

function openRecharge(cid){
  const c=getClinic(cid); if(!c){N('Clinic not found.',true);return;}
  document.getElementById('recharge_cid').value=cid;
  // Default: +1 year from current expiry or today
  const base=c.recharge_expiry_date&&new Date(c.recharge_expiry_date)>new Date()?c.recharge_expiry_date:new Date().toISOString().split('T')[0];
  const d=new Date(base); d.setFullYear(d.getFullYear()+1);
  document.getElementById('recharge_expiry').value=d.toISOString().split('T')[0];
  document.getElementById('recharge_note').value='';
  // Show current info
  const today=new Date(); today.setHours(0,0,0,0);
  const exp=c.recharge_expiry_date?new Date(c.recharge_expiry_date):null;
  const diff=exp?Math.floor((exp-today)/(1000*60*60*24)):null;
  document.getElementById('recharge_info').innerHTML=`
    <strong>${escHtml(c.name)}</strong><br>
    Current Expiry: <span style="color:${exp&&exp<today?'var(--red)':'var(--green)'};">${c.recharge_expiry_date||'Not set'}</span>
    ${diff!==null?`(${diff>=0?diff+' days remaining':'EXPIRED'})`:''}
    <br>Status: <span class="badge ${c.clinic_status==='OFF'?'b-due':'b-active'}">${c.clinic_status||'ON'}</span>`;
  openModal('m-recharge');
}

function doRecharge(){
  const cid=document.getElementById('recharge_cid').value;
  const expiry=document.getElementById('recharge_expiry').value;
  const note=document.getElementById('recharge_note').value.trim();
  if(!expiry){N('Please select an expiry date.',true);return;}
  try{
    DB.update('clinics',x=>x.id===cid,{
      recharge_expiry_date:expiry,
      clinic_status:'ON',
      lastRecharged:new Date().toISOString().split('T')[0],
      rechargeNote:note||''
    });
    const c=getClinic(cid);
    N(`‚úì Clinic "${c?.name}" recharged until ${expiry}. Status set to ON.`);
    closeModal('m-recharge');
    renderSA();
  }catch(e){N('Recharge failed: '+e.message,true);}
}

function enterClinic(cid){
  const clinic=getClinic(cid); if(!clinic){N('Clinic not found.',true);return;}
  // Set SA session to act as admin of that clinic
  S={...S,cid,cliName:clinic.name,_saMode:true};
  sessionStorage.setItem('akbd_session',JSON.stringify(S));
  document.getElementById('tbTitle').textContent=clinic.name;
  document.getElementById('dashClinic').textContent=clinic.name;
  document.getElementById('dashName').textContent='System Owner @ '+clinic.name;
  buildGrid();
  showScreen('dashboard');
  N('‚úì Entered: '+clinic.name);
}
function viewClinicDetail(cid){
  const c=getClinic(cid); if(!c) return;
  const cinvs=DB.getBy('invoices','cid',cid);
  const cusers=DB.getBy('users','cid',cid);
  const ctsts=DB.getBy('tests','cid',cid);
  const coll=cinvs.reduce((s,v)=>s+v.paid,0);
  const due=cinvs.reduce((s,v)=>s+v.due,0);
  const tot=cinvs.reduce((s,v)=>s+v.subtotal,0);
  document.getElementById('cv-title').textContent=`üìä ${c.name} ‚Äî Clinic Details`;
  document.getElementById('m-clinic-view-body').innerHTML=`
    <div class="stat-row" style="margin-bottom:16px;">
      <div class="stat-card"><div class="snum" style="color:var(--teal)">‡ß≥${tot.toLocaleString()}</div><div class="slbl">Total Billed</div></div>
      <div class="stat-card"><div class="snum" style="color:var(--green)">‡ß≥${coll.toLocaleString()}</div><div class="slbl">Collected</div></div>
      <div class="stat-card"><div class="snum" style="color:var(--red)">‡ß≥${due.toLocaleString()}</div><div class="slbl">Due</div></div>
      <div class="stat-card"><div class="snum" style="color:var(--purple)">${cinvs.length}</div><div class="slbl">Invoices</div></div>
    </div>
    <div class="box">
      <div class="box-title">Users (${cusers.length})</div>
      <div class="tbl-wrap"><table>
        <thead><tr><th>Username</th><th>Name</th><th>Role</th><th>Status</th></tr></thead>
        <tbody>${cusers.map(u=>`<tr>
          <td style="font-family:var(--mono)">${escHtml(u.u)}</td>
          <td style="font-weight:500">${escHtml(u.name)}</td>
          <td><span class="badge b-warn">${u.role}</span></td>
          <td><span class="badge ${u.status==='active'?'b-active':'b-due'}">${u.status}</span></td>
        </tr>`).join('')||'<tr><td colspan="4" style="text-align:center;color:var(--text2)">No users.</td></tr>'}</tbody>
      </table></div>
    </div>
    <div>
      <div class="box-title">Recent Invoices (latest 10)</div>
      <div class="tbl-wrap"><table>
        <thead><tr><th>Invoice</th><th>Date</th><th>Patient</th><th>Total</th><th>Paid</th><th>Due</th><th></th></tr></thead>
        <tbody>${[...cinvs].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,10).map(v=>`<tr>
          <td style="font-family:var(--mono);color:var(--teal)">${v.no}</td><td>${v.date}</td>
          <td style="font-weight:500">${escHtml(v.patient)}</td>
          <td style="font-family:var(--mono)">‡ß≥${v.subtotal.toLocaleString()}</td>
          <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
          <td><span class="badge ${v.due>0?'b-due':'b-active'}">‡ß≥${v.due.toLocaleString()}</span></td>
          <td><button class="btn btn-o btn-sm" onclick="saReviewInv('${v.id}')">üëÅ</button></td>
        </tr>`).join('')||'<tr><td colspan="7" style="color:var(--gray);text-align:center">No invoices.</td></tr>'}</tbody>
      </table></div>
    </div>`;
  openModal('m-clinic-view');
}

function saReviewInv(id){
  const inv=DB.findOne('invoices',i=>i.id===id); if(!inv) return;
  const clinic=getClinic(inv.cid)||{};
  const tests=inv.tests.map(tid=>{const t=getTestById(tid);return t||{name:tid,price:0,cat:'Unknown'};});
  reviewInvId=id;
  const net=(inv.subtotal||0)-(inv.discount||0);
  const docDisplay=inv.doctor||inv.docName||'';
  document.getElementById('m-review-body').innerHTML=`
  <div style="background:#fff;color:#000;padding:16px;border-radius:6px;">
    ${buildInvoiceHTML({...inv,tests,sub:inv.subtotal,disc:inv.discount,net,clinic,by:inv.by,doctor:docDisplay},'','') }
  </div>`;
  openModal('m-review');
}
function registerClinic(){
  const n=document.getElementById('nc_name')?.value?.trim();
  const a=document.getElementById('nc_admin')?.value?.trim();
  const p=document.getElementById('nc_pass')?.value?.trim();
  if(!n||!a||!p){N('Clinic name, admin username, and password are required.',true);return;}
  if(DB.findOne('users',u=>u.u===a)){N('Username already taken.',true);return;}
  if(a.toLowerCase()==='superadmin'){N('This username is reserved.',true);return;}
  (async()=>{
    const btn=document.querySelector('#m-clinic .btn-t');
    if(btn){btn.textContent='‚è≥ Registering‚Ä¶';btn.disabled=true;}
    try{
      const cid='c_'+Date.now();
      const defaultExpiry=new Date(); defaultExpiry.setFullYear(defaultExpiry.getFullYear()+1);
      DB.insert('clinics',{
        id:cid, name:n,
        address:document.getElementById('nc_addr')?.value||'',
        phone:document.getElementById('nc_phone')?.value||'',
        email:'', header:document.getElementById('nc_hdr')?.value||n.toUpperCase(),
        logo:'', reg:new Date().toISOString().split('T')[0],
        clinic_status:'ON',
        recharge_expiry_date:defaultExpiry.toISOString().split('T')[0]
      });
      DB.insert('users',{
        id:uid(), u:a, p:await hashPassword(p),
        name:'Clinic Admin', role:'admin', cid, status:'active',
        createdBy:'superadmin', createdAt:new Date().toISOString()
      });
      // Seed categories & tests from CLINIC_001 template
      DB.getBy('test_categories','cid','CLINIC_001').forEach(cat=>{
        DB.insert('test_categories',{...cat,id:uid(),cid});
      });
      DB.getBy('tests','cid','CLINIC_001').forEach(t=>{
        DB.insert('tests',{...t,id:uid(),cid});
      });
      closeModal('m-clinic');
      renderSA();
      N(`‚úì Clinic "${n}" registered. Admin: ${a}.`);
      ['nc_name','nc_admin','nc_pass','nc_phone','nc_addr','nc_hdr'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
    }catch(e){N('Registration failed: '+e.message,true);}
    finally{if(btn){btn.textContent='Register & Auto-Setup';btn.disabled=false;}}
  })();
}
async function saDeleteClinic(cid){
  if(S?.role!=='superadmin'){N('Permission denied.',true);return;}
  const c=getClinic(cid); if(!c) return;
  if(cid==='CLINIC_001'){N('Cannot delete the primary clinic.',true);return;}
  if(!confirm(`Delete clinic "${c.name}"? This removes ALL data. Cannot be undone.`)) return;
  try{
    ['clinics','users','invoices','patients','tests','test_categories','authorized_persons','doctors'].forEach(col=>{
      DB.delete(col,x=>x.id===cid||x.cid===cid);
    });
    N(`‚úì Clinic "${c.name}" and all data deleted.`);
    renderSA();
  }catch(e){N('Delete failed: '+e.message,true);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id){document.getElementById(id)?.classList.add('open');}
function closeModal(id){document.getElementById(id)?.classList.remove('open');}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTIFY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function N(msg,isErr=false){
  const el=document.getElementById('notif');
  el.textContent=msg;
  el.className='notif'+(isErr?' err':'')+' show';
  clearTimeout(el._t);
  el._t=setTimeout(()=>el.classList.remove('show'),4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHANGE PASSWORD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openChangePassword(){
  document.getElementById('cpw_old').value='';
  document.getElementById('cpw_new').value='';
  document.getElementById('cpw_confirm').value='';
  document.getElementById('cpw_err').textContent='';
  openModal('m-change-pw');
}
async function doChangePassword(){
  const old=document.getElementById('cpw_old').value;
  const nw=document.getElementById('cpw_new').value;
  const cf=document.getElementById('cpw_confirm').value;
  const err=document.getElementById('cpw_err');
  err.textContent='';
  if(!old||!nw||!cf){err.textContent='All fields required.';return;}
  if(nw.length<6){err.textContent='New password must be at least 6 characters.';return;}
  if(nw!==cf){err.textContent='New passwords do not match.';return;}
  const cu=DB.findOne('users',u=>u.u===S.u);
  if(!cu){err.textContent='User not found.';return;}
  const valid=await verifyPassword(old,cu.p);
  if(!valid){err.textContent='Current password is incorrect.';return;}
  try{
    const hashed=await hashPassword(nw);
    DB.update('users',u=>u.u===S.u,{p:hashed,pwChangedAt:new Date().toISOString()});
    closeModal('m-change-pw');
    N('‚úì Password changed successfully.');
  }catch(e){err.textContent='Failed: '+e.message;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADMIN RESET USER PASSWORD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAdminResetPw(uid,username,name){
  if(!canManagePersonnel()){N('Permission denied.',true);return;}
  document.getElementById('rpw_uid').value=uid;
  document.getElementById('rpw_user_info').innerHTML=`Resetting password for: <strong>${escHtml(name)}</strong> (<code>${escHtml(username)}</code>)`;
  document.getElementById('rpw_new').value='';
  document.getElementById('rpw_confirm').value='';
  document.getElementById('rpw_err').textContent='';
  openModal('m-reset-pw');
}
async function doAdminResetPw(){
  const uid=document.getElementById('rpw_uid').value;
  const nw=document.getElementById('rpw_new').value;
  const cf=document.getElementById('rpw_confirm').value;
  const err=document.getElementById('rpw_err');
  err.textContent='';
  if(!nw||!cf){err.textContent='All fields required.';return;}
  if(nw.length<6){err.textContent='Password must be at least 6 characters.';return;}
  if(nw!==cf){err.textContent='Passwords do not match.';return;}
  try{
    const hashed=await hashPassword(nw);
    DB.update('users',u=>u.id===uid,{p:hashed,pwResetAt:new Date().toISOString(),pwResetBy:S.u});
    closeModal('m-reset-pw');
    N('‚úì Password reset successfully.');
  }catch(e){err.textContent='Failed: '+e.message;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MY PROFILE (Settings tab in Pathology workspace) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rSetMyProfile(){
  const cu=DB.findOne('users',u=>u.u===S.u)||{};
  document.getElementById('wsBody').innerHTML=`
  <div class="box" style="max-width:560px;">
    <div class="box-title">My Profile</div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Full Name</label><input id="mp_name" value="${escHtml(cu.name||'')}"></div>
      <div class="fi"><label>Username (readonly)</label><input value="${escHtml(cu.u||'')}" readonly></div>
    </div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Role</label><input value="${escHtml(cu.role||'')}" readonly></div>
      <div class="fi"><label>Status</label><input value="${escHtml(cu.status||'active')}" readonly></div>
    </div>
    <div class="action-row"><button class="btn btn-t" onclick="saveMyProfile()">üíæ Update Name</button></div>
    <div class="pw-section">
      <div class="box-title">üîë Change Password</div>
      <div class="fi" style="margin-bottom:10px;"><label>Current Password *</label><input type="password" id="sp_old" placeholder="Enter current password"></div>
      <div class="fi" style="margin-bottom:10px;"><label>New Password *</label><input type="password" id="sp_new" placeholder="Min 6 characters"></div>
      <div class="fi" style="margin-bottom:10px;"><label>Confirm New Password *</label><input type="password" id="sp_confirm" placeholder="Repeat new password"></div>
      <div id="sp_err" style="min-height:14px;font-size:12px;color:var(--red);margin-bottom:8px;"></div>
      <div class="action-row"><button class="btn btn-t" onclick="doChangePwSettings()">üîë Change Password</button></div>
    </div>
  </div>`;
}
function saveMyProfile(){
  const name=document.getElementById('mp_name')?.value?.trim();
  if(!name){N('Name is required.',true);return;}
  try{
    DB.update('users',u=>u.u===S.u,{name});
    S.name=name;
    sessionStorage.setItem('akbd_session',JSON.stringify(S));
    document.getElementById('tbUser').textContent=name;
    N('‚úì Profile updated.');
  }catch(e){N('Failed: '+e.message,true);}
}
async function doChangePwSettings(){
  const old=document.getElementById('sp_old')?.value;
  const nw=document.getElementById('sp_new')?.value;
  const cf=document.getElementById('sp_confirm')?.value;
  const err=document.getElementById('sp_err');
  if(err) err.textContent='';
  if(!old||!nw||!cf){if(err)err.textContent='All fields required.';return;}
  if(nw.length<6){if(err)err.textContent='Min 6 characters.';return;}
  if(nw!==cf){if(err)err.textContent='Passwords do not match.';return;}
  const cu=DB.findOne('users',u=>u.u===S.u);
  if(!cu){if(err)err.textContent='User not found.';return;}
  const valid=await verifyPassword(old,cu.p);
  if(!valid){if(err)err.textContent='Current password incorrect.';return;}
  try{
    const hashed=await hashPassword(nw);
    DB.update('users',u=>u.u===S.u,{p:hashed,pwChangedAt:new Date().toISOString()});
    N('‚úì Password changed.');
    document.getElementById('sp_old').value='';
    document.getElementById('sp_new').value='';
    document.getElementById('sp_confirm').value='';
  }catch(e){if(err)err.textContent='Failed: '+e.message;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MACHINE NAMES (Pathology) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rMachineNames(){
  if(!canManagePersonnel()){
    document.getElementById('wsBody').innerHTML='<div class="box"><p style="color:var(--amber);">‚ö† Only Clinic Admin can manage machine names.</p></div>';return;
  }
  renderMachineList();
}
function renderMachineList(){
  const machines=DB.getBy('machines','cid',S.cid);
  const tests=myAllTests();
  document.getElementById('wsBody').innerHTML=`
  <div class="box">
    <div class="box-title" style="display:flex;justify-content:space-between;align-items:center;">
      <span>Lab Machines (${machines.length})</span>
      <button class="btn btn-t btn-sm" onclick="openAddMachine()">+ Add Machine</button>
    </div>
    ${machines.length===0?'<p style="color:var(--gray);font-size:13px;">No machines defined yet. Add machines to assign them to tests.</p>':''}
    ${machines.length>0?`<div class="tbl-wrap"><table>
      <thead><tr><th>Machine Name</th><th>Model</th><th>Manufacturer</th><th>Tests Assigned</th><th>Actions</th></tr></thead>
      <tbody>${machines.map(m=>{
        const assigned=tests.filter(t=>t.machine===m.id).length;
        return`<tr>
          <td style="font-weight:600;color:var(--teal)">${escHtml(m.name)}</td>
          <td>${escHtml(m.model||'‚Äî')}</td>
          <td>${escHtml(m.manufacturer||'‚Äî')}</td>
          <td><span class="badge b-active">${assigned}</span></td>
          <td style="white-space:nowrap">
            <button class="btn btn-o btn-sm" onclick="openEditMachine('${m.id}')">‚úèÔ∏è Edit</button>
            <button class="btn btn-r btn-sm" onclick="deleteMachine('${m.id}')">üóë</button>
          </td>
        </tr>`;}).join('')}</tbody>
    </table></div>`:''}
  </div>
  <div class="box">
    <div class="box-title">Assign Machines to Tests</div>
    <p style="font-size:12px;color:var(--text2);margin-bottom:12px;">Select a machine for each test. Example: CBC ‚Üí Sysmex XN-1000</p>
    <div class="tbl-wrap"><table>
      <thead><tr><th>Test Name</th><th>Category</th><th>Assigned Machine</th><th>Action</th></tr></thead>
      <tbody>${tests.map(t=>`<tr>
        <td style="font-weight:500">${escHtml(t.name)}</td>
        <td><span class="badge b-paid">${escHtml(t.cat)}</span></td>
        <td>${t.machine?`<span style="color:var(--teal)">${escHtml(machines.find(m=>m.id===t.machine)?.name||'Unknown')}</span>`:'<span style="color:var(--gray)">‚Äî Not assigned</span>'}</td>
        <td>
          <select onchange="assignMachine('${t.id}',this.value)" style="padding:5px 8px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:12px;outline:none;">
            <option value="">‚Äî None ‚Äî</option>
            ${machines.map(m=>`<option value="${m.id}" ${t.machine===m.id?'selected':''}>${escHtml(m.name)}</option>`).join('')}
          </select>
        </td>
      </tr>`).join('')||`<tr><td colspan="4" style="color:var(--gray);text-align:center;padding:16px;">No tests found.</td></tr>`}</tbody>
    </table></div>
  </div>`;
}
function openAddMachine(){
  document.getElementById('mach_id').value='';
  document.getElementById('mach_name').value='';
  document.getElementById('mach_model').value='';
  document.getElementById('mach_mfr').value='';
  document.getElementById('machine-modal-title').textContent='‚öô Add Machine';
  openModal('m-machine');
}
function openEditMachine(id){
  const m=DB.findOne('machines',x=>x.id===id); if(!m) return;
  document.getElementById('mach_id').value=m.id;
  document.getElementById('mach_name').value=m.name||'';
  document.getElementById('mach_model').value=m.model||'';
  document.getElementById('mach_mfr').value=m.manufacturer||'';
  document.getElementById('machine-modal-title').textContent='‚úèÔ∏è Edit Machine';
  openModal('m-machine');
}
function saveMachine(){
  const id=document.getElementById('mach_id').value;
  const name=document.getElementById('mach_name').value.trim();
  if(!name){N('Machine name required.',true);return;}
  try{
    if(id){
      DB.update('machines',m=>m.id===id,{
        name, model:document.getElementById('mach_model').value.trim(),
        manufacturer:document.getElementById('mach_mfr').value.trim(),
        updatedAt:new Date().toISOString()
      });
      N(`‚úì Machine "${name}" updated.`);
    } else {
      DB.insert('machines',{
        id:uid(), cid:S.cid, name,
        model:document.getElementById('mach_model').value.trim(),
        manufacturer:document.getElementById('mach_mfr').value.trim(),
        createdAt:new Date().toISOString()
      });
      N(`‚úì Machine "${name}" added.`);
    }
    closeModal('m-machine');
    renderMachineList();
  }catch(e){N('Failed: '+e.message,true);}
}
function deleteMachine(id){
  if(!confirm('Delete this machine?')) return;
  try{
    DB.delete('machines',m=>m.id===id);
    N('Machine deleted.');
    renderMachineList();
  }catch(e){N('Failed: '+e.message,true);}
}
function assignMachine(testId,machineId){
  try{
    DB.update('tests',t=>t.id===testId,{machine:machineId||null});
    N('‚úì Machine assignment saved.');
  }catch(e){N('Failed: '+e.message,true);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OPD MODULE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const OPD_TABS=['Invoice / Receipt','Invoice List','Doctor','Reference','Due List','Reports','Accounts'];
const OPD_FUNS=[rOpdInvoice,rOpdInvList,rOpdDoctors,rOpdReferences,rOpdDueList,rOpdReports,rOpdAccounts];
let opdSelServices=[],opdSelPathTests=[],opdCurDoc=null,opdCurRef=null;
function openOPD(){
  if(!can('opd')){N('Access denied.',true);return;}
  document.getElementById('tbTitle').textContent='OPD';
  buildOpdTabs(0);
  rOpdInvoice();
  showScreen('opd');
}
function buildOpdTabs(ai){
  const restricted=['opd'].includes(S?.role);
  const backBtn=restricted
    ?`<button class="ws-back" onclick="doLogout()">‚èè Logout</button>`
    :`<button class="ws-back" onclick="goToDash()">‚Üê Dashboard</button>`;
  document.getElementById('opdNav').innerHTML=
    OPD_TABS.map((t,i)=>`<div class="ws-tab${i===ai?' active':''}" onclick="swOpdTab(this,${i})">${t}</div>`).join('')+
    `<div class="ws-spacer"></div>${backBtn}`;
}
function swOpdTab(el,i){
  document.querySelectorAll('#opdNav .ws-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  OPD_FUNS[i]();
}

function rOpdInvoice(){
  opdSelServices=[];opdSelPathTests=[];
  const today=new Date().toISOString().split('T')[0];
  const refs=DB.getBy('opd_refs','cid',S.cid);
  const docs=DB.getBy('opd_docs','cid',S.cid);
  const svcs=DB.getBy('opd_services','cid',S.cid).filter(s=>s.status!=='inactive');
  const no=nextOpdInvNo(S.cid);
  document.getElementById('opdBody').innerHTML=`
  <div style="display:grid;grid-template-columns:1fr 300px;gap:14px;">
    <div>
      <div class="box">
        <div class="box-title">OPD Invoice ‚Äî ${no}</div>
        <div class="f4" style="margin-bottom:12px;">
          <div class="fi"><label>Invoice No</label><input id="oi_no" value="${no}" readonly></div>
          <div class="fi"><label>Date</label><input type="date" id="oi_date" value="${today}"></div>
          <div class="fi"><label>Patient Name *</label><input id="oi_name" placeholder="Full name" autofocus></div>
          <div class="fi"><label>Phone</label><input id="oi_phone" placeholder="01X00-000000"></div>
        </div>
        <div class="f4">
          <div class="fi"><label>Age</label>
            <div style="display:flex;gap:5px;align-items:center;">
              <input id="oi_age_y" type="number" min="0" placeholder="Yr" style="width:55px;padding:8px 6px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;outline:none;" oninput="updateOpdAgeVal()">
              <span style="font-size:12px;color:var(--text2);">Y</span>
              <input id="oi_age_m" type="number" min="0" max="11" placeholder="Mo" style="width:55px;padding:8px 6px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;outline:none;" oninput="updateOpdAgeVal()">
              <span style="font-size:12px;color:var(--text2);">M</span>
              <input type="hidden" id="oi_age" value="">
            </div>
          </div>
          <div class="fi"><label>Gender</label><select id="oi_gender"><option value="">‚Äî Select ‚Äî</option><option>Male</option><option>Female</option><option>Other</option></select></div>
          <div class="fi"><label>Doctor (Referred By)</label>
            <input id="oi_doc_code" placeholder="Type doctor name..." list="opd-doc-list" oninput="opdAutoFillDoc()">
            <datalist id="opd-doc-list">${docs.map(d=>`<option value="${escHtml(d.name+(d.degree?', '+d.degree:''))}">`).join('')}</datalist>
          </div>
          <div class="fi"><label>Patient Type</label><select id="oi_type"><option>General</option><option>Emergency</option><option>Corporate</option></select></div>
        </div>
        <div class="f2" style="margin-top:12px;">
          <div class="fi"><label>Reference</label>
            <select id="oi_ref" onchange="opdAutoFillRef()">
              <option value="">‚Äî None ‚Äî</option>
              ${refs.map(r=>`<option value="${r.id}">${escHtml(r.name)}</option>`).join('')}
            </select>
          </div>
        </div>
      </div>
      <div class="box">
        <div class="box-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>üî¨ Tests / Services (Category-wise)</span>
          <span style="font-size:10px;color:var(--text2);font-weight:400;">Select from inventory</span>
        </div>
        <div class="bar" style="margin-bottom:10px;">
          <input id="opd_ptq" placeholder="Search pathology test..." oninput="fOpdPathTests()" style="flex:1;">
          <select id="opd_ptc" onchange="fOpdPathTests()">
            <option value="">All Categories</option>
            ${[...new Set(myTests().map(t=>t.cat))].map(c=>`<option>${escHtml(c)}</option>`).join('')}
          </select>
        </div>
        <div class="test-scroll" id="opd_path_list">${buildOpdPathRows(myTests(),'','')}</div>
        <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px;">
          <div class="box-title" style="margin-bottom:6px;">Selected Tests</div>
          <div id="opd_path_sel_el"><em style="font-size:12px;color:var(--text2)">No tests selected.</em></div>
        </div>
      </div>
    </div>
    <div>
      <div class="box">
        <div class="box-title">Billing Summary</div>
        <div class="tot-row"><span>Subtotal</span><span id="opd_ts" style="font-family:var(--mono)">‡ß≥ 0</span></div>
        <div class="tot-row"><span>Discount (‡ß≥)</span><input class="tinput" id="opd_td" type="number" min="0" value="0" oninput="calcOpdT()"></div>
        <div class="tot-row"><span>Net Payable</span><span id="opd_tn" style="font-family:var(--mono)">‡ß≥ 0</span></div>
        <div class="tot-row"><span>Paid (‡ß≥)</span><input class="tinput" id="opd_tp" type="number" min="0" value="0" oninput="calcOpdT()"></div>
        <div class="tot-row tot-grand"><span>Grand Total</span><span id="opd_tg" style="font-family:var(--mono)">‡ß≥ 0</span></div>
        <div class="tot-row tot-due"><span>Due</span><span id="opd_tdu" style="font-family:var(--mono)">‡ß≥ 0</span></div>
      </div>
      <div id="opd_ref_info" style="display:none;" class="box">
        <div class="box-title" style="color:var(--purple)">Reference Info</div>
        <div id="opd_ref_detail" style="font-size:12px;"></div>
      </div>
      <div class="action-row">
        <button class="btn btn-t" onclick="saveOpdInvoice()">üñ® Save &amp; Print</button>
        <button class="btn btn-r" onclick="rOpdInvoice()">‚úï Clear</button>
      </div>
    </div>
  </div>`;
}
function buildOpdSvcRows(svcs,q,cat){
  return svcs.filter(s=>s.name.toLowerCase().includes((q||'').toLowerCase())&&(cat===''||s.cat===cat))
    .map(s=>`<div class="test-row" onclick="addOpdSvc('${s.id}')">
      <span>${escHtml(s.name)} <small style="color:var(--gray)">(${escHtml(s.cat)})</small></span>
      <span class="tp">‡ß≥${s.price}</span>
    </div>`).join('')||`<div style="padding:10px;color:var(--text2);font-size:12px;">No services found.</div>`;
}
function fOpdServices(){
  const q=document.getElementById('opd_tsq')?.value||'',c=document.getElementById('opd_tsc')?.value||'';
  const svcs=DB.getBy('opd_services','cid',S.cid).filter(s=>s.status!=='inactive');
  const el=document.getElementById('opd_svc_list');
  if(el) el.innerHTML=buildOpdSvcRows(svcs,q,c);
}
function addOpdSvc(id){
  if(opdSelServices.find(s=>s.id===id)){N('Already added.',true);return;}
  const svc=DB.findOne('opd_services',s=>s.id===id); if(!svc) return;
  opdSelServices.push({...svc}); upOpdSel(); calcOpdT();
}
function rmOpdSvc(id){opdSelServices=opdSelServices.filter(s=>s.id!==id);upOpdSel();calcOpdT();}
function upOpdSel(){
  const el=document.getElementById('opd_sel_el'); if(!el) return;
  if(!opdSelServices.length){el.innerHTML='<em style="font-size:12px;color:var(--text2)">None selected.</em>';return;}
  el.innerHTML=opdSelServices.map(s=>`<div class="sel-item">
    <span>${escHtml(s.name)}</span>
    <span style="display:flex;align-items:center;gap:8px;">
      <span style="color:var(--teal);font-family:var(--mono);font-size:11px;">‡ß≥${s.price}</span>
      <span class="trm" onclick="rmOpdSvc('${s.id}')">√ó</span>
    </span></div>`).join('');
}
function calcOpdT(){
  const svcSub=opdSelServices.reduce((s,t)=>s+t.price,0);
  const pathSub=opdSelPathTests.reduce((s,t)=>s+t.price,0);
  const sub=svcSub+pathSub;
  const disc=Math.min(parseFloat(document.getElementById('opd_td')?.value||0),sub);
  const net=sub-disc, paid=parseFloat(document.getElementById('opd_tp')?.value||0), due=Math.max(net-paid,0);
  document.getElementById('opd_ts').textContent=`‡ß≥ ${sub.toLocaleString()}`;
  document.getElementById('opd_tn').textContent=`‡ß≥ ${net.toLocaleString()}`;
  document.getElementById('opd_tg').textContent=`‡ß≥ ${net.toLocaleString()}`;
  document.getElementById('opd_tdu').textContent=`‡ß≥ ${due.toLocaleString()}`;
}
function buildOpdPathRows(tests,q,cat){
  const filtered=(tests||[]).filter(t=>t.name.toLowerCase().includes((q||'').toLowerCase())&&(cat===''||t.cat===cat));
  if(!filtered.length) return `<div style="padding:10px;color:var(--text2);font-size:12px;">No tests found.</div>`;
  if(cat!==''){
    return filtered.map(t=>`<div class="test-row" onclick="addOpdPathTest('${t.id}')"><span>${escHtml(t.name)}</span><span class="tp">‡ß≥${t.price}</span></div>`).join('');
  }
  const byCat={};
  filtered.forEach(t=>{if(!byCat[t.cat])byCat[t.cat]=[];byCat[t.cat].push(t);});
  return Object.entries(byCat).map(([catName,items])=>`
    <div style="font-size:9px;text-transform:uppercase;letter-spacing:.12em;color:var(--text3);font-weight:700;padding:6px 11px 3px;background:var(--bg2);">${escHtml(catName)}</div>
    ${items.map(t=>`<div class="test-row" onclick="addOpdPathTest('${t.id}')"><span>${escHtml(t.name)}</span><span class="tp">‡ß≥${t.price}</span></div>`).join('')}
  `).join('');
}
function fOpdPathTests(){
  const q=document.getElementById('opd_ptq')?.value||'',c=document.getElementById('opd_ptc')?.value||'';
  const el=document.getElementById('opd_path_list');
  if(el) el.innerHTML=buildOpdPathRows(myTests(),q,c);
}
function addOpdPathTest(id){
  if(opdSelPathTests.find(t=>t.id===id)){N('Already added.',true);return;}
  const test=getTestById(id); if(!test){N('Test not found.',true);return;}
  opdSelPathTests.push({...test}); upOpdPathSel(); calcOpdT();
}
function rmOpdPathTest(id){opdSelPathTests=opdSelPathTests.filter(t=>t.id!==id);upOpdPathSel();calcOpdT();}
function upOpdPathSel(){
  const el=document.getElementById('opd_path_sel_el'); if(!el) return;
  if(!opdSelPathTests.length){el.innerHTML='<em style="font-size:12px;color:var(--text2)">No tests selected.</em>';return;}
  el.innerHTML=opdSelPathTests.map(t=>`<div class="sel-item">
    <span>${escHtml(t.name)}</span>
    <span style="display:flex;align-items:center;gap:8px;">
      <span style="color:var(--teal);font-family:var(--mono);font-size:11px;">‡ß≥${t.price}</span>
      <span class="trm" onclick="rmOpdPathTest('${t.id}')">√ó</span>
    </span></div>`).join('');
}
function opdAutoFillDoc(){
  const val=(document.getElementById('oi_doc_code')?.value||'').trim();
  const docs=DB.getBy('opd_docs','cid',S.cid);
  // Match by "Name, Degree" format or just name
  const doc=docs.find(d=>{
    const full=d.name+(d.degree?', '+d.degree:'');
    return val===full||val===d.name;
  });
  opdCurDoc=doc?{...doc}:{name:val};
}
function opdAutoFillRef(){
  const refId=document.getElementById('oi_ref')?.value;
  if(!refId){
    document.getElementById('opd_ref_info').style.display='none';
    return;
  }
  const ref=DB.findOne('opd_refs',r=>r.id===refId);
  opdCurRef=ref||null;
  const el=document.getElementById('opd_ref_info');
  const detail=document.getElementById('opd_ref_detail');
  if(ref&&el&&detail){
    detail.innerHTML=`<strong>${escHtml(ref.name)}</strong><br>
      Code: <span style="color:var(--teal)">${escHtml(ref.code)}</span> &nbsp;|&nbsp;
      Contact: ${escHtml(ref.contact||'‚Äî')} &nbsp;|&nbsp;
      Commission: <span style="color:var(--amber)">${ref.commission||0}%</span>
      ${ref.barcode?`<div class="ref-barcode">|||${escHtml(ref.barcode)}|||</div>`:''}`;
    el.style.display='block';
  } else if(el){el.style.display='none';}
}
function updateOpdAgeVal(){
  const y=document.getElementById('oi_age_y')?.value||'';
  const m=document.getElementById('oi_age_m')?.value||'';
  let age='';
  if(y) age+=y+'Y';
  if(m) age+=(age?' ':'')+m+'M';
  const el=document.getElementById('oi_age');
  if(el) el.value=age;
}
async function saveOpdInvoice(){
  const name=document.getElementById('oi_name')?.value?.trim();
  if(!name){N('Patient name required.',true);return;}
  if(!opdSelPathTests.length){N('Select at least one test.',true);return;}
  const sub=(opdSelServices.reduce((s,t)=>s+t.price,0))+(opdSelPathTests.reduce((s,t)=>s+t.price,0));
  const disc=Math.min(parseFloat(document.getElementById('opd_td')?.value||0),sub);
  const net=sub-disc;
  const paid=parseFloat(document.getElementById('opd_tp')?.value||0);
  const due=Math.max(net-paid,0);
  const invDate=document.getElementById('oi_date')?.value||new Date().toISOString().split('T')[0];
  try{
    const no=document.getElementById('oi_no')?.value;
    const record={
      id:uid(), no, cid:S.cid,
      date:invDate,
      patient:name,
      phone:document.getElementById('oi_phone')?.value||'',
      age:document.getElementById('oi_age')?.value||'‚Äî',
      gender:document.getElementById('oi_gender')?.value||'‚Äî',
      docCode:'',
      docName:(()=>{
        const val=(document.getElementById('oi_doc_code')?.value||'').trim();
        if(opdCurDoc&&opdCurDoc.name&&opdCurDoc.degree){
          return opdCurDoc.name+', '+opdCurDoc.degree;
        }
        return val||'';
      })(),
      refId:document.getElementById('oi_ref')?.value||'',
      type:document.getElementById('oi_type')?.value||'General',
      services:opdSelServices.map(s=>s.id),
      pathTests:opdSelPathTests.map(t=>t.id),
      subtotal:sub, discount:disc, paid, due,
      status:due>0?'due':'paid',
      by:S.u, byName:S.name||S.u,
      createdAt:new Date().toISOString()
    };
    DB.insert('opd_invoices',record);
    // ‚îÄ‚îÄ Auto-link pathology tests to pathology_invoice_items (v17) ‚îÄ‚îÄ
    if(opdSelPathTests.length){
      const now2=new Date().toISOString();
      opdSelPathTests.forEach((t,idx)=>{
        DB.insert('pathology_invoice_items',{
          id:uid(),
          pathInvId:record.id,    // links to OPD invoice id
          invoiceNo:no,           // OPD invoice number for search
          invTable:'opd_invoices',// source marker
          cid:S.cid,
          sl:idx+1, testId:t.id, testName:t.name, testCat:t.cat||'',
          qty:1, unitPrice:t.price, lineTotal:t.price,
          patient:name, date:invDate, status:'pending',
          createdAt:now2
        });
        // Seed patient_test_records for result entry
        DB.insert('patient_test_records',{
          id:uid(), pathInvId:record.id, invoiceNo:no,
          cid:S.cid, testId:t.id, testName:t.name,
          date:invDate, status:'pending', createdAt:now2
        });
      });
    }
    // ‚îÄ‚îÄ Save user_collections (always for tracking) ‚îÄ‚îÄ
    DB.insert('user_collections',{
      id:uid(), cid:S.cid,
      invoiceNo:no, invoiceId:record.id,
      invoiceType:'OPD',
      module:'OPD',
      patient:name,
      amount:paid,
      receivedBy:S.u,
      receivedByName:S.name||S.u,
      receiveDate:invDate,
      location:getClinic(S.cid)?.name||'',
      note: paid>0 ? 'Payment on OPD invoice' : 'Invoice created (no payment)',
      createdAt:new Date().toISOString()
    });
    N(`‚úì OPD Invoice ${no} saved.`);
    printOpdInvoice(record);
    rOpdInvoice();
  }catch(e){N('Failed: '+e.message,true);}
}
function printOpdInvoice(inv){
  const clinic=getClinic(inv.cid)||{};
  const svcs=inv.services.map(id=>DB.findOne('opd_services',s=>s.id===id)).filter(Boolean);
  const pathTests=(inv.pathTests||[]).map(id=>getTestById(id)).filter(Boolean);
  const refInfo=inv.refId?DB.findOne('opd_refs',r=>r.id===inv.refId):null;
  const net=inv.subtotal-inv.discount;
  const now=new Date();
  const ts=`${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()} ${now.toLocaleTimeString('en-GB')}`;
  const html=`<div style="width:100%;font-family:'Times New Roman',Times,serif;font-size:11pt;color:#000;line-height:1.6;background:#fff;">
  <div style="display:flex;justify-content:space-between;font-size:9pt;margin-bottom:4px;"><span>*${escHtml(inv.no)}*</span><span></span></div>
  <div style="text-align:center;border-bottom:2px double #000;padding-bottom:10px;margin-bottom:10px;">
    <div style="font-size:16pt;font-weight:bold;">${escHtml(clinic.header||clinic.name||'CLINIC')}</div>
    <div style="font-size:9pt;">${escHtml(clinic.address||'')}</div>
    <div style="font-size:9pt;">Phone: ${escHtml(clinic.phone||'')}</div>
  </div>
  <div style="text-align:center;font-weight:bold;font-size:11pt;border-bottom:1px dashed #000;margin-bottom:8px;padding-bottom:6px;">INVOICE / RECEIPT</div>
  <div style="display:flex;justify-content:space-between;font-size:9.5pt;margin-bottom:8px;">
    <div><div><strong>Invoice No :</strong> ${escHtml(inv.no)}</div><div><strong>Date :</strong> ${inv.date}</div><div><strong>Type :</strong> ${escHtml(inv.type)}</div></div>
    <div style="text-align:right;"><div><strong>Contact :</strong> ${escHtml(inv.phone||'‚Äî')}</div></div>
  </div>
  <div style="border:1px solid #000;padding:6px 10px;margin-bottom:8px;font-size:9.5pt;">
    <div><strong>Patient :</strong> ${escHtml(inv.patient)} &nbsp;|&nbsp; <strong>Age :</strong> ${escHtml(inv.age||'‚Äî')} &nbsp;|&nbsp; <strong>Gender :</strong> ${escHtml(inv.gender||'‚Äî')}</div>
    ${inv.docName?`<div><strong>Doctor :</strong> ${escHtml(inv.docName)}</div>`:''}
    ${refInfo?`<div><strong>Referred By :</strong> ${escHtml(refInfo.name)}</div>`:''}
  </div>
  <table style="width:100%;border-collapse:collapse;font-size:9.5pt;margin-bottom:6px;">
    <thead><tr style="background:#f0f0f0;"><th style="text-align:left;padding:4px 6px;border:1px solid #ccc;width:30px;">SL</th><th style="text-align:left;padding:4px 6px;border:1px solid #ccc;">Particulars</th><th style="text-align:right;padding:4px 6px;border:1px solid #ccc;width:90px;">Amount (‡ß≥)</th></tr></thead>
    <tbody>${[
      ...svcs.map((s,i)=>`<tr><td style="padding:3px 6px;border:1px solid #ddd;">${i+1}</td><td style="padding:3px 6px;border:1px solid #ddd;">${escHtml(s.name)}</td><td style="text-align:right;padding:3px 6px;border:1px solid #ddd;">${(s.price||0).toFixed(2)}</td></tr>`),
      ...pathTests.map((t,i)=>`<tr><td style="padding:3px 6px;border:1px solid #ddd;">${svcs.length+i+1}</td><td style="padding:3px 6px;border:1px solid #ddd;">${escHtml(t.name)} <span style="color:#888;font-size:8pt;">(Lab)</span></td><td style="text-align:right;padding:3px 6px;border:1px solid #ddd;">${(t.price||0).toFixed(2)}</td></tr>`)
    ].join('')}</tbody>
  </table>
  ${pathTests.length?`<div style="background:#e0f3fb;border:1px solid #0096c7;border-radius:4px;padding:4px 8px;margin-bottom:4px;font-size:8.5pt;color:#005f85;">üî¨ Pathology Tests Included: ${pathTests.map(t=>t.name).join(', ')}</div>`:''}
  <table style="width:100%;border-collapse:collapse;font-size:9.5pt;margin-bottom:8px;">
    <tr><td style="width:50%"></td><td style="padding:2px 6px;text-align:right;border-top:1px solid #ccc;">Sub Total (Tk.) :</td><td style="padding:2px 6px;text-align:right;border-top:1px solid #ccc;width:90px;">${inv.subtotal.toFixed(2)}</td></tr>
    <tr><td></td><td style="padding:2px 6px;text-align:right;">Discount (Tk.) :</td><td style="padding:2px 6px;text-align:right;">${inv.discount.toFixed(2)}</td></tr>
    <tr><td></td><td style="padding:2px 6px;text-align:right;border-top:1px solid #ccc;">Net Payable (Tk.) :</td><td style="padding:2px 6px;text-align:right;border-top:1px solid #ccc;">${net.toFixed(2)}</td></tr>
    <tr><td></td><td style="padding:2px 6px;text-align:right;">Paid (Tk.) :</td><td style="padding:2px 6px;text-align:right;color:green;">${inv.paid.toFixed(2)}</td></tr>
    <tr style="background:#f8f8f8;"><td></td><td style="padding:4px 6px;text-align:right;font-weight:bold;font-size:10.5pt;border-top:2px solid #000;border-bottom:2px solid #000;">Due (Tk.) :</td><td style="padding:4px 6px;text-align:right;font-weight:bold;font-size:10.5pt;border-top:2px solid #000;border-bottom:2px solid #000;color:${inv.due>0?'red':'green'};">${inv.due.toFixed(2)}</td></tr>
  </table>
  ${inv.due>0?`<div style="margin:10px 0;"><span style="font-size:20pt;font-weight:bold;border:3px solid red;color:red;padding:4px 20px;display:inline-block;letter-spacing:3px;">DUE</span></div>`:`<div style="margin:10px 0;color:green;font-weight:bold;font-size:11pt;">‚úì PAID IN FULL</div>`}
  <div style="margin-top:20px;border-top:1px dashed #000;padding-top:8px;display:flex;justify-content:space-between;font-size:8.5pt;color:#555;">
    <div>Prepared By : ${escHtml(inv.by||'‚Äî')}<br>Software : Asad Kit BD v17</div>
    <div style="text-align:right;">${ts}</div>
  </div>
</div>`;
  const el=document.getElementById('m-print-body');
  if(el){el.innerHTML=html;printData={d:inv,html};}
  openModal('m-print');
}

function rOpdInvList(){
  const invs=DB.get('opd_invoices').filter(i=>i.cid===S.cid).sort((a,b)=>b.no.localeCompare(a.no));
  document.getElementById('opdBody').innerHTML=`
  <div class="bar">
    <input id="opd_isq" placeholder="Search invoice ID / patient..." oninput="fOpdInvs()" style="flex:1;">
    <span style="font-size:11px;color:var(--text2)">${invs.length} record(s)</span>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Invoice No</th><th>Date</th><th>Patient</th><th>Doctor</th><th>Total</th><th>Paid</th><th>Due</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody id="opd_invTb">${buildOpdInvRows(invs)}</tbody>
  </table></div>`;
}
function buildOpdInvRows(data){
  return data.map(v=>`<tr>
    <td style="font-family:var(--mono);color:var(--teal)">${v.no}</td>
    <td>${v.date}</td>
    <td style="font-weight:500">${escHtml(v.patient)}</td>
    <td style="font-size:11px;">${escHtml((v.docName||'‚Äî').replace(/,\s*/,' ‚Üí '))}</td>
    <td style="font-family:var(--mono)">‡ß≥${v.subtotal.toLocaleString()}</td>
    <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
    <td><span class="badge ${v.due>0?'b-due':'b-active'}">‡ß≥${v.due.toLocaleString()}</span></td>
    <td><span class="badge ${v.status==='paid'?'b-active':'b-due'}">${(v.status||'').toUpperCase()}</span></td>
    <td style="white-space:nowrap">
      <button class="btn btn-o btn-sm" onclick="reviewOpdInv('${v.id}')">üëÅ Review</button>
      <button class="btn btn-t btn-sm" onclick="reprintOpdInv('${v.id}')">üñ®</button>
      ${can('accounts')||['admin','superadmin'].includes(S?.role)?`<button class="btn btn-t btn-sm" style="background:var(--teal);" onclick="openOpdDueCollect('${v.id}',false)" ${v.due<=0?'disabled style="opacity:.4;"':''}>üí∞ Due</button>`:''}
    </td>
  </tr>`).join('')||`<tr><td colspan="9" style="text-align:center;color:var(--text2);padding:20px;">No OPD invoices.</td></tr>`;
}
function fOpdInvs(){
  const q=(document.getElementById('opd_isq')?.value||'').toLowerCase();
  const tb=document.getElementById('opd_invTb');
  if(tb) tb.innerHTML=buildOpdInvRows(DB.get('opd_invoices').filter(i=>i.cid===S.cid&&(i.no.toLowerCase().includes(q)||i.patient.toLowerCase().includes(q))));
}
function reviewOpdInv(id){
  const inv=DB.findOne('opd_invoices',i=>i.id===id); if(!inv) return;
  const clinic=getClinic(inv.cid)||{};
  const svcs=inv.services.map(sid=>DB.findOne('opd_services',s=>s.id===sid)).filter(Boolean);
  const pathTests=(inv.pathTests||[]).map(tid=>getTestById(tid)).filter(Boolean);
  const allItems=[...svcs,...pathTests].map(t=>({name:t.name,price:t.price}));
  const net=inv.subtotal-inv.discount;
  reviewInvId=id;
  document.getElementById('m-review-body').innerHTML=`
  <div style="background:#fff;color:#000;padding:16px;border-radius:6px;">
    ${buildInvoiceHTML({...inv,tests:allItems,sub:inv.subtotal,disc:inv.discount,net,clinic,by:inv.by},'','')}
  </div>
  ${inv.due>0?`<div style="margin-top:12px;padding:12px;background:rgba(220,38,38,.06);border:1px solid rgba(220,38,38,.2);border-radius:7px;display:flex;align-items:center;justify-content:space-between;">
    <span style="color:var(--red);font-weight:700;font-size:13px;">Outstanding Due: ‡ß≥${inv.due.toLocaleString()}</span>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-t btn-sm" onclick="closeModal('m-review');openOpdDueCollect('${inv.id}',false)">üí∞ Pay Due</button>
      <button class="btn btn-g btn-sm" onclick="closeModal('m-review');openOpdDueCollect('${inv.id}',true)">‚úì Full Pay</button>
    </div>
  </div>`:''}
  <div style="margin-top:10px;">
    <button class="btn btn-o btn-sm" onclick="openEditPatient('${inv.id}','opd_invoices')">‚úèÔ∏è Edit Patient Info</button>
  </div>`;
  document.getElementById('review-print-btn').onclick=()=>reprintOpdInv(id);
  openModal('m-review');
}
function reprintOpdInv(id){
  const inv=DB.findOne('opd_invoices',i=>i.id===id); if(!inv) return;
  printOpdInvoice(inv);
}

function rOpdDueList(){
  const today=new Date().toISOString().split('T')[0];
  const dues=DB.get('opd_invoices').filter(i=>i.cid===S.cid&&i.due>0);
  document.getElementById('opdBody').innerHTML=`
  <div class="bar">
    From:<input type="date" id="opd_df" value="${new Date().getFullYear()+'-01-01'}" style="color:var(--text);">
    To:<input type="date" id="opd_dt" value="${today}" style="color:var(--text);">
    <button class="btn btn-t btn-sm" onclick="filterOpdDue()">Filter</button>
    <span style="font-size:11px;color:var(--red);">${dues.length} due invoice(s)</span>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Date</th><th>Patient</th><th>Phone</th><th>Invoice</th><th>Total</th><th>Today Paid</th><th>Total Paid</th><th>Total Due</th><th>Actions</th></tr></thead>
    <tbody id="opd_due_tb">${buildOpdDueRows(dues)}</tbody>
  </table></div>`;
}
function buildOpdDueRows(dues){
  return dues.map(v=>`<tr onclick="" style="cursor:pointer;">
    <td>${v.date}</td>
    <td style="font-weight:500">${escHtml(v.patient)}</td>
    <td>${escHtml(v.phone||'‚Äî')}</td>
    <td style="font-family:var(--mono);color:var(--teal)">${v.no}</td>
    <td style="font-family:var(--mono)">‡ß≥${v.subtotal.toLocaleString()}</td>
    <td style="color:var(--gray)">‚Äî</td>
    <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
    <td style="font-family:var(--mono);color:var(--red);font-weight:700">‡ß≥${v.due.toLocaleString()}</td>
    <td style="white-space:nowrap">
      <button class="btn btn-o btn-sm" onclick="reviewOpdInv('${v.id}')">üëÅ View</button>
      <button class="btn btn-t btn-sm" onclick="openOpdDueCollect('${v.id}',false)">Partial</button>
      <button class="btn btn-g btn-sm" onclick="openOpdDueCollect('${v.id}',true)">‚úì Paid</button>
    </td>
  </tr>`).join('')||`<tr><td colspan="9" style="text-align:center;color:var(--green);padding:20px;">‚úì No pending dues.</td></tr>`;
}
function filterOpdDue(){
  const f=document.getElementById('opd_df')?.value,t=document.getElementById('opd_dt')?.value;
  const dues=DB.get('opd_invoices').filter(i=>i.cid===S.cid&&i.due>0&&i.date>=f&&i.date<=t);
  const tb=document.getElementById('opd_due_tb');
  if(tb) tb.innerHTML=buildOpdDueRows(dues);
}

let opdDueInv=null;
function openOpdDueCollect(id,fullPay){
  opdDueInv=DB.findOne('opd_invoices',i=>i.id===id); if(!opdDueInv) return;
  document.getElementById('m-due-info').innerHTML=
    `<strong>${escHtml(opdDueInv.patient)}</strong> &nbsp;|&nbsp; <span style="color:var(--teal);font-family:var(--mono)">${opdDueInv.no}</span> &nbsp;|&nbsp; ${opdDueInv.date}<br>
     Phone: ${opdDueInv.phone||'‚Äî'} &nbsp;|&nbsp; Age: ${opdDueInv.age||'‚Äî'} &nbsp;|&nbsp; Gender: ${opdDueInv.gender||'‚Äî'}<br>
     Total Bill: <span style="font-family:var(--mono)">‡ß≥${opdDueInv.subtotal.toLocaleString()}</span> &nbsp;|&nbsp;
     Paid: <span style="color:var(--green);font-family:var(--mono)">‡ß≥${opdDueInv.paid.toLocaleString()}</span> &nbsp;|&nbsp;
     Outstanding: <span style="color:var(--red);font-weight:700;font-family:var(--mono)">‡ß≥${opdDueInv.due.toLocaleString()}</span>`;
  document.getElementById('m-due-bill').innerHTML='';
  const amt=document.getElementById('m-due-amt');
  if(fullPay){amt.value=opdDueInv.due;amt.readOnly=true;}
  else{amt.value='';amt.readOnly=false;}
  // Override submit to use OPD path
  const foot=document.querySelector('#m-due .modal-foot');
  if(foot){
    foot.querySelector('.btn-t').onclick=submitOpdDue;
  }
  openModal('m-due');
}
function submitOpdDue(){
  if(!opdDueInv) return;
  const a=parseFloat(document.getElementById('m-due-amt')?.value||0);
  if(a<=0){N('Enter a valid amount.',true);return;}
  if(a>opdDueInv.due){N(`Cannot exceed due of ‡ß≥${opdDueInv.due}.`,true);return;}
  try{
    const newPaid=parseFloat((opdDueInv.paid+a).toFixed(2));
    const newDue=parseFloat((opdDueInv.due-a).toFixed(2));
    const newStatus=newDue<=0?'paid':'due';
    DB.update('opd_invoices',i=>i.id===opdDueInv.id,{paid:newPaid,due:newDue,status:newStatus});
    N(`‚úì ‡ß≥${a.toLocaleString()} collected for OPD invoice ${opdDueInv.no}.`);
    // Show due receipt
    const updInv=DB.findOne('opd_invoices',i=>i.id===opdDueInv.id)||opdDueInv;
    opdDueInv=null;
    closeModal('m-due');
    rOpdDueList();
  }catch(e){N('Collection failed: '+e.message,true);}
}

function rOpdDoctors(){
  renderOpdDoctors();
}
function renderOpdDoctors(){
  const docs=DB.getBy('opd_docs','cid',S.cid);
  document.getElementById('opdBody').innerHTML=`
  <div style="display:grid;grid-template-columns:1fr 280px;gap:14px;">
    <div>
      <div class="box">
        <div class="box-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>OPD Doctors (${docs.length})</span>
          <button class="btn btn-t btn-sm" onclick="openAddOpdDoc()">+ Add Doctor</button>
        </div>
        ${docs.length===0?'<p style="color:var(--gray);font-size:13px;">No doctors added yet.</p>':''}
        ${docs.length>0?`<div class="tbl-wrap"><table>
          <thead><tr><th>Name</th><th>Degree</th><th>Dept</th><th>Contact</th><th>Actions</th></tr></thead>
          <tbody>${docs.map(d=>`<tr>
            <td style="font-weight:600">${escHtml(d.name)}</td>
            <td style="color:var(--purple)">${escHtml(d.degree||'‚Äî')}</td>
            <td><span class="badge b-paid">${escHtml(d.dept||'‚Äî')}</span></td>
            <td>${escHtml(d.contact||'‚Äî')}</td>
            <td style="white-space:nowrap">
              <button class="btn btn-o btn-sm" onclick="openEditOpdDoc('${d.id}')">‚úèÔ∏è Edit</button>
              <button class="btn btn-r btn-sm" onclick="deleteOpdDoc('${d.id}')">üóë</button>
            </td>
          </tr>`).join('')}</tbody>
        </table></div>`:''}
      </div>
    </div>
    <div class="box">
      <div class="box-title">Doctor List Preview</div>
      <p style="font-size:12px;color:var(--text2);">Doctors available for OPD invoice auto-complete.</p>
      <div style="margin-top:10px;">
        ${docs.slice(0,5).map(d=>`<div class="side-item" style="margin-bottom:4px;font-size:11px;">
          <strong>${escHtml(d.name)}</strong>${d.degree?' ‚Üí '+escHtml(d.degree):''}
        </div>`).join('')}
      </div>
    </div>
  </div>`;
}
function openAddOpdDoc(){
  ['odoc_id','odoc_name','odoc_code','odoc_title','odoc_contact','odoc_email','odoc_dept','odoc_addr','odoc_desc'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('opd-doc-modal-title').textContent='üë®‚Äç‚öïÔ∏è Add Doctor (OPD)';
  openModal('m-opd-doc');
}
function openEditOpdDoc(id){
  const d=DB.findOne('opd_docs',x=>x.id===id); if(!d) return;
  document.getElementById('odoc_id').value=d.id;
  document.getElementById('odoc_name').value=d.name||'';
  document.getElementById('odoc_degree').value=d.degree||d.title||'';
  document.getElementById('odoc_contact').value=d.contact||'';
  document.getElementById('odoc_dept').value=d.dept||'';
  document.getElementById('odoc_addr').value=d.addr||'';
  document.getElementById('opd-doc-modal-title').textContent='‚úèÔ∏è Edit Doctor';
  openModal('m-opd-doc');
}
function saveOpdDoc(){
  const name=document.getElementById('odoc_name').value.trim();
  const degree=document.getElementById('odoc_degree').value.trim();
  if(!name){N('Name is required.',true);return;}
  const id=document.getElementById('odoc_id').value;
  // Auto-generate code from name (first 4 chars uppercase) - used only for backend
  const code=id?(DB.findOne('opd_docs',d=>d.id===id)?.code||name.replace(/[^A-Z]/gi,'').toUpperCase().slice(0,4)):name.replace(/[^A-Z]/gi,'').toUpperCase().slice(0,4);
  const data={name,code,degree,title:'Dr.',contact:document.getElementById('odoc_contact').value.trim(),email:'',dept:document.getElementById('odoc_dept').value.trim(),addr:document.getElementById('odoc_addr').value.trim(),description:'',cid:S.cid};
  try{
    if(id){DB.update('opd_docs',d=>d.id===id,data);N(`‚úì Doctor "${name}" updated.`);}
    else{DB.insert('opd_docs',{...data,id:uid(),createdAt:new Date().toISOString()});N(`‚úì Doctor "${name}" added.`);}
    closeModal('m-opd-doc');renderOpdDoctors();
  }catch(e){N('Failed: '+e.message,true);}
}
function deleteOpdDoc(id){
  if(!confirm('Delete this doctor?')) return;
  try{DB.delete('opd_docs',d=>d.id===id);N('Doctor deleted.');renderOpdDoctors();}
  catch(e){N('Failed: '+e.message,true);}
}

function rOpdReferences(){
  renderOpdRefs();
}
function renderOpdRefs(){
  const refs=DB.getBy('opd_refs','cid',S.cid);
  document.getElementById('opdBody').innerHTML=`
  <div class="box">
    <div class="box-title" style="display:flex;justify-content:space-between;align-items:center;">
      <span>References (${refs.length})</span>
      <button class="btn btn-t btn-sm" onclick="openAddOpdRef()">+ Add Reference</button>
    </div>
    ${refs.length===0?'<p style="color:var(--gray);font-size:13px;">No references added yet.</p>':''}
    ${refs.length>0?`<div class="tbl-wrap"><table>
      <thead><tr><th>Name</th><th>Title</th><th>Contact</th><th>Commission %</th><th>Actions</th></tr></thead>
      <tbody>${refs.map(r=>`<tr>
        <td style="font-weight:600">${escHtml(r.name)}</td>
        <td style="color:var(--text2)">${escHtml(r.title||'‚Äî')}</td>
        <td>${escHtml(r.contact||'‚Äî')}</td>
        <td style="font-family:var(--mono);color:var(--amber)">${r.commission||0}%</td>
        <td style="white-space:nowrap">
          <button class="btn btn-o btn-sm" onclick="openEditOpdRef('${r.id}')">‚úèÔ∏è Edit</button>
          <button class="btn btn-r btn-sm" onclick="deleteOpdRef('${r.id}')">üóë</button>
        </td>
      </tr>`).join('')}</tbody>
    </table></div>`:''}
  </div>`;
}
function openAddOpdRef(){
  ['oref_id','oref_name','oref_code','oref_title','oref_contact','oref_email','oref_addr','oref_desc'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  const cm=document.getElementById('oref_commission');if(cm)cm.value='0';
  document.getElementById('opd-ref-modal-title').textContent='‚ûï Add Reference';
  openModal('m-opd-ref');
}
function openEditOpdRef(id){
  const r=DB.findOne('opd_refs',x=>x.id===id); if(!r) return;
  document.getElementById('oref_id').value=r.id;
  document.getElementById('oref_name').value=r.name||'';
  document.getElementById('oref_code').value=r.code||'';
  document.getElementById('oref_title').value=r.title||'';
  document.getElementById('oref_contact').value=r.contact||'';
  document.getElementById('oref_email').value=r.email||'';
  document.getElementById('oref_commission').value=r.commission||0;
  document.getElementById('oref_addr').value=r.addr||'';
  document.getElementById('oref_desc').value=r.description||'';
  document.getElementById('opd-ref-modal-title').textContent='‚úèÔ∏è Edit Reference';
  openModal('m-opd-ref');
}
function saveOpdRef(){
  const name=document.getElementById('oref_name').value.trim();
  const code=document.getElementById('oref_code').value.trim();
  if(!name||!code){N('Name and Code are required.',true);return;}
  const id=document.getElementById('oref_id').value;
  const barcode=code.toUpperCase().replace(/[^A-Z0-9]/g,'');
  const data={name,code,barcode,title:document.getElementById('oref_title').value.trim(),contact:document.getElementById('oref_contact').value.trim(),email:document.getElementById('oref_email').value.trim(),commission:parseFloat(document.getElementById('oref_commission').value||0),addr:document.getElementById('oref_addr').value.trim(),description:document.getElementById('oref_desc').value.trim(),cid:S.cid};
  try{
    if(id){DB.update('opd_refs',r=>r.id===id,data);N(`‚úì Reference "${name}" updated.`);}
    else{DB.insert('opd_refs',{...data,id:uid(),createdAt:new Date().toISOString()});N(`‚úì Reference "${name}" added.`);}
    closeModal('m-opd-ref');renderOpdRefs();
  }catch(e){N('Failed: '+e.message,true);}
}
function deleteOpdRef(id){
  if(!confirm('Delete this reference?')) return;
  try{DB.delete('opd_refs',r=>r.id===id);N('Reference deleted.');renderOpdRefs();}
  catch(e){N('Failed: '+e.message,true);}
}

function rOpdQuickService(){
  renderOpdServices();
}

function openQuickServiceWindow(){
  // Opens a separate invoice window - independent reception desk workflow
  const svcs=DB.getBy('opd_services','cid',S.cid).filter(s=>s.status!=='inactive');
  const docs=DB.getBy('opd_docs','cid',S.cid);
  const refs=DB.getBy('opd_refs','cid',S.cid);
  const today=new Date().toISOString().split('T')[0];
  const no=nextOpdInvNo(S.cid);
  const cats=[...new Set(svcs.map(s=>s.cat))];
  const w=window.open('','_blank','width=960,height=760,left=100,top=80');
  if(!w){N('Pop-up blocked. Please allow pop-ups.',true);return;}
  const svcDataJS=JSON.stringify(svcs);
  const docDataJS=JSON.stringify(docs);
  const refDataJS=JSON.stringify(refs);
  w.document.write(`<!DOCTYPE html><html><head>
  <title>Quick Service Invoice ‚Äî ${no}</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f4f8;color:#1e293b;padding:0;}
    .header{background:#1a2e45;color:#fff;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;}
    .header h1{font-size:15px;font-weight:700;}
    .header .invno{font-size:11px;opacity:.7;margin-top:2px;}
    .body{padding:16px;display:grid;grid-template-columns:1fr 280px;gap:14px;height:calc(100vh - 52px);overflow:auto;}
    .box{background:#fff;border:1px solid #d1dce8;border-radius:10px;padding:14px;margin-bottom:12px;}
    .box-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#475569;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #e2e8f0;}
    .fi label{display:block;font-size:10px;color:#475569;text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px;font-weight:600;}
    .fi input,.fi select{width:100%;padding:7px 11px;background:#fff;border:1px solid #d1dce8;border-radius:6px;color:#1e293b;font-size:13px;outline:none;}
    .fi input:focus,.fi select:focus{border-color:#0096c7;box-shadow:0 0 0 3px rgba(0,150,199,.1);}
    .f2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
    .f4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-bottom:10px;}
    .svc-scroll{max-height:200px;overflow-y:auto;border:1px solid #d1dce8;border-radius:6px;}
    .svc-row{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;cursor:pointer;font-size:12px;border-bottom:1px solid #e2e8f0;transition:.12s;}
    .svc-row:hover{background:#e0f3fb;color:#0096c7;}
    .svc-row:last-child{border-bottom:none;}
    .sel-item{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:6px;margin-bottom:5px;font-size:12px;}
    .trm{cursor:pointer;color:#dc2626;font-weight:700;font-size:15px;padding:0 4px;}
    .tot-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #e2e8f0;font-size:12px;}
    .tot-grand{font-weight:700;font-size:14px;color:#059669;}
    .tot-due{font-weight:700;font-size:13px;color:#dc2626;}
    .tinput{width:120px;padding:5px 8px;border:1px solid #d1dce8;border-radius:5px;text-align:right;font-size:13px;outline:none;}
    .bar{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
    .bar input,.bar select{padding:7px 10px;border:1px solid #d1dce8;border-radius:6px;font-size:12px;outline:none;}
    .btn{padding:9px 18px;border-radius:7px;border:none;cursor:pointer;font-size:13px;font-weight:600;}
    .btn-t{background:#1a2e45;color:#fff;}
    .btn-r{background:#fee2e2;color:#dc2626;}
    @media print{.no-print{display:none;}}
  </style>
  </head><body>
  <div class="header">
    <div><h1>‚ö° Quick Service Invoice</h1><div class="invno">Invoice No: ${no} ‚Äî ${today}</div></div>
    <button class="btn btn-r no-print" onclick="window.close()">‚úï Close</button>
  </div>
  <div class="body">
    <div>
      <div class="box">
        <div class="box-title">Patient Info</div>
        <div class="f4">
          <div class="fi"><label>Name *</label><input id="qs_name" placeholder="Full name" autofocus></div>
          <div class="fi"><label>Phone</label><input id="qs_phone" placeholder="01X00-000000"></div>
          <div class="fi"><label>Age</label><input id="qs_age" placeholder="35 Y"></div>
          <div class="fi"><label>Gender</label><select id="qs_gender"><option value="">‚Äî</option><option>Male</option><option>Female</option><option>Other</option></select></div>
        </div>
        <div class="f2">
          <div class="fi"><label>Doctor</label>
            <input id="qs_doc" placeholder="Dr. Name" list="qs-doc-list">
            <datalist id="qs-doc-list">${docs.map(d=>`<option value="${d.title||''} ${d.name} (${d.code})">`).join('')}</datalist>
          </div>
          <div class="fi"><label>Reference</label>
            <select id="qs_ref">
              <option value="">‚Äî None ‚Äî</option>
              ${refs.map(r=>`<option value="${r.id}">${r.name} (${r.code})</option>`).join('')}
            </select>
          </div>
        </div>
      </div>
      <div class="box">
        <div class="box-title">Select Services</div>
        <div class="bar">
          <input id="qs_sq" placeholder="Search service..." oninput="fSvc()" style="flex:1;">
          <select id="qs_sc" onchange="fSvc()">
            <option value="">All Categories</option>
            ${cats.map(c=>`<option>${c}</option>`).join('')}
          </select>
        </div>
        <div class="svc-scroll" id="qs_svc_list"></div>
        <div style="margin-top:12px;padding-top:10px;border-top:1px solid #e2e8f0;">
          <div class="box-title" style="margin-bottom:8px;">Selected</div>
          <div id="qs_sel_el"><em style="font-size:12px;color:#94a3b8;">None selected.</em></div>
        </div>
      </div>
    </div>
    <div>
      <div class="box">
        <div class="box-title">Billing Summary</div>
        <div class="tot-row"><span>Subtotal</span><span id="qs_ts">‡ß≥ 0</span></div>
        <div class="tot-row"><span>Discount (‡ß≥)</span><input class="tinput" id="qs_td" type="number" min="0" value="0" oninput="calcQs()"></div>
        <div class="tot-row"><span>Net Payable</span><span id="qs_tn">‡ß≥ 0</span></div>
        <div class="tot-row"><span>Paid (‡ß≥)</span><input class="tinput" id="qs_tp" type="number" min="0" value="0" oninput="calcQs()"></div>
        <div class="tot-row tot-grand"><span>Grand Total</span><span id="qs_tg">‡ß≥ 0</span></div>
        <div class="tot-row tot-due"><span>Due</span><span id="qs_tdu">‡ß≥ 0</span></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <button class="btn btn-t" onclick="saveQsInvoice()">üñ® Save &amp; Print</button>
        <button class="btn btn-r" onclick="clearQs()">‚úï Clear Form</button>
      </div>
    </div>
  </div>
  <script>
  const SVCS=${svcDataJS};
  let sel=[];
  function fSvc(){
    const q=(document.getElementById('qs_sq')?.value||'').toLowerCase();
    const cat=document.getElementById('qs_sc')?.value||'';
    const rows=SVCS.filter(s=>s.name.toLowerCase().includes(q)&&(cat===''||s.cat===cat));
    document.getElementById('qs_svc_list').innerHTML=rows.map(s=>
      \`<div class="svc-row" onclick="addSvc('\${s.id}')"><span>\${s.name} <small style="color:#94a3b8;">(\${s.cat})</small></span><span style="color:#0096c7;font-weight:600;">‡ß≥\${s.price}</span></div>\`
    ).join('')||'<div style="padding:10px;font-size:12px;color:#94a3b8;">No services found.</div>';
  }
  function addSvc(id){
    if(sel.find(s=>s.id===id)){alert('Already added.');return;}
    const s=SVCS.find(s=>s.id===id);if(!s)return;
    sel.push({...s});upSel();calcQs();
  }
  function rmSvc(id){sel=sel.filter(s=>s.id!==id);upSel();calcQs();}
  function upSel(){
    const el=document.getElementById('qs_sel_el');if(!el)return;
    if(!sel.length){el.innerHTML='<em style="font-size:12px;color:#94a3b8;">None selected.</em>';return;}
    el.innerHTML=sel.map(s=>\`<div class="sel-item">
      <span>\${s.name}</span>
      <span style="display:flex;align-items:center;gap:8px;">
        <span style="color:#0096c7;font-size:11px;">‡ß≥\${s.price}</span>
        <span class="trm" onclick="rmSvc('\${s.id}')">√ó</span>
      </span></div>\`).join('');
  }
  function calcQs(){
    const sub=sel.reduce((a,s)=>a+s.price,0);
    const disc=Math.min(parseFloat(document.getElementById('qs_td')?.value||0),sub);
    const net=sub-disc,paid=parseFloat(document.getElementById('qs_tp')?.value||0),due=Math.max(net-paid,0);
    document.getElementById('qs_ts').textContent='‡ß≥ '+sub.toLocaleString();
    document.getElementById('qs_tn').textContent='‡ß≥ '+net.toLocaleString();
    document.getElementById('qs_tg').textContent='‡ß≥ '+net.toLocaleString();
    document.getElementById('qs_tdu').textContent='‡ß≥ '+due.toLocaleString();
  }
  function clearQs(){
    sel=[];upSel();calcQs();
    ['qs_name','qs_phone','qs_age','qs_doc','qs_td','qs_tp'].forEach(id=>{const e=document.getElementById(id);if(e)e.value=id.includes('td')||id.includes('tp')?'0':''});
    document.getElementById('qs_gender').selectedIndex=0;
    document.getElementById('qs_ref').selectedIndex=0;
  }
  function saveQsInvoice(){
    const name=document.getElementById('qs_name')?.value?.trim();
    if(!name){alert('Patient name required.');return;}
    if(!sel.length){alert('Select at least one service.');return;}
    const sub=sel.reduce((a,s)=>a+s.price,0);
    const disc=Math.min(parseFloat(document.getElementById('qs_td')?.value||0),sub);
    const net=sub-disc,paid=parseFloat(document.getElementById('qs_tp')?.value||0),due=Math.max(net-paid,0);
    const now=new Date();
    const ts=now.toLocaleDateString('en-GB')+' '+now.toLocaleTimeString('en-GB');
    const printHtml=\`<html><head><title>QS Invoice ${no}</title>
    <style>body{font-family:'Times New Roman',Times,serif;font-size:11pt;color:#000;padding:20px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:4px 8px;font-size:10pt;}th{background:#f0f0f0;}</style>
    </head><body onload="setTimeout(()=>{window.print();},400);">
    <div style="text-align:center;border-bottom:2px double #000;padding-bottom:10px;margin-bottom:10px;">
      <div style="font-size:15pt;font-weight:bold;">QUICK SERVICE RECEIPT</div>
      <div style="font-size:9pt;">Invoice No: ${no} | Date: \${now.toLocaleDateString('en-GB')}</div>
    </div>
    <div style="margin-bottom:8px;font-size:10pt;">
      <strong>Patient:</strong> \${name} &nbsp;|&nbsp; <strong>Phone:</strong> \${document.getElementById('qs_phone')?.value||'‚Äî'} &nbsp;|&nbsp; <strong>Age:</strong> \${document.getElementById('qs_age')?.value||'‚Äî'} | <strong>Gender:</strong> \${document.getElementById('qs_gender')?.value||'‚Äî'}
      <br><strong>Doctor:</strong> \${document.getElementById('qs_doc')?.value||'‚Äî'}
    </div>
    <table><thead><tr><th>Service</th><th>Category</th><th style="text-align:right;">Price (‡ß≥)</th></tr></thead>
    <tbody>\${sel.map(s=>\`<tr><td>\${s.name}</td><td>\${s.cat}</td><td style="text-align:right;">\${s.price}</td></tr>\`).join('')}</tbody></table>
    <table style="margin-top:6px;width:50%;margin-left:50%;"><tr><td>Subtotal:</td><td style="text-align:right;">‡ß≥\${sub.toLocaleString()}</td></tr>
    <tr><td>Discount:</td><td style="text-align:right;">‡ß≥\${disc.toLocaleString()}</td></tr>
    <tr style="font-weight:bold;"><td>Net Payable:</td><td style="text-align:right;">‡ß≥\${net.toLocaleString()}</td></tr>
    <tr><td>Paid:</td><td style="text-align:right;">‡ß≥\${paid.toLocaleString()}</td></tr>
    <tr style="color:\${due>0?'red':'green'};font-weight:bold;"><td>Due:</td><td style="text-align:right;">‡ß≥\${due.toLocaleString()}</td></tr></table>
    <div style="margin-top:20px;font-size:8pt;color:#555;">Generated: \${ts}</div>
    </body></html>\`;
    const pw=window.open('','_blank','width=700,height=900');
    if(pw){pw.document.write(printHtml);pw.document.close();}
    clearQs();
  }
  fSvc();
  <\/script>
  </body></html>`);
  w.document.close();
}
function renderOpdServices(){
  const svcs=DB.getBy('opd_services','cid',S.cid);
  document.getElementById('opdBody').innerHTML=`
  <div class="box" style="background:linear-gradient(135deg,#e0f3fb,#f0f9ff);border-color:rgba(0,150,199,.25);margin-bottom:4px;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-size:14px;font-weight:700;color:var(--navy);">‚ö° Quick Service Invoice Window</div>
        <div style="font-size:11px;color:var(--text2);margin-top:3px;">Opens a separate, independent invoice window. Multiple desks can work simultaneously.</div>
      </div>
      <button class="btn btn-t" onclick="openQuickServiceWindow()" style="white-space:nowrap;font-size:13px;padding:10px 20px;">‚ö° Open Invoice Window</button>
    </div>
  </div>
  <div class="box">
    <div class="box-title" style="display:flex;justify-content:space-between;align-items:center;">
      <span>Manage Quick Services (${svcs.length})</span>
      <button class="btn btn-t btn-sm" onclick="showAddOpdSvcForm()">+ Add Service</button>
    </div>
    <div id="opd-svc-form-area"></div>
    <div class="tbl-wrap"><table>
      <thead><tr><th>Name</th><th>Category</th><th>Price</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="opd_svc_tb">${buildOpdSvcTableRows(svcs)}</tbody>
    </table></div>
  </div>`;
}
function buildOpdSvcTableRows(svcs){
  return svcs.map(s=>`<tr style="${s.status==='inactive'?'opacity:.5':''}">
    <td style="font-weight:500">${escHtml(s.name)}</td>
    <td><span class="badge b-paid">${escHtml(s.cat||'General')}</span></td>
    <td style="font-family:var(--mono);color:var(--teal)">‡ß≥${s.price}</td>
    <td><span class="badge ${s.status==='inactive'?'b-due':'b-active'}">${(s.status||'active').toUpperCase()}</span></td>
    <td style="white-space:nowrap">
      <button class="btn btn-o btn-sm" onclick="toggleOpdSvc('${s.id}','${s.status==='inactive'?'active':'inactive'}')">
        ${s.status==='inactive'?'‚úì Activate':'‚äò Deactivate'}
      </button>
      <button class="btn btn-r btn-sm" onclick="deleteOpdSvc('${s.id}')">üóë</button>
    </td>
  </tr>`).join('')||`<tr><td colspan="5" style="color:var(--gray);text-align:center;padding:16px;">No services.</td></tr>`;
}
function showAddOpdSvcForm(){
  const area=document.getElementById('opd-svc-form-area'); if(!area) return;
  area.innerHTML=`<div class="box" style="background:rgba(0,180,216,.04);border-color:rgba(0,180,216,.2);margin-bottom:12px;">
    <div class="box-title">Add Quick Service</div>
    <div class="f3" style="margin-bottom:12px;">
      <div class="fi"><label>Service Name *</label><input id="ns_name" placeholder="e.g. ECG" autofocus></div>
      <div class="fi"><label>Category *</label><input id="ns_cat" placeholder="e.g. Cardiology"></div>
      <div class="fi"><label>Price (‡ß≥) *</label><input id="ns_price" type="number" min="0" placeholder="500"></div>
    </div>
    <div class="action-row">
      <button class="btn btn-t" onclick="saveOpdSvc()">üíæ Save</button>
      <button class="btn btn-o" onclick="document.getElementById('opd-svc-form-area').innerHTML=''">Cancel</button>
    </div>
  </div>`;
}
function saveOpdSvc(){
  const name=document.getElementById('ns_name')?.value?.trim();
  const cat=document.getElementById('ns_cat')?.value?.trim();
  const price=parseFloat(document.getElementById('ns_price')?.value||0);
  if(!name||!cat||price<=0){N('Name, category, and price (>0) required.',true);return;}
  try{
    DB.insert('opd_services',{id:uid(),cid:S.cid,name,cat,price,status:'active',createdAt:new Date().toISOString()});
    N(`‚úì Service "${name}" added.`);
    renderOpdServices();
  }catch(e){N('Failed: '+e.message,true);}
}
function toggleOpdSvc(id,status){
  try{DB.update('opd_services',s=>s.id===id,{status});N('Service updated.');renderOpdServices();}
  catch(e){N('Failed: '+e.message,true);}
}
function deleteOpdSvc(id){
  if(!confirm('Delete this service?')) return;
  try{DB.delete('opd_services',s=>s.id===id);N('Service deleted.');renderOpdServices();}
  catch(e){N('Failed: '+e.message,true);}
}

function rOpdSettings(){
  const cu=DB.findOne('users',u=>u.u===S.u)||{};
  document.getElementById('opdBody').innerHTML=`
  <div class="box" style="max-width:560px;">
    <div class="box-title">OPD Settings ‚Äî My Profile</div>
    <div class="f2" style="margin-bottom:12px;">
      <div class="fi"><label>Full Name</label><input id="opd_mp_name" value="${escHtml(cu.name||'')}"></div>
      <div class="fi"><label>Username (readonly)</label><input value="${escHtml(cu.u||'')}" readonly></div>
    </div>
    <div class="f2" style="margin-bottom:14px;">
      <div class="fi"><label>Role</label><input value="${escHtml(cu.role||'')}" readonly></div>
      <div class="fi"><label>Clinic</label><input value="${escHtml(S.cliName||'')}" readonly></div>
    </div>
    <div class="action-row"><button class="btn btn-t" onclick="saveOpdProfile()">üíæ Update Name</button></div>
    <div class="pw-section">
      <div class="box-title">üîë Change Password</div>
      <div class="fi" style="margin-bottom:10px;"><label>Current Password *</label><input type="password" id="opd_sp_old" placeholder="Enter current password"></div>
      <div class="fi" style="margin-bottom:10px;"><label>New Password *</label><input type="password" id="opd_sp_new" placeholder="Min 6 characters"></div>
      <div class="fi" style="margin-bottom:10px;"><label>Confirm New Password *</label><input type="password" id="opd_sp_confirm" placeholder="Repeat new password"></div>
      <div id="opd_sp_err" style="min-height:14px;font-size:12px;color:var(--red);margin-bottom:8px;"></div>
      <div class="action-row"><button class="btn btn-t" onclick="doOpdChangePw()">üîë Change Password</button></div>
    </div>
  </div>`;
}
function saveOpdProfile(){
  const name=document.getElementById('opd_mp_name')?.value?.trim();
  if(!name){N('Name required.',true);return;}
  try{
    DB.update('users',u=>u.u===S.u,{name});
    S.name=name; sessionStorage.setItem('akbd_session',JSON.stringify(S));
    document.getElementById('tbUser').textContent=name;
    N('‚úì Profile updated.');
  }catch(e){N('Failed: '+e.message,true);}
}
async function doOpdChangePw(){
  const old=document.getElementById('opd_sp_old')?.value;
  const nw=document.getElementById('opd_sp_new')?.value;
  const cf=document.getElementById('opd_sp_confirm')?.value;
  const err=document.getElementById('opd_sp_err');
  if(err) err.textContent='';
  if(!old||!nw||!cf){if(err)err.textContent='All fields required.';return;}
  if(nw.length<6){if(err)err.textContent='Min 6 characters.';return;}
  if(nw!==cf){if(err)err.textContent='Passwords do not match.';return;}
  const cu=DB.findOne('users',u=>u.u===S.u);
  if(!cu){if(err)err.textContent='User not found.';return;}
  const valid=await verifyPassword(old,cu.p);
  if(!valid){if(err)err.textContent='Current password incorrect.';return;}
  try{
    const hashed=await hashPassword(nw);
    DB.update('users',u=>u.u===S.u,{p:hashed,pwChangedAt:new Date().toISOString()});
    N('‚úì Password changed.');
    ['opd_sp_old','opd_sp_new','opd_sp_confirm'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  }catch(e){if(err)err.textContent='Failed: '+e.message;}
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OPD REPORTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rOpdReports(){
  const today=new Date().toISOString().split('T')[0];
  const yearStart=new Date().getFullYear()+'-01-01';
  document.getElementById('opdBody').innerHTML=`
  <div class="box">
    <div class="box-title">OPD Department Collection Report</div>
    <div class="bar">
      From:<input type="date" id="opd_rf" value="${yearStart}" style="color:var(--text);">
      To:<input type="date" id="opd_rt" value="${today}" style="color:var(--text);">
      <button class="btn btn-t btn-sm" onclick="genOpdReport()">Generate</button>
      <button class="btn btn-o btn-sm" onclick="printOpdReport()">üñ® Print</button>
    </div>
    <div id="opd_rpt_out"><p style="color:var(--text2);font-size:13px;">Click Generate to load.</p></div>
  </div>`;
}
function genOpdReport(){
  const f=document.getElementById('opd_rf')?.value,t=document.getElementById('opd_rt')?.value;
  const invs=DB.get('opd_invoices').filter(i=>i.cid===S.cid&&i.date>=f&&i.date<=t);
  const byUser={};
  invs.forEach(i=>{
    if(!byUser[i.by])byUser[i.by]={count:0,billed:0,collected:0,due:0};
    byUser[i.by].count++;byUser[i.by].billed+=i.subtotal;byUser[i.by].collected+=i.paid;byUser[i.by].due+=i.due;
  });
  const tot=invs.reduce((s,i)=>s+i.subtotal,0);
  const paid=invs.reduce((s,i)=>s+i.paid,0);
  const due=invs.reduce((s,i)=>s+i.due,0);
  const el=document.getElementById('opd_rpt_out');
  if(!el) return;
  el.innerHTML=`
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:14px;">
    <div class="stat-card"><div class="snum" style="color:var(--teal)">${invs.length}</div><div class="slbl">Invoices</div></div>
    <div class="stat-card"><div class="snum" style="color:var(--navy)">‡ß≥${tot.toLocaleString()}</div><div class="slbl">Total Billed</div></div>
    <div class="stat-card"><div class="snum" style="color:var(--green)">‡ß≥${paid.toLocaleString()}</div><div class="slbl">Collected</div></div>
    <div class="stat-card"><div class="snum" style="color:var(--red)">‡ß≥${due.toLocaleString()}</div><div class="slbl">Due</div></div>
  </div>
  ${Object.keys(byUser).length?`<div class="box"><div class="box-title">User-wise Collection</div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>User</th><th>Invoices</th><th>Total Billed</th><th>Collected</th><th>Due</th></tr></thead>
    <tbody>${Object.entries(byUser).map(([u,v])=>`<tr>
      <td style="font-weight:500">${escHtml(u)}</td>
      <td style="font-family:var(--mono)">${v.count}</td>
      <td style="font-family:var(--mono)">‡ß≥${v.billed.toLocaleString()}</td>
      <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.collected.toLocaleString()}</td>
      <td><span class="badge ${v.due>0?'b-due':'b-active'}">‡ß≥${v.due.toLocaleString()}</span></td>
    </tr>`).join('')}</tbody>
  </table></div></div>`:''}
  <div class="box"><div class="box-title">OPD Invoices ‚Äî ${f} to ${t}</div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Invoice</th><th>Date</th><th>Patient</th><th>Doctor</th><th>Total</th><th>Paid</th><th>Due</th><th>Status</th></tr></thead>
    <tbody>${invs.map(v=>`<tr>
      <td style="font-family:var(--mono);color:var(--teal)">${v.no}</td>
      <td>${v.date}</td>
      <td style="font-weight:500">${escHtml(v.patient)}</td>
      <td style="font-size:11px">${escHtml(v.docName||'‚Äî')}</td>
      <td style="font-family:var(--mono)">‡ß≥${v.subtotal.toLocaleString()}</td>
      <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
      <td><span class="badge ${v.due>0?'b-due':'b-active'}">‡ß≥${v.due.toLocaleString()}</span></td>
      <td><span class="badge ${v.status==='paid'?'b-active':'b-due'}">${(v.status||'').toUpperCase()}</span></td>
    </tr>`).join('')||`<tr><td colspan="8" style="text-align:center;color:var(--text2);padding:20px;">No records found.</td></tr>`}</tbody>
  </table></div></div>`;
}
function printOpdReport(){
  const el=document.getElementById('opd_rpt_out');
  if(!el||!el.textContent.trim()||el.querySelector('p')) {N('Generate report first.',true);return;}
  const clinic=getClinic(S.cid)||{};
  const f=document.getElementById('opd_rf')?.value||'‚Äî',t=document.getElementById('opd_rt')?.value||'‚Äî';
  const w=window.open('','_blank','width=870,height=1100');
  if(!w){N('Pop-up blocked.',true);return;}
  w.document.write(`<!DOCTYPE html><html><head><title>OPD Report</title>
  <style>body{font-family:Arial,sans-serif;padding:30px;color:#000;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:5px 8px;font-size:10pt;}th{background:#f0f0f0;}.stat-card{display:inline-block;border:1px solid #ccc;padding:12px 18px;margin:4px;text-align:center;min-width:120px;}.snum{font-size:18pt;font-weight:bold;}.slbl{font-size:8pt;text-transform:uppercase;color:#666;}</style></head>
  <body onload="setTimeout(()=>{window.print();window.close();},500);">
    <div style="text-align:center;border-bottom:2px solid #000;padding-bottom:12px;margin-bottom:16px;">
      <div style="font-size:18pt;font-weight:bold;">${escHtml(clinic.header||clinic.name||'CLINIC')}</div>
      <div style="font-size:10pt;">OPD Collection Report ‚Äî ${escHtml(f)} to ${escHtml(t)}</div>
    </div>
    ${el.innerHTML}
  </body></html>`);
  w.document.close();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OPD ACCOUNTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rOpdAccounts(){
  const invs=DB.get('opd_invoices').filter(i=>i.cid===S.cid);
  const tot=invs.reduce((s,i)=>s+i.subtotal,0);
  const coll=invs.reduce((s,i)=>s+i.paid,0);
  const due=invs.reduce((s,i)=>s+i.due,0);
  document.getElementById('opdBody').innerHTML=`
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:18px;">
    <div class="acc-card"><div class="an" style="color:var(--teal)">‡ß≥${tot.toLocaleString()}</div><div class="al">Total Billed</div></div>
    <div class="acc-card"><div class="an" style="color:var(--green)">‡ß≥${coll.toLocaleString()}</div><div class="al">Collected</div></div>
    <div class="acc-card"><div class="an" style="color:var(--red)">‡ß≥${due.toLocaleString()}</div><div class="al">Total Due</div></div>
  </div>
  <div class="box">
    <div class="box-title">OPD Invoice Summary (All Time)</div>
    <div class="tbl-wrap"><table>
      <thead><tr><th>Invoice</th><th>Date</th><th>Patient</th><th>Doctor</th><th>Total</th><th>Paid</th><th>Due</th><th>Status</th><th></th></tr></thead>
      <tbody>${invs.sort((a,b)=>b.date.localeCompare(a.date)).map(v=>`<tr>
        <td style="font-family:var(--mono);color:var(--teal)">${v.no}</td>
        <td>${v.date}</td>
        <td style="font-weight:500">${escHtml(v.patient)}</td>
        <td style="font-size:11px">${escHtml(v.docName||'‚Äî')}</td>
        <td style="font-family:var(--mono)">‡ß≥${v.subtotal.toLocaleString()}</td>
        <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
        <td><span class="badge ${v.due>0?'b-due':'b-active'}">‡ß≥${v.due.toLocaleString()}</span></td>
        <td><span class="badge ${v.status==='paid'?'b-active':'b-due'}">${(v.status||'').toUpperCase()}</span></td>
        <td><button class="btn btn-o btn-sm" onclick="reviewOpdInv('${v.id}')">üëÅ</button></td>
      </tr>`).join('')||`<tr><td colspan="9" style="text-align:center;color:var(--text2);padding:20px;">No OPD invoices.</td></tr>`}</tbody>
    </table></div>
  </div>`;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INDOOR MODULE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const INDOOR_TABS_ALL=['Indoor Report','Department Collection','User Collection','IPD Patients','Admission','Deposit','Indoor Billing','Discharge','Settings'];
const INDOOR_FUNS_ALL=[rIndoorReport,rDeptCollection,rIndoorUserColl,rIPDPatients,rIPDAdmission,rIPDDeposit,rIPDBilling,rIPDDischarge,rIndoorSettings];
const INDOOR_TABS_RECEPTION=['Indoor Report','Department Collection','IPD Patients','Admission','Deposit','Indoor Billing'];
const INDOOR_FUNS_RECEPTION=[rIndoorReport,rDeptCollection,rIPDPatients,rIPDAdmission,rIPDDeposit,rIPDBilling];
let INDOOR_TABS=INDOOR_TABS_ALL, INDOOR_FUNS=INDOOR_FUNS_ALL;
function openIndoor(){
  if(!can('indoor')){N('Access denied.',true);return;}
  // Set tabs based on role - reception cannot discharge
  const canDischarge=['admin','superadmin'].includes(S?.role);
  INDOOR_TABS=canDischarge?INDOOR_TABS_ALL:INDOOR_TABS_RECEPTION;
  INDOOR_FUNS=canDischarge?INDOOR_FUNS_ALL:INDOOR_FUNS_RECEPTION;
  document.getElementById('tbTitle').textContent='Indoor';
  buildIndoorTabs(0);
  rIndoorReport();
  showScreen('indoor');
}
function buildIndoorTabs(ai){
  const restricted=['indoor'].includes(S?.role);
  const backBtn=restricted
    ?`<button class="ws-back" onclick="doLogout()">‚èè Logout</button>`
    :`<button class="ws-back" onclick="goToDash()">‚Üê Dashboard</button>`;
  document.getElementById('indoorNav').innerHTML=
    INDOOR_TABS.map((t,i)=>`<div class="ws-tab${i===ai?' active':''}" onclick="swIndoorTab(this,${i})">${t}</div>`).join('')+
    `<div class="ws-spacer"></div>${backBtn}`;
}
function swIndoorTab(el,i){
  document.querySelectorAll('#indoorNav .ws-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  INDOOR_FUNS[i]();
}

// Department Collection (calendar-filtered, by department category)
function rDeptCollection(){
  const today=new Date().toISOString().split('T')[0];
  const yearStart=new Date().getFullYear()+'-01-01';
  const bills=DB.get('ipd_bills').filter(b=>b.cid===S.cid);
  const catMap={};
  bills.forEach(b=>{
    const c=b.category||'Others';
    if(!catMap[c])catMap[c]={count:0,total:0,paid:0,due:0};
    catMap[c].count++;catMap[c].total+=b.total;catMap[c].paid+=b.paid;catMap[c].due+=b.due;
  });
  document.getElementById('indoorBody').innerHTML=`
  <div class="bar">
    From:<input type="date" id="dc_f" value="${yearStart}" style="color:var(--text);">
    To:<input type="date" id="dc_t" value="${today}" style="color:var(--text);">
    <button class="btn btn-t btn-sm" onclick="filterDeptColl()">Filter</button>
    <button class="btn btn-o btn-sm" onclick="printDeptColl()">üñ® Print</button>
  </div>
  <div class="box">
    <div class="box-title">Department / Category Collection</div>
    ${Object.keys(catMap).length===0?'<p style="color:var(--text3);font-size:13px;">No IPD billing data yet.</p>':
    `<div class="tbl-wrap"><table>
      <thead><tr><th>Department</th><th># Bills</th><th>Total Bills (‡ß≥)</th><th>Collected (‡ß≥)</th><th>Due (‡ß≥)</th></tr></thead>
      <tbody>${Object.entries(catMap).map(([cat,v])=>`<tr>
        <td style="font-weight:600;color:var(--navy)">${escHtml(cat)}</td>
        <td style="font-family:var(--mono)">${v.count}</td>
        <td style="font-family:var(--mono)">‡ß≥${v.total.toLocaleString()}</td>
        <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
        <td><span class="badge ${v.due>0?'b-due':'b-active'}">‡ß≥${v.due.toLocaleString()}</span></td>
      </tr>`).join('')}</tbody>
    </table></div>`}
  </div>
  <div id="dc_filtered_out"></div>`;
}
function filterDeptColl(){
  const f=document.getElementById('dc_f')?.value,t=document.getElementById('dc_t')?.value;
  if(!f||!t){N('Select date range.',true);return;}
  const bills=DB.get('ipd_bills').filter(b=>b.cid===S.cid&&b.date>=f&&b.date<=t);
  const catMap={};
  bills.forEach(b=>{
    const c=b.category||'Others';
    if(!catMap[c])catMap[c]={count:0,total:0,paid:0,due:0};
    catMap[c].count++;catMap[c].total+=b.total;catMap[c].paid+=b.paid;catMap[c].due+=b.due;
  });
  const el=document.getElementById('dc_filtered_out');
  if(el) el.innerHTML=`
  <div class="box">
    <div class="box-title">Filtered: ${escHtml(f)} to ${escHtml(t)}</div>
    ${Object.keys(catMap).length===0?'<p style="color:var(--text3);font-size:13px;">No records in this range.</p>':
    `<div class="tbl-wrap"><table>
      <thead><tr><th>Department</th><th># Bills</th><th>Total Bills (‡ß≥)</th><th>Collected (‡ß≥)</th><th>Due (‡ß≥)</th></tr></thead>
      <tbody>${Object.entries(catMap).map(([cat,v])=>`<tr>
        <td style="font-weight:600;color:var(--navy)">${escHtml(cat)}</td>
        <td style="font-family:var(--mono)">${v.count}</td>
        <td style="font-family:var(--mono)">‡ß≥${v.total.toLocaleString()}</td>
        <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
        <td><span class="badge ${v.due>0?'b-due':'b-active'}">‡ß≥${v.due.toLocaleString()}</span></td>
      </tr>`).join('')}</tbody>
    </table></div>`}
  </div>`;
}
function printDeptColl(){
  const clinic=getClinic(S.cid)||{};
  const f=document.getElementById('dc_f')?.value||'‚Äî',t=document.getElementById('dc_t')?.value||'‚Äî';
  const w=window.open('','_blank','width=870,height=1100');
  if(!w){N('Pop-up blocked.',true);return;}
  w.document.write(`<!DOCTYPE html><html><head><title>Dept Collection</title>
  <style>body{font-family:Arial,sans-serif;padding:30px;color:#000;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:5px 8px;font-size:10pt;}th{background:#f0f0f0;}</style></head>
  <body onload="setTimeout(()=>{window.print();window.close();},500);">
    <div style="text-align:center;border-bottom:2px solid #000;padding-bottom:12px;margin-bottom:16px;">
      <div style="font-size:18pt;font-weight:bold;">${escHtml(clinic.header||clinic.name||'CLINIC')}</div>
      <div style="font-size:10pt;">Department Collection ‚Äî ${escHtml(f)} to ${escHtml(t)}</div>
    </div>
    ${document.getElementById('indoorBody')?.querySelector('table')?.outerHTML||'<p>No data</p>'}
  </body></html>`);
  w.document.close();
}

// Indoor Settings (Password Change Only)
function rIndoorSettings(){
  const cu=DB.findOne('users',u=>u.u===S.u)||{};
  document.getElementById('indoorBody').innerHTML=`
  <div class="box" style="max-width:520px;">
    <div class="box-title">üõèÔ∏è Indoor ‚Äî My Account</div>
    <div class="f2" style="margin-bottom:10px;">
      <div class="fi"><label>Name</label><input value="${escHtml(cu.name||'')}" readonly style="background:var(--bg2);"></div>
      <div class="fi"><label>Username</label><input value="${escHtml(cu.u||'')}" readonly style="background:var(--bg2);"></div>
    </div>
    <div class="pw-section">
      <div class="box-title">üîë Change Password</div>
      <div class="fi" style="margin-bottom:10px;"><label>Current Password *</label><input type="password" id="ind_sp_old" placeholder="Enter current password"></div>
      <div class="fi" style="margin-bottom:10px;"><label>New Password *</label><input type="password" id="ind_sp_new" placeholder="Min 6 characters"></div>
      <div class="fi" style="margin-bottom:10px;"><label>Confirm New Password *</label><input type="password" id="ind_sp_confirm" placeholder="Repeat new password"></div>
      <div id="ind_sp_err" style="min-height:14px;font-size:12px;color:var(--red);margin-bottom:8px;"></div>
      <div class="action-row"><button class="btn btn-t" onclick="doIndoorChangePw()">üîë Change Password</button></div>
    </div>
  </div>`;
}
function saveIndoorProfile(){
  const name=document.getElementById('ind_mp_name')?.value?.trim();
  if(!name){N('Name required.',true);return;}
  try{DB.update('users',u=>u.u===S.u,{name});S.name=name;sessionStorage.setItem('akbd_session',JSON.stringify(S));document.getElementById('tbUser').textContent=name;N('‚úì Profile updated.');}
  catch(e){N('Failed: '+e.message,true);}
}
async function doIndoorChangePw(){
  const old=document.getElementById('ind_sp_old')?.value;
  const nw=document.getElementById('ind_sp_new')?.value;
  const cf=document.getElementById('ind_sp_confirm')?.value;
  const err=document.getElementById('ind_sp_err');
  if(err)err.textContent='';
  if(!old||!nw||!cf){if(err)err.textContent='All fields required.';return;}
  if(nw.length<6){if(err)err.textContent='Min 6 characters.';return;}
  if(nw!==cf){if(err)err.textContent='Passwords do not match.';return;}
  const cu=DB.findOne('users',u=>u.u===S.u);
  if(!cu){if(err)err.textContent='User not found.';return;}
  const valid=await verifyPassword(old,cu.p);
  if(!valid){if(err)err.textContent='Current password incorrect.';return;}
  try{
    DB.update('users',u=>u.u===S.u,{p:await hashPassword(nw),pwChangedAt:new Date().toISOString()});
    N('‚úì Password changed.');
    ['ind_sp_old','ind_sp_new','ind_sp_confirm'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  }catch(e){if(err)err.textContent='Failed: '+e.message;}
}

function rIndoorReport(){
  const today=new Date().toISOString().split('T')[0];
  const yearStart=new Date().getFullYear()+'-01-01';
  document.getElementById('indoorBody').innerHTML=`
  <div style="display:grid;grid-template-columns:1fr 260px;gap:14px;">
    <div>
      <div class="bar">
        From:<input type="date" id="ind_rf" value="${yearStart}" style="color:var(--text);">
        To:<input type="date" id="ind_rt" value="${today}" style="color:var(--text);">
        <button class="btn btn-t btn-sm" onclick="genIndoorReport()">View</button>
        <button class="btn btn-o btn-sm" onclick="printIndoorReport()">üñ® Print</button>
      </div>
      <div id="ind_report_out"><p style="color:var(--gray);font-size:13px;padding:12px;">Select date range and click View.</p></div>
    </div>
    <div>
      <div class="box">
        <div class="box-title">Filter by Department</div>
        ${['CT Scan','ECG','Pathology','Ultrasonogram','X-ray','Others'].map(cat=>`
          <div class="side-item" onclick="filterIndoorCat('${cat}')" id="icat_${cat.replace(' ','_')}">${cat}</div>
        `).join('')}
        <div class="side-item" onclick="filterIndoorCat('')" style="margin-top:6px;border-color:rgba(0,180,216,.2);color:var(--teal);">Show All</div>
      </div>
    </div>
  </div>`;
}
function genIndoorReport(catFilter){
  const f=document.getElementById('ind_rf')?.value,t=document.getElementById('ind_rt')?.value;
  if(!f||!t){N('Select date range.',true);return;}
  const admissions=DB.get('ipd_admissions').filter(a=>a.cid===S.cid&&a.admDate>=f&&a.admDate<=t);
  const bills=DB.get('ipd_bills').filter(b=>b.cid===S.cid&&b.date>=f&&b.date<=t);
  const filtered=catFilter?bills.filter(b=>b.category===catFilter):bills;
  const totBills=filtered.reduce((s,b)=>s+b.total,0);
  const totPaid=filtered.reduce((s,b)=>s+b.paid,0);
  const totDue=filtered.reduce((s,b)=>s+b.due,0);
  // Category breakdown
  const catMap={};
  bills.forEach(b=>{
    const c=b.category||'Others';
    if(!catMap[c])catMap[c]={count:0,total:0,paid:0};
    catMap[c].count++;catMap[c].total+=b.total;catMap[c].paid+=b.paid;
  });
  const out=document.getElementById('ind_report_out');
  if(!out) return;
  out.innerHTML=`
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px;">
    <div class="stat-card"><div class="snum" style="color:var(--teal);">${admissions.length}</div><div class="slbl">Total Admissions</div></div>
    <div class="stat-card"><div class="snum" style="color:var(--green);">‡ß≥${totPaid.toLocaleString()}</div><div class="slbl">Total Collection</div></div>
    <div class="stat-card"><div class="snum" style="color:var(--red);">‡ß≥${totDue.toLocaleString()}</div><div class="slbl">Total Due</div></div>
  </div>
  ${Object.keys(catMap).length?`<div class="box"><div class="box-title">Category Breakdown</div>
    <div class="tbl-wrap"><table>
      <thead><tr><th>Category</th><th>Count</th><th>Total Bills</th><th>Collected</th></tr></thead>
      <tbody>${Object.entries(catMap).map(([cat,v])=>`<tr>
        <td style="font-weight:600">${escHtml(cat)}</td>
        <td style="font-family:var(--mono)">${v.count}</td>
        <td style="font-family:var(--mono)">‡ß≥${v.total.toLocaleString()}</td>
        <td style="font-family:var(--mono);color:var(--green)">‡ß≥${v.paid.toLocaleString()}</td>
      </tr>`).join('')}</tbody>
    </table></div></div>`:''
  }
  ${catFilter?`<div style="margin-bottom:8px;font-size:12px;color:var(--amber);">Showing: <strong>${escHtml(catFilter)}</strong> &nbsp;<button class="btn btn-o btn-sm" onclick="genIndoorReport()">Clear Filter</button></div>`:''}
  <div class="box"><div class="box-title">${catFilter?escHtml(catFilter)+' Bills':'All Bills'} (${filtered.length})</div>
    ${filtered.length===0?'<p style="color:var(--gray);font-size:13px;">No records in this range.</p>':
    `<div class="tbl-wrap"><table>
      <thead><tr><th>Date</th><th>Patient ID</th><th>Patient</th><th>Category</th><th>Total</th><th>Paid</th><th>Due</th></tr></thead>
      <tbody>${filtered.map(b=>{const adm=DB.findOne('ipd_admissions',a=>a.id===b.admId)||{};return`<tr>
        <td>${b.date}</td>
        <td style="font-family:var(--mono);color:var(--teal)">${escHtml(adm.admNo||b.admId)}</td>
        <td style="font-weight:500">${escHtml(adm.name||'‚Äî')}</td>
        <td><span class="badge b-warn">${escHtml(b.category||'Others')}</span></td>
        <td style="font-family:var(--mono)">‡ß≥${b.total.toLocaleString()}</td>
        <td style="font-family:var(--mono);color:var(--green)">‡ß≥${b.paid.toLocaleString()}</td>
        <td><span class="badge ${b.due>0?'b-due':'b-active'}">‡ß≥${b.due.toLocaleString()}</span></td>
      </tr>`;}).join('')}</tbody>
    </table></div>`}
  </div>`;
}
function filterIndoorCat(cat){
  genIndoorReport(cat);
}
function printIndoorReport(){
  const el=document.getElementById('ind_report_out');
  if(!el||!el.innerHTML.trim()){N('Generate report first.',true);return;}
  const clinic=getClinic(S.cid)||{};
  const f=document.getElementById('ind_rf')?.value||'‚Äî',t=document.getElementById('ind_rt')?.value||'‚Äî';
  const w=window.open('','_blank','width=870,height=1100');
  if(!w){N('Pop-up blocked.',true);return;}
  w.document.write(`<!DOCTYPE html><html><head><title>Indoor Report</title>
  <style>body{font-family:Arial,sans-serif;padding:30px;color:#000;}h1{font-size:18pt;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:5px 8px;font-size:10pt;}th{background:#f0f0f0;}.snum{font-size:22pt;font-weight:bold;}.stat-card{display:inline-block;border:1px solid #ccc;border-radius:6px;padding:14px;margin:6px;text-align:center;min-width:130px;}</style></head>
  <body onload="setTimeout(()=>{window.print();window.close();},500);">
    <div style="text-align:center;border-bottom:2px solid #000;padding-bottom:12px;margin-bottom:16px;">
      <div style="font-size:18pt;font-weight:bold;">${escHtml(clinic.header||clinic.name||'CLINIC')}</div>
      <div style="font-size:10pt;">Indoor Report ‚Äî ${escHtml(f)} to ${escHtml(t)}</div>
    </div>
    ${el.innerHTML}
  </body></html>`);
  w.document.close();
}

function rIndoorUserColl(){
  const today=new Date().toISOString().split('T')[0];
  const yearStart=new Date().getFullYear()+'-01-01';
  const deposits=DB.get('ipd_deposits').filter(d=>d.cid===S.cid);
  // Group by receiver
  const byUser={};
  deposits.forEach(d=>{
    const key=d.receiver||d.by;
    if(!byUser[key])byUser[key]={name:key,receipts:[],total:0,count:0};
    byUser[key].receipts.push(d);
    byUser[key].total+=d.amount;
    byUser[key].count++;
  });
  document.getElementById('indoorBody').innerHTML=`
  <div class="bar">
    From:<input type="date" id="iuc_f" value="${yearStart}" style="color:var(--text);">
    To:<input type="date" id="iuc_t" value="${today}" style="color:var(--text);">
    <button class="btn btn-t btn-sm" onclick="filterUserColl()">Filter</button>
    <button class="btn btn-o btn-sm" onclick="printUserColl()">üñ® Print</button>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Date</th><th>ASC Name (Receiver)</th><th>Note</th><th>Reference</th><th>Payment</th><th>Deposit</th><th>Description</th></tr></thead>
    <tbody id="iuc_tb">${buildUserCollRows(deposits)}</tbody>
  </table></div>
  <div class="box" style="margin-top:14px;">
    <div class="box-title">Summary by Receiver</div>
    ${Object.keys(byUser).length===0?'<p style="color:var(--gray);font-size:13px;">No deposits recorded.</p>':
    `<div class="tbl-wrap"><table>
      <thead><tr><th>Receiver Name</th><th>Total Received</th><th># Receipts</th><th></th></tr></thead>
      <tbody>${Object.values(byUser).map(u=>`<tr>
        <td style="font-weight:600;cursor:pointer;color:var(--teal)" onclick="showIPDUserCollDetail('${escHtml(u.name)}')">${escHtml(u.name)}</td>
        <td style="font-family:var(--mono);color:var(--green)">‡ß≥${u.total.toLocaleString()}</td>
        <td style="font-family:var(--mono)">${u.count}</td>
        <td><button class="btn btn-o btn-sm" onclick="showIPDUserCollDetail('${escHtml(u.name)}')">üëÅ Detail</button></td>
      </tr>`).join('')}</tbody>
    </table></div>`}
  </div>`;
}
function buildUserCollRows(deps){
  return deps.map(d=>{const adm=DB.findOne('ipd_admissions',a=>a.id===d.admId)||{};return`<tr>
    <td>${d.date}</td>
    <td style="font-weight:500;color:var(--teal)">${escHtml(d.receiver||d.by||'‚Äî')}</td>
    <td style="font-size:11px;">${escHtml(d.note||'‚Äî')}</td>
    <td style="font-size:11px;">${escHtml(adm.admNo||d.admId||'‚Äî')}</td>
    <td style="font-family:var(--mono)">${escHtml(d.method||'Cash')}</td>
    <td style="font-family:var(--mono);color:var(--green)">‡ß≥${d.amount.toLocaleString()}</td>
    <td style="font-size:11px;color:var(--text2)">${escHtml(d.description||'‚Äî')}</td>
  </tr>`;}).join('')||`<tr><td colspan="7" style="color:var(--gray);text-align:center;padding:16px;">No deposits found.</td></tr>`;
}
function filterUserColl(){
  const f=document.getElementById('iuc_f')?.value,t=document.getElementById('iuc_t')?.value;
  const deps=DB.get('ipd_deposits').filter(d=>d.cid===S.cid&&d.date>=f&&d.date<=t);
  const tb=document.getElementById('iuc_tb');
  if(tb) tb.innerHTML=buildUserCollRows(deps);
}
function showIPDUserCollDetail(name){
  const total=deps.reduce((s,d)=>s+d.amount,0);
  N(`${name}: ${deps.length} receipts, Total: ‡ß≥${total.toLocaleString()}`);
}
function printUserColl(){
  const el=document.getElementById('indoorBody');
  if(!el) return;
  const clinic=getClinic(S.cid)||{};
  const w=window.open('','_blank','width=870,height=1100');
  if(!w){N('Pop-up blocked.',true);return;}
  const f=document.getElementById('iuc_f')?.value||'‚Äî',t=document.getElementById('iuc_t')?.value||'‚Äî';
  w.document.write(`<!DOCTYPE html><html><head><title>User Collection</title>
  <style>body{font-family:Arial,sans-serif;padding:30px;color:#000;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:5px 8px;font-size:10pt;}th{background:#f0f0f0;}</style></head>
  <body onload="setTimeout(()=>{window.print();window.close();},500);">
    <div style="text-align:center;border-bottom:2px solid #000;padding-bottom:12px;margin-bottom:16px;">
      <div style="font-size:18pt;font-weight:bold;">${escHtml(clinic.header||clinic.name||'CLINIC')}</div>
      <div style="font-size:10pt;">User Collection ‚Äî ${escHtml(f)} to ${escHtml(t)}</div>
    </div>
    <table><thead><tr><th>Date</th><th>Receiver</th><th>Note</th><th>Reference</th><th>Payment</th><th>Deposit</th><th>Description</th></tr></thead>
    <tbody>${document.getElementById('iuc_tb')?.innerHTML||''}</tbody></table>
  </body></html>`);
  w.document.close();
}

function rIPDPatients(){
  const admissions=DB.get('ipd_admissions').filter(a=>a.cid===S.cid);
  document.getElementById('indoorBody').innerHTML=`
  <div class="bar">
    <input id="ipd_psq" placeholder="Search patient name or admission no..." oninput="fIPDPats()" style="flex:1;">
    <button class="btn btn-t btn-sm" onclick="openModal('m-ipd-admit')">+ Admit Patient</button>
    <span style="font-size:11px;color:var(--text2)">${admissions.length} admission(s)</span>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Admission No</th><th>Date</th><th>Patient</th><th>Age</th><th>Ward</th><th>Doctor</th><th>Diagnosis</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody id="ipd_pat_tb">${buildIPDPatRows(admissions)}</tbody>
  </table></div>`;
}
function buildIPDPatRows(data){
  const canDischarge=['admin','superadmin'].includes(S?.role);
  return data.map(a=>`<tr>
    <td style="font-family:var(--mono);color:var(--teal)">${escHtml(a.admNo)}</td>
    <td>${a.admDate}</td>
    <td style="font-weight:600">${escHtml(a.name)}</td>
    <td>${escHtml(a.age||'‚Äî')}</td>
    <td>${escHtml(a.ward||'‚Äî')}</td>
    <td style="font-size:11px;">${escHtml(a.doctor||'‚Äî')}</td>
    <td style="font-size:11px;color:var(--text2)">${escHtml(a.diagnosis||'‚Äî')}</td>
    <td><span class="badge ${a.status==='discharged'?'b-due':'b-active'}">${(a.status||'admitted').toUpperCase()}</span></td>
    <td style="white-space:nowrap">
      ${a.status==='discharged'?`<span class="badge b-warn">DISCHARGED ${a.dischargeDate||''}</span>`:`<span class="badge b-active">ADMITTED</span>`}
      ${(a.status!=='discharged'&&canDischarge)?`<button class="btn btn-t btn-sm" onclick="goToDischarge('${a.id}')">üì§ Discharge</button>`:''}
    </td>
  </tr>`).join('')||`<tr><td colspan="9" style="color:var(--gray);text-align:center;padding:20px;">No IPD admissions.</td></tr>`;
}
function goToDischarge(admId){
  if(!['admin','superadmin'].includes(S?.role)){N('Discharge is admin-only.',true);return;}
  // Switch to Discharge tab
  const idx=INDOOR_TABS.indexOf('Discharge');
  if(idx>=0){
    document.querySelectorAll('#indoorNav .ws-tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('#indoorNav .ws-tab')[idx]?.classList.add('active');
    rIPDDischarge();
    // Pre-select the patient
    setTimeout(()=>{
      const sel=document.getElementById('dc_patient');
      if(sel){sel.value=admId;loadDischargePatient();}
    },100);
  }
}
function fIPDPats(){
  const q=(document.getElementById('ipd_psq')?.value||'').toLowerCase();
  const tb=document.getElementById('ipd_pat_tb');
  if(tb) tb.innerHTML=buildIPDPatRows(DB.get('ipd_admissions').filter(a=>a.cid===S.cid&&(a.name.toLowerCase().includes(q)||a.admNo.toLowerCase().includes(q))));
}
function dischargeIPD(id){
  if(!confirm('Discharge this patient?')) return;
  try{DB.update('ipd_admissions',a=>a.id===id,{status:'discharged',dischargedAt:new Date().toISOString()});N('Patient discharged.');rIPDPatients();}
  catch(e){N('Failed: '+e.message,true);}
}

function updateIPDAgeVal(){
  const y=document.getElementById('ia_age_y')?.value||'';
  const m=document.getElementById('ia_age_m')?.value||'';
  let age='';
  if(y) age+=y+'Y';
  if(m) age+=(age?' ':'')+m+'M';
  const el=document.getElementById('ia_age');
  if(el) el.value=age;
}
function nextIPDNo(cid){
  const yr=new Date().getFullYear();
  const existing=DB.get('ipd_admissions').filter(a=>a.cid===cid&&(a.admNo||'').startsWith('IPD-'+yr+'-'));
  return`IPD-${yr}-${String(existing.length+1).padStart(4,'0')}`;
}
function rIPDAdmission(){
  const today=new Date().toISOString().split('T')[0];
  const el=document.getElementById('ia_date');
  if(el) el.value=today;
  // Clear form fields
  ['ia_name','ia_phone','ia_ward','ia_doctor','ia_diag','ia_refdoc','ia_addr','ia_notes'].forEach(id=>{
    const e=document.getElementById(id);if(e)e.value='';
  });
  const ageY=document.getElementById('ia_age_y');if(ageY)ageY.value='';
  const ageM=document.getElementById('ia_age_m');if(ageM)ageM.value='';
  openModal('m-ipd-admit');
}
function saveIPDAdmit(){
  const name=document.getElementById('ia_name')?.value?.trim();
  const phone=document.getElementById('ia_phone')?.value?.trim();
  if(!name||!phone){N('Patient name and phone are required.',true);return;}
  try{
    const admNo=nextIPDNo(S.cid);
    const record={
      id:uid(), admNo, cid:S.cid,
      name, phone,
      age:document.getElementById('ia_age')?.value||'‚Äî',
      gender:document.getElementById('ia_gender')?.value||'',
      blood:document.getElementById('ia_blood')?.value||'‚Äî',
      admDate:document.getElementById('ia_date')?.value||new Date().toISOString().split('T')[0],
      ward:document.getElementById('ia_ward')?.value||'',
      doctor:document.getElementById('ia_doctor')?.value||'',
      diagnosis:document.getElementById('ia_diag')?.value||'',
      refDoctor:document.getElementById('ia_refdoc')?.value||'',
      address:document.getElementById('ia_addr')?.value||'',
      notes:document.getElementById('ia_notes')?.value||'',
      status:'admitted', admittedBy:S.u,
      createdAt:new Date().toISOString()
    };
    DB.insert('ipd_admissions',record);
    N(`‚úì Patient admitted: ${admNo}`);
    closeModal('m-ipd-admit');
    // Clear form fields
    ['ia_name','ia_phone','ia_ward','ia_doctor','ia_diag','ia_refdoc','ia_addr','ia_notes'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
    // Refresh patient list immediately
    const admissions=DB.get('ipd_admissions').filter(a=>a.cid===S.cid);
    const tb=document.getElementById('ipd_pat_tb');
    const countEl=document.querySelector('#indoorBody .bar span');
    if(tb) tb.innerHTML=buildIPDPatRows(admissions);
    if(countEl) countEl.textContent=admissions.length+' admission(s)';
    // Always refresh patient list
    rIPDPatients();
  }catch(e){N('Failed: '+e.message,true);}
}

function rIPDDeposit(){
  const today=new Date().toISOString().split('T')[0];
  document.getElementById('ipd_dep_date').value=today;
  document.getElementById('ipd_dep_pid').value='';
  document.getElementById('ipd_dep_info').innerHTML='Enter Admission No to load patient info.';
  openModal('m-ipd-deposit');
}
function loadIPDPatient(){
  const pid=(document.getElementById('ipd_dep_pid')?.value||'').trim();
  const el=document.getElementById('ipd_dep_info');
  if(!pid){if(el)el.innerHTML='Enter Admission No to load patient info.';return;}
  const adm=DB.findOne('ipd_admissions',a=>a.admNo===pid&&a.cid===S.cid);
  if(!adm){if(el)el.innerHTML='<span style="color:red;">Patient not found.</span>';return;}
  if(el) el.innerHTML=`<strong>${escHtml(adm.name)}</strong> | ${escHtml(adm.phone)} | Ward: ${escHtml(adm.ward||'‚Äî')} | Admitted: ${adm.admDate}`;
}
function saveIPDDeposit(){
  const pid=(document.getElementById('ipd_dep_pid')?.value||'').trim();
  const amt=parseFloat(document.getElementById('ipd_dep_amt')?.value||0);
  if(!pid){N('Enter Admission No.',true);return;}
  if(amt<=0){N('Enter valid amount.',true);return;}
  const adm=DB.findOne('ipd_admissions',a=>a.admNo===pid&&a.cid===S.cid);
  if(!adm){N('Patient not found.',true);return;}
  try{
    DB.insert('ipd_deposits',{
      id:uid(), cid:S.cid, admId:adm.id,
      amount:amt,
      date:document.getElementById('ipd_dep_date')?.value||new Date().toISOString().split('T')[0],
      method:document.getElementById('ipd_dep_method')?.value||'Cash',
      note:document.getElementById('ipd_dep_note')?.value||'',
      description:`Deposit for ${adm.name}`,
      receiver:S.name, by:S.u,
      createdAt:new Date().toISOString()
    });
    N(`‚úì Deposit of ‡ß≥${amt.toLocaleString()} saved for ${adm.name}.`);
    closeModal('m-ipd-deposit');
  }catch(e){N('Failed: '+e.message,true);}
}

function rIPDBilling(){
  document.getElementById('indoorBody').innerHTML=`
  <div class="box" style="max-width:760px;">
    <div class="box-title">IPD Billing System</div>
    <div class="fi" style="margin-bottom:12px;"><label>Patient Admission No *</label>
      <input id="ipdb_pid" placeholder="e.g. IPD-2026-0001" oninput="loadIPDBill()">
    </div>
    <div id="ipdb_info" style="padding:10px;background:rgba(0,180,216,.06);border-radius:6px;font-size:12px;color:var(--text2);margin-bottom:14px;">Enter admission number to load patient.</div>
    <div class="box-title">Charges</div>
    <div class="f2" style="margin-bottom:10px;">
      <div class="fi"><label>Admission Charge (‡ß≥)</label><input type="number" id="ipdb_admit" min="0" placeholder="0" oninput="calcIPDBill()"></div>
      <div class="fi"><label>Bed / Room Charge (‡ß≥)</label><input type="number" id="ipdb_bed" min="0" placeholder="0" oninput="calcIPDBill()"></div>
    </div>
    <div class="f2" style="margin-bottom:10px;">
      <div class="fi"><label>Surgeon Bill (‡ß≥)</label><input type="number" id="ipdb_surg" min="0" placeholder="0" oninput="calcIPDBill()"></div>
      <div class="fi"><label>Anesthesia Charge (‡ß≥)</label><input type="number" id="ipdb_anes" min="0" placeholder="0" oninput="calcIPDBill()"></div>
    </div>
    <div class="f2" style="margin-bottom:10px;">
      <div class="fi"><label>Medicine Charge (‡ß≥)</label><input type="number" id="ipdb_med" min="0" placeholder="0" oninput="calcIPDBill()"></div>
      <div class="fi"><label>Service Charge (‡ß≥) <small style="color:var(--gray)">Nebulization etc.</small></label><input type="number" id="ipdb_svc" min="0" placeholder="0" oninput="calcIPDBill()"></div>
    </div>
    <div class="f2" style="margin-bottom:10px;">
      <div class="fi"><label>Nursing Charge (‡ß≥)</label><input type="number" id="ipdb_nurse" min="0" placeholder="0" oninput="calcIPDBill()"></div>
      <div class="fi"><label>Other Charges (‡ß≥)</label><input type="number" id="ipdb_other" min="0" placeholder="0" oninput="calcIPDBill()"></div>
    </div>
    <div class="fi" style="margin-bottom:10px;"><label>Category</label>
      <select id="ipdb_cat"><option>General</option><option>CT Scan</option><option>ECG</option><option>Pathology</option><option>Ultrasonogram</option><option>X-ray</option><option>Surgery</option><option>Others</option></select>
    </div>
    <div class="box" style="background:rgba(0,180,216,.04);border-color:rgba(0,180,216,.2);margin-bottom:14px;">
      <div class="box-title">Auto Total</div>
      <div class="tot-row"><span>Total Charges</span><span id="ipdb_total" style="font-family:var(--mono);color:var(--teal);">‡ß≥ 0</span></div>
      <div class="tot-row"><span>Discount (‡ß≥)</span><input class="tinput" id="ipdb_disc" type="number" min="0" value="0" oninput="calcIPDBill()"></div>
      <div class="tot-row tot-grand"><span>Net Payable</span><span id="ipdb_net" style="font-family:var(--mono);">‡ß≥ 0</span></div>
      <div class="tot-row"><span>Paid (‡ß≥)</span><input class="tinput" id="ipdb_paid" type="number" min="0" value="0" oninput="calcIPDBill()"></div>
      <div class="tot-row tot-due"><span>Due</span><span id="ipdb_due" style="font-family:var(--mono);">‡ß≥ 0</span></div>
    </div>
    <div class="action-row">
      <button class="btn btn-t" onclick="saveIPDBill()">üíæ Save &amp; Print Bill</button>
      <button class="btn btn-r" onclick="rIPDBilling()">‚úï Clear</button>
    </div>
  </div>`;
}
function loadIPDBill(){
  const pid=(document.getElementById('ipdb_pid')?.value||'').trim();
  const el=document.getElementById('ipdb_info');
  if(!pid){if(el)el.innerHTML='Enter admission number to load patient.';return;}
  const adm=DB.findOne('ipd_admissions',a=>a.admNo===pid&&a.cid===S.cid);
  if(adm&&el) el.innerHTML=`<strong>${escHtml(adm.name)}</strong> | ${escHtml(adm.phone)} | Ward: ${escHtml(adm.ward||'‚Äî')} | Doctor: ${escHtml(adm.doctor||'‚Äî')} | Admitted: ${adm.admDate}`;
  else if(el) el.innerHTML='<span style="color:var(--red);">Patient not found.</span>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IPD DISCHARGE (ADMIN ONLY) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rIPDDischarge(){
  if(!['admin','superadmin'].includes(S?.role)){
    document.getElementById('indoorBody').innerHTML='<div class="box"><p style="color:var(--amber);font-size:13px;">‚ö† Discharge is restricted to Clinic Admin only.</p></div>';
    return;
  }
  // Load advice templates
  const adviceTemplates=DB.get('discharge_advice').filter(a=>a.cid===S.cid);
  const adms=DB.get('ipd_admissions').filter(a=>a.cid===S.cid&&a.status==='admitted');
  document.getElementById('indoorBody').innerHTML=`
  <div style="display:grid;grid-template-columns:1fr 320px;gap:14px;">
    <div>
      <div class="box">
        <div class="box-title">üè• Patient Discharge ‚Äî Admin Only</div>
        <div class="fi" style="margin-bottom:12px;"><label>Select Patient (Admission No) *</label>
          <select id="dc_patient" onchange="loadDischargePatient()">
            <option value="">‚Äî Select admitted patient ‚Äî</option>
            ${adms.map(a=>`<option value="${a.id}">${escHtml(a.admNo)} ‚Äî ${escHtml(a.name)}</option>`).join('')}
          </select>
        </div>
        <div id="dc_pat_info" style="padding:10px;background:rgba(0,180,216,.06);border-radius:7px;font-size:12px;color:var(--text2);margin-bottom:14px;">Select a patient to load their admission details.</div>
      </div>
      <div class="box">
        <div class="box-title">üìù Discharge Advice</div>
        <div class="fi" style="margin-bottom:10px;">
          <label>Select Template</label>
          <select id="dc_adv_tpl" onchange="applyAdviceTemplate()">
            <option value="">‚Äî Choose template or type below ‚Äî</option>
            ${adviceTemplates.map(a=>`<option value="${escHtml(a.text)}">${escHtml(a.name)}</option>`).join('')}
          </select>
        </div>
        <div class="fi" style="margin-bottom:10px;"><label>Advice Instructions</label>
          <textarea id="dc_advice" rows="5" style="width:100%;padding:10px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--font);font-size:13px;outline:none;resize:vertical;line-height:1.6;" placeholder="Enter patient advice, activity instructions, follow-up schedule..."></textarea>
        </div>
      </div>
      <div class="box">
        <div class="box-title">üíä Discharge Medicines</div>
        <div id="dc_med_list" style="margin-bottom:12px;"></div>
        <button class="btn btn-o btn-sm" onclick="addDischargeMed()">+ Add Medicine</button>
      </div>
      <div class="box">
        <div class="box-title">üìÑ Discharge Note</div>
        <div class="fi"><textarea id="dc_note" rows="5" style="width:100%;padding:10px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--font);font-size:13px;outline:none;resize:vertical;line-height:1.6;" placeholder="Free text discharge note ‚Äî clinical summary, follow-up instructions, special notes..."></textarea></div>
        <div class="action-row" style="margin-top:14px;">
          <button class="btn btn-t" onclick="saveDischarge()">üìã Save &amp; Print Discharge</button>
          <button class="btn btn-r" onclick="rIPDDischarge()">‚úï Clear</button>
        </div>
      </div>
    </div>
    <div>
      <div class="box">
        <div class="box-title">‚öô Advice Templates</div>
        <div id="dc_tpl_list">${renderAdviceTplList()}</div>
        <div class="fi" style="margin-top:10px;"><label>Template Name</label><input id="dc_tpl_name" placeholder="e.g. Post-Surgery Care"></div>
        <div class="fi" style="margin-top:8px;"><label>Template Text</label>
          <textarea id="dc_tpl_text" rows="3" style="width:100%;padding:8px;background:#fff;border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--font);font-size:12px;outline:none;resize:vertical;" placeholder="Advice content..."></textarea>
        </div>
        <button class="btn btn-g btn-sm" style="margin-top:8px;width:100%;" onclick="saveAdviceTemplate()">üíæ Save Template</button>
      </div>
    </div>
  </div>`;
  window._dischargeMeds=[];
}
function renderAdviceTplList(){
  const templates=DB.get('discharge_advice').filter(a=>a.cid===S.cid);
  if(!templates.length) return '<p style="font-size:12px;color:var(--text2);">No templates yet.</p>';
  return templates.map(t=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border2);font-size:12px;">
    <span style="flex:1;font-weight:500;">${escHtml(t.name)}</span>
    <button class="btn btn-r btn-sm" style="padding:2px 7px;font-size:10px;" onclick="deleteAdviceTemplate('${t.id}')">üóë</button>
  </div>`).join('');
}
function saveAdviceTemplate(){
  const name=(document.getElementById('dc_tpl_name')?.value||'').trim();
  const text=(document.getElementById('dc_tpl_text')?.value||'').trim();
  if(!name||!text){N('Name and text required.',true);return;}
  try{
    DB.insert('discharge_advice',{id:uid(),cid:S.cid,name,text,createdAt:new Date().toISOString()});
    N('‚úì Template saved.');
    rIPDDischarge();
  }catch(e){N('Failed: '+e.message,true);}
}
function deleteAdviceTemplate(id){
  if(!confirm('Delete this template?')) return;
  try{DB.delete('discharge_advice',a=>a.id===id);N('Template deleted.');rIPDDischarge();}
  catch(e){N('Failed: '+e.message,true);}
}
function applyAdviceTemplate(){
  const sel=document.getElementById('dc_adv_tpl');
  const el=document.getElementById('dc_advice');
  if(sel&&el&&sel.value) el.value=sel.value;
}
function loadDischargePatient(){
  const admId=document.getElementById('dc_patient')?.value;
  const el=document.getElementById('dc_pat_info');
  if(!admId){if(el)el.innerHTML='Select a patient to load their admission details.';return;}
  const adm=DB.findOne('ipd_admissions',a=>a.id===admId);
  if(!adm||!el) return;
  el.innerHTML=`<strong>${escHtml(adm.name)}</strong> | ${escHtml(adm.phone)} | Age: ${escHtml(adm.age||'‚Äî')} | Ward: ${escHtml(adm.ward||'‚Äî')}<br>
    Doctor: ${escHtml(adm.doctor||'‚Äî')} | Admitted: ${adm.admDate} | Diagnosis: ${escHtml(adm.diagnosis||'‚Äî')}`;
}
function addDischargeMed(){
  if(!window._dischargeMeds) window._dischargeMeds=[];
  const idx=window._dischargeMeds.length;
  window._dischargeMeds.push({name:'',dosage:'',duration:'',instructions:''});
  renderMedList();
}
function renderMedList(){
  const list=window._dischargeMeds||[];
  const el=document.getElementById('dc_med_list'); if(!el) return;
  if(!list.length){el.innerHTML='<p style="font-size:12px;color:var(--text2);">No medicines added.</p>';return;}
  el.innerHTML=list.map((m,i)=>`<div style="background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:10px;margin-bottom:8px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <span style="font-size:11px;font-weight:700;color:var(--teal2);">Medicine #${i+1}</span>
      <button class="btn btn-r btn-sm" style="padding:2px 7px;font-size:10px;" onclick="removeDischargeMed(${i})">‚úï</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:6px;">
      <div class="fi"><label>Medicine Name *</label><input value="${escHtml(m.name)}" placeholder="e.g. Paracetamol 500mg" oninput="window._dischargeMeds[${i}].name=this.value"></div>
      <div class="fi"><label>Dosage</label><input value="${escHtml(m.dosage)}" placeholder="e.g. 1 tablet" oninput="window._dischargeMeds[${i}].dosage=this.value"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <div class="fi"><label>Duration</label><input value="${escHtml(m.duration)}" placeholder="e.g. 5 days" oninput="window._dischargeMeds[${i}].duration=this.value"></div>
      <div class="fi"><label>Instructions</label><input value="${escHtml(m.instructions)}" placeholder="e.g. After meals" oninput="window._dischargeMeds[${i}].instructions=this.value"></div>
    </div>
  </div>`).join('');
}
function removeDischargeMed(idx){
  window._dischargeMeds.splice(idx,1);
  renderMedList();
}
function saveDischarge(){
  const admId=document.getElementById('dc_patient')?.value;
  if(!admId){N('Select a patient.',true);return;}
  const adm=DB.findOne('ipd_admissions',a=>a.id===admId);
  if(!adm){N('Patient not found.',true);return;}
  const advice=(document.getElementById('dc_advice')?.value||'').trim();
  const note=(document.getElementById('dc_note')?.value||'').trim();
  const meds=(window._dischargeMeds||[]).filter(m=>m.name.trim());
  const dischargeDate=new Date().toISOString().split('T')[0];
  try{
    // Mark patient as discharged
    DB.update('ipd_admissions',a=>a.id===admId,{
      status:'discharged',
      dischargeDate,
      dischargeAdvice:advice,
      dischargeMeds:meds,
      dischargeNote:note,
      dischargedBy:S.u,
      dischargedAt:new Date().toISOString()
    });
    N(`‚úì ${adm.name} discharged successfully.`);
    printDischargeSheet(adm,advice,meds,note,dischargeDate);
    rIPDDischarge();
  }catch(e){N('Failed: '+e.message,true);}
}
function printDischargeSheet(adm,advice,meds,note,dischargeDate){
  const clinic=getClinic(S.cid)||{};
  const now=new Date();
  const ts=`${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()} ${now.toLocaleTimeString('en-GB')}`;
  const medsHTML=meds.length?`
    <table style="width:100%;border-collapse:collapse;font-size:9.5pt;margin-bottom:8px;">
      <thead><tr style="background:#f0f0f0;"><th style="padding:4px 8px;border:1px solid #ccc;text-align:left;">#</th><th style="padding:4px 8px;border:1px solid #ccc;">Medicine</th><th style="padding:4px 8px;border:1px solid #ccc;">Dosage</th><th style="padding:4px 8px;border:1px solid #ccc;">Duration</th><th style="padding:4px 8px;border:1px solid #ccc;">Instructions</th></tr></thead>
      <tbody>${meds.map((m,i)=>`<tr><td style="padding:3px 8px;border:1px solid #ddd;">${i+1}</td><td style="padding:3px 8px;border:1px solid #ddd;font-weight:600;">${escHtml(m.name)}</td><td style="padding:3px 8px;border:1px solid #ddd;">${escHtml(m.dosage||'‚Äî')}</td><td style="padding:3px 8px;border:1px solid #ddd;">${escHtml(m.duration||'‚Äî')}</td><td style="padding:3px 8px;border:1px solid #ddd;">${escHtml(m.instructions||'‚Äî')}</td></tr>`).join('')}</tbody>
    </table>`:'<p style="font-size:9.5pt;color:#666;">No medications prescribed.</p>';
  const html=`<div style="width:100%;font-family:'Times New Roman',Times,serif;font-size:11pt;color:#000;line-height:1.6;">
  <div style="text-align:center;border-bottom:2px double #000;padding-bottom:10px;margin-bottom:10px;">
    <div style="font-size:16pt;font-weight:bold;">${escHtml(clinic.header||clinic.name||'CLINIC')}</div>
    <div style="font-size:9pt;">${escHtml(clinic.address||'')} | Phone: ${escHtml(clinic.phone||'')}</div>
  </div>
  <div style="text-align:center;font-weight:bold;font-size:13pt;border-bottom:1px dashed #000;margin-bottom:10px;padding-bottom:6px;">DISCHARGE CERTIFICATE</div>
  <div style="border:1px solid #000;padding:8px;margin-bottom:10px;font-size:9.5pt;">
    <div><strong>Patient:</strong> ${escHtml(adm.name)} &nbsp;|&nbsp; <strong>Adm No:</strong> ${escHtml(adm.admNo)}</div>
    <div><strong>Age:</strong> ${escHtml(adm.age||'‚Äî')} &nbsp;|&nbsp; <strong>Gender:</strong> ${escHtml(adm.gender||'‚Äî')} &nbsp;|&nbsp; <strong>Ward:</strong> ${escHtml(adm.ward||'‚Äî')}</div>
    <div><strong>Admitted:</strong> ${adm.admDate} &nbsp;|&nbsp; <strong>Discharged:</strong> ${dischargeDate}</div>
    <div><strong>Doctor:</strong> ${escHtml(adm.doctor||'‚Äî')} &nbsp;|&nbsp; <strong>Diagnosis:</strong> ${escHtml(adm.diagnosis||'‚Äî')}</div>
  </div>
  ${advice?`<div style="margin-bottom:10px;">
    <div style="font-weight:bold;font-size:10.5pt;margin-bottom:4px;">üìù Advice / Instructions:</div>
    <div style="padding:8px;border:1px solid #ddd;border-radius:4px;font-size:9.5pt;line-height:1.8;white-space:pre-wrap;">${escHtml(advice)}</div>
  </div>`:''}
  ${meds.length?`<div style="margin-bottom:10px;">
    <div style="font-weight:bold;font-size:10.5pt;margin-bottom:6px;">üíä Prescribed Medicines:</div>
    ${medsHTML}
  </div>`:''}
  ${note?`<div style="margin-bottom:10px;">
    <div style="font-weight:bold;font-size:10.5pt;margin-bottom:4px;">üìÑ Discharge Note:</div>
    <div style="padding:8px;border:1px solid #ddd;border-radius:4px;font-size:9.5pt;line-height:1.8;white-space:pre-wrap;">${escHtml(note)}</div>
  </div>`:''}
  <div style="margin-top:30px;border-top:1px dashed #000;padding-top:10px;display:flex;justify-content:space-between;font-size:9pt;">
    <div>
      <div style="margin-bottom:40px;">Authorized By: ${escHtml(S.name||'‚Äî')}</div>
      <div>_________________________</div>
      <div style="font-size:8pt;color:#555;">Doctor Signature &amp; Seal</div>
    </div>
    <div style="text-align:right;">
      <div>Printed: ${ts}</div>
      <div style="font-size:8pt;color:#555;margin-top:30px;">_________________________</div>
      <div style="font-size:8pt;color:#555;">Patient / Guardian Signature</div>
    </div>
  </div>
  <div style="margin-top:12px;text-align:center;font-size:7pt;color:#888;">
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Software: Asad Kit BD v17 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  </div>
</div>`;
  const el=document.getElementById('m-print-body');
  if(el) el.innerHTML=html;
  openModal('m-print');
}

function calcIPDBill(){
  const vals=['ipdb_admit','ipdb_bed','ipdb_surg','ipdb_anes','ipdb_med','ipdb_svc','ipdb_nurse','ipdb_other'].map(id=>parseFloat(document.getElementById(id)?.value||0));
  const total=vals.reduce((s,v)=>s+v,0);
  const disc=Math.min(parseFloat(document.getElementById('ipdb_disc')?.value||0),total);
  const net=total-disc;
  const paid=parseFloat(document.getElementById('ipdb_paid')?.value||0);
  const due=Math.max(net-paid,0);
  document.getElementById('ipdb_total').textContent=`‡ß≥ ${total.toLocaleString()}`;
  document.getElementById('ipdb_net').textContent=`‡ß≥ ${net.toLocaleString()}`;
  document.getElementById('ipdb_due').textContent=`‡ß≥ ${due.toLocaleString()}`;
}
function saveIPDBill(){
  const pid=(document.getElementById('ipdb_pid')?.value||'').trim();
  if(!pid){N('Enter Admission No.',true);return;}
  const adm=DB.findOne('ipd_admissions',a=>a.admNo===pid&&a.cid===S.cid);
  if(!adm){N('Patient not found.',true);return;}
  const fields={admit:'ipdb_admit',bed:'ipdb_bed',surg:'ipdb_surg',anes:'ipdb_anes',med:'ipdb_med',svc:'ipdb_svc',nurse:'ipdb_nurse',other:'ipdb_other'};
  const charges={};
  let total=0;
  Object.entries(fields).forEach(([k,id])=>{const v=parseFloat(document.getElementById(id)?.value||0);charges[k]=v;total+=v;});
  const disc=Math.min(parseFloat(document.getElementById('ipdb_disc')?.value||0),total);
  const net=total-disc;
  const paid=parseFloat(document.getElementById('ipdb_paid')?.value||0);
  const due=Math.max(net-paid,0);
  const cat=document.getElementById('ipdb_cat')?.value||'General';
  const billDate=new Date().toISOString().split('T')[0];
  try{
    const billId=uid();
    const invoiceNo=adm.admNo||billId;
    DB.insert('ipd_bills',{
      id:billId, cid:S.cid, admId:adm.id,
      date:billDate,
      category:cat, charges, total, discount:disc, paid, due,
      status:due>0?'due':'paid', by:S.u, byName:S.name||S.u,
      createdAt:new Date().toISOString()
    });
    // ‚îÄ‚îÄ Track in user_collections ‚îÄ‚îÄ
    DB.insert('user_collections',{
      id:uid(), cid:S.cid,
      invoiceNo, invoiceId:billId,
      invoiceType:'IPD',
      module:'Indoor/IPD',
      patient:adm.name,
      amount:paid,
      receivedBy:S.u,
      receivedByName:S.name||S.u,
      receiveDate:billDate,
      location:getClinic(S.cid)?.name||'',
      note: `IPD Bill ‚Äî ${cat}${due>0?' (Due)':' (Paid)'}`,
      createdAt:new Date().toISOString()
    });
    N(`‚úì Bill saved for ${adm.name}: ‡ß≥${net.toLocaleString()}`);
    printIPDBill(adm,charges,total,disc,net,paid,due,cat);
    rIPDBilling();
  }catch(e){N('Failed: '+e.message,true);}
}
function printIPDBill(adm,charges,total,disc,net,paid,due,cat){
  const clinic=getClinic(S.cid)||{};
  const now=new Date();
  const ts=`${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()} ${now.toLocaleTimeString('en-GB')}`;
  const chargeLabels={admit:'Admission Charge',bed:'Bed/Room Charge',surg:'Surgeon Bill',anes:'Anesthesia',med:'Medicine',svc:'Service Charge',nurse:'Nursing Charge',other:'Other Charges'};
  const html=`<div style="width:100%;font-family:'Times New Roman',Times,serif;font-size:11pt;color:#000;line-height:1.6;">
  <div style="text-align:center;border-bottom:2px double #000;padding-bottom:10px;margin-bottom:10px;">
    <div style="font-size:16pt;font-weight:bold;">${escHtml(clinic.header||clinic.name||'CLINIC')}</div>
    <div style="font-size:9pt;">${escHtml(clinic.address||'')} | Phone: ${escHtml(clinic.phone||'')}</div>
  </div>
  <div style="text-align:center;font-weight:bold;font-size:12pt;border-bottom:1px dashed #000;margin-bottom:8px;padding-bottom:6px;">IPD BILLING STATEMENT</div>
  <div style="border:1px solid #000;padding:8px;margin-bottom:8px;font-size:9.5pt;">
    <div><strong>Patient:</strong> ${escHtml(adm.name)} | <strong>Adm No:</strong> ${escHtml(adm.admNo)}</div>
    <div><strong>Phone:</strong> ${escHtml(adm.phone)} | <strong>Ward:</strong> ${escHtml(adm.ward||'‚Äî')} | <strong>Doctor:</strong> ${escHtml(adm.doctor||'‚Äî')}</div>
    <div><strong>Admitted:</strong> ${adm.admDate} | <strong>Category:</strong> ${escHtml(cat)}</div>
  </div>
  <table style="width:100%;border-collapse:collapse;font-size:9.5pt;margin-bottom:6px;">
    <thead><tr style="background:#f0f0f0;"><th style="padding:4px 8px;border:1px solid #ccc;text-align:left;">Charge Item</th><th style="padding:4px 8px;border:1px solid #ccc;text-align:right;width:110px;">Amount (‡ß≥)</th></tr></thead>
    <tbody>${Object.entries(charges).filter(([,v])=>v>0).map(([k,v])=>`<tr><td style="padding:3px 8px;border:1px solid #ddd;">${chargeLabels[k]||k}</td><td style="padding:3px 8px;border:1px solid #ddd;text-align:right;">${v.toFixed(2)}</td></tr>`).join('')}</tbody>
  </table>
  <table style="width:100%;border-collapse:collapse;font-size:9.5pt;margin-bottom:8px;">
    <tr><td style="width:55%"></td><td style="padding:2px 8px;text-align:right;border-top:1px solid #ccc;">Total Charges (Tk.):</td><td style="padding:2px 8px;text-align:right;border-top:1px solid #ccc;width:100px;">${total.toFixed(2)}</td></tr>
    <tr><td></td><td style="padding:2px 8px;text-align:right;">Discount (Tk.):</td><td style="padding:2px 8px;text-align:right;">${disc.toFixed(2)}</td></tr>
    <tr><td></td><td style="padding:2px 8px;text-align:right;border-top:1px solid #ccc;font-weight:bold;">Net Payable (Tk.):</td><td style="padding:2px 8px;text-align:right;border-top:1px solid #ccc;font-weight:bold;">${net.toFixed(2)}</td></tr>
    <tr><td></td><td style="padding:2px 8px;text-align:right;">Paid (Tk.):</td><td style="padding:2px 8px;text-align:right;color:green;">${paid.toFixed(2)}</td></tr>
    <tr style="background:#f8f8f8;"><td></td><td style="padding:4px 8px;text-align:right;font-weight:bold;font-size:11pt;border-top:2px solid #000;border-bottom:2px solid #000;">Due (Tk.):</td><td style="padding:4px 8px;text-align:right;font-weight:bold;font-size:11pt;border-top:2px solid #000;border-bottom:2px solid #000;color:${due>0?'red':'green'};">${due.toFixed(2)}</td></tr>
  </table>
  ${due>0?`<div style="margin:10px 0;"><span style="font-size:20pt;font-weight:bold;border:3px solid red;color:red;padding:4px 20px;display:inline-block;letter-spacing:3px;">DUE</span></div>`:`<div style="margin:10px 0;color:green;font-weight:bold;font-size:11pt;">‚úì PAID IN FULL</div>`}
  <div style="margin-top:20px;border-top:1px dashed #000;padding-top:8px;display:flex;justify-content:space-between;font-size:8.5pt;color:#555;">
    <div>Prepared By: ${escHtml(S.name||'‚Äî')}<br>Software: Asad Kit BD v17</div>
    <div style="text-align:right;">${ts}</div>
  </div>
</div>`;
  const el=document.getElementById('m-print-body');
  if(el) el.innerHTML=html;
  openModal('m-print');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SEED NEW COLLECTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function seedNewCollections(){
  DB.seed('opd_invoices',[]);
  DB.seed('discharge_advice',[
    {id:'da1',cid:'CLINIC_001',name:'General Post-Care',text:'1. Take complete rest for 2-3 days.\n2. Follow prescribed medication strictly.\n3. Avoid heavy meals; prefer light, easily digestible food.\n4. Stay well hydrated (8-10 glasses of water daily).\n5. Attend follow-up appointment as scheduled.\n6. Contact clinic immediately if symptoms worsen.'},
    {id:'da2',cid:'CLINIC_001',name:'Post-Surgery Care',text:'1. Keep the wound area clean and dry.\n2. Change dressing as instructed by doctor.\n3. Do not lift heavy objects for 2 weeks.\n4. Take antibiotics as prescribed ‚Äî complete the course.\n5. No strenuous activity for at least 1 month.\n6. Return for stitch removal on scheduled date.'},
    {id:'da3',cid:'CLINIC_001',name:'Diabetic Patient Advice',text:'1. Monitor blood sugar regularly (fasting & post-meal).\n2. Follow diabetic diet strictly ‚Äî avoid sweets & refined carbs.\n3. Take medications on time, do not skip doses.\n4. Exercise regularly (30 min walk daily).\n5. Check feet daily for wounds or sores.\n6. Follow up with specialist every 3 months.'},
  ]);
  DB.seed('opd_docs',[
    {id:'od1',cid:'CLINIC_001',name:'Aminul Islam',code:'AMUL',title:'Dr.',dept:'Medicine',contact:'01711-999001',email:'',addr:'',description:'',createdAt:'2026-01-01T00:00:00Z'},
    {id:'od2',cid:'CLINIC_001',name:'Nasrin Akter',code:'NAS',title:'Dr.',dept:'Gynecology',contact:'01811-999002',email:'',addr:'',description:'',createdAt:'2026-01-01T00:00:00Z'},
  ]);
  DB.seed('opd_refs',[
    {id:'or1',cid:'CLINIC_001',name:'Helpstar Pharmacy',code:'HELP',barcode:'HELP001',title:'',contact:'01700-000011',email:'',commission:5,addr:'',description:'',createdAt:'2026-01-01T00:00:00Z'},
  ]);
  DB.seed('opd_services',[
    {id:'os1',cid:'CLINIC_001',name:'Consultation Fee',cat:'OPD',price:500,status:'active',createdAt:'2026-01-01T00:00:00Z'},
    {id:'os2',cid:'CLINIC_001',name:'ECG',cat:'Cardiology',price:800,status:'active',createdAt:'2026-01-01T00:00:00Z'},
    {id:'os3',cid:'CLINIC_001',name:'Blood Pressure Check',cat:'General',price:100,status:'active',createdAt:'2026-01-01T00:00:00Z'},
    {id:'os4',cid:'CLINIC_001',name:'Dressing',cat:'Surgery',price:300,status:'active',createdAt:'2026-01-01T00:00:00Z'},
    {id:'os5',cid:'CLINIC_001',name:'Nebulization',cat:'Respiratory',price:400,status:'active',createdAt:'2026-01-01T00:00:00Z'},
  ]);
  DB.seed('ipd_admissions',[]);
  DB.seed('ipd_deposits',[]);
  DB.seed('ipd_bills',[]);
  // ‚îÄ‚îÄ‚îÄ Pathology-isolated tables ‚îÄ‚îÄ‚îÄ
  DB.seed('pathology_invoices',[]);       // PATH-YYYY-XXX series only
  DB.seed('pathology_invoice_items',[]);  // line items per pathology invoice
  DB.seed('patient_test_records',[]);     // one record per test per invoice
  DB.seed('daily_collection',[]);         // all collections (type=PATH|OPD|LAB|IPD)
  DB.seed('machines',[
    {id:'mc1',cid:'CLINIC_001',name:'Sysmex XN-1000',model:'XN-1000',manufacturer:'Sysmex',createdAt:'2026-01-01T00:00:00Z'},
    {id:'mc2',cid:'CLINIC_001',name:'Mindray BS-240',model:'BS-240',manufacturer:'Mindray',createdAt:'2026-01-01T00:00:00Z'},
  ]);
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function escHtml(str){
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
// GLOBAL: Format doctor display as "Dr. Name, Degree, Dept"
function formatDocDisplay(doc){
  if(!doc) return '‚Äî';
  const name=doc.name||doc.doctor||'';
  const degree=doc.degree||doc.designation||doc.title||'';
  if(!name) return '‚Äî';
  if(!degree) return escHtml(name);
  return escHtml(name)+', '+escHtml(degree);
}
</script>
</body>
</html>
